---
title: "Subcluster Fibroblast"
subtitle: "06_SC_Fibroblast"
author: "SarahL."
date: "`r format(Sys.time(), '%b %e %Y %H:%M:%S')`"
output: 
  html_document:
    toc: true
    number_sections: true   
    toc_float: true
    code_folding: hide
    df_print: paged
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
knitr::opts_chunk$set(cache = FALSE, cache.lazy = FALSE)
knitr::opts_chunk$set(dpi = 300, fig.align = "center")
knitr::opts_chunk$set(out.width = "100%", out.height = "100%")
```


# Subcluster Fibroblast

## Setup

### Standard packages

```{r LoadPackages, warning=FALSE}
library(here)
source(here("code", "standard_libraries.R"))
```

### Additional Packages


```{r LoadPackages, warning=FALSE,eval=FALSE}
#Load Packages

suppressPackageStartupMessages({
library(batchelor)
library(bluster)
library(presto)
library(dittoSeq)
library(gridExtra)
})

```

### Set Parameter

```{r Setup}
set.seed(100)
bpp <- BiocParallel::MulticoreParam(parallel::detectCores()-1, RNGseed=100)
path <- here::here()
```


### Load Data

```{r LoadDataset}
## RA DATASET
sce <- readRDS(file = paste0(path,'/output/06_sce_SC_Fibroblast.rds'))

```

### Explore Dataset

```{r ShowDim}
#Dimensions of count matrix
dim(sce)
```

https://mperalc.gitlab.io/scRNA-seq_workshop_2021/additional-resources.html## UMAPs coloured by cluster or cell type

### Plot Annotation {.tabset}

#### Plot UMAP of Subclusters 

```{r UMAPCluster}
#cluster
plotReducedDim(sce, paste0("MNN_UMAP_SC_reduced"),colour_by = "subcluster", text_by="subcluster") +labs(title=paste0("SubCluster"),subtitle="Colored by clustering")
```

#### Plot Recalculated UMAP of Subclusters 

```{r UMAPCluster}
#cluster
plotReducedDim(sce, paste0("SC_UMAP_", cell_type),colour_by = "subcluster", text_by="subcluster") +labs(title=paste0("SubCluster ", name),subtitle="Colored by clustering")
```


## DA

### Frequencies of celltypes in clusters per Sample {.tabset}

```{r ClusterInfo}
ClusterInfo <- as.data.frame(colData(sce.sc[,sce.sc$celltype == "Fibroblast"])) %>% 
  group_by(ManualAnno_L2, Sample) %>%
  summarise(cells = n(),.groups = 'drop') 
```

#### Absolute comparison

```{r PlotAbsoluteClustering}

ggplot(data=ClusterInfo, aes(x=Sample,y=cells, fill=ManualAnno_L2)) +
  geom_bar(stat="identity", position="stack") +
  labs(title="Absolute comparison nr Cells in Celltype",subtitle="Per Sample",x="",y="Number of cells")+
  theme(axis.text.x = element_text(angle = 45,hjust=1), axis.ticks.x=element_blank())

```

#### Relative comparison

```{r PlotRelativeClustering}

ggplot(data=ClusterInfo,aes(x=Sample, y=cells, fill=ManualAnno_L2)) +
  geom_bar(stat="identity", position="fill") +
  labs(title="Relative comparison nr Cells in celltype",subtitle="Per Sample",x="",y="Number of cells")+
  theme(axis.text.x = element_text(angle = 45,hjust=1), axis.ticks.x=element_blank())


```


### Frequencies of celltypes in clusters per Joint Location {.tabset}

```{r ClusterInfo}
ClusterInfo <- as.data.frame(colData(sce.sc[,sce.sc$celltype == "Fibroblast"])) %>% 
  group_by(ManualAnno_L2, Joint.Location) %>%
  summarise(cells = n(),.groups = 'drop') 
```

#### Absolute comparison

```{r PlotAbsoluteClustering}

ggplot(data=ClusterInfo, aes(x=Joint.Location,y=cells, fill=ManualAnno_L2)) +
  geom_bar(stat="identity", position="stack") +
  labs(title="Absolute comparison nr Cells in Celltype",subtitle="Per Joint Location",x="",y="Number of cells")+
  theme(axis.text.x = element_text(angle = 45,hjust=1), axis.ticks.x=element_blank())

```

#### Relative comparison

```{r PlotRelativeClustering}

ggplot(data=ClusterInfo,aes(x=Joint.Location, y=cells, fill=ManualAnno_L2)) +
  geom_bar(stat="identity", position="fill") +
  labs(title="Relative comparison nr Cells in celltype",subtitle="Per Joint Location",x="",y="Number of cells")+
  theme(axis.text.x = element_text(angle = 45,hjust=1), axis.ticks.x=element_blank())


```

```{r TestProportionsWilcoxon}

ClusterInfo
wilcox.test()




```




```{r }


Marker <- c("HOXD11","HOXD10","HOXB-AS1","HOXA6","HOXA5","HOXA3","HOXA11-AS","HOXC9","HOXC8","HOXC11","HOXC10","HOXC-AS1","HOXC-AS2","HOXC-AS3","HOXB3","HOXB2")


dittoDotPlot(sce[,sce$celltype == "Fibroblast"], vars = Marker , group.by = "Joint.Location",min.color="lightgrey", max.color="blue",min.percent=0,max.percent=1,scale = FALSE )

dittoDotPlot(sce[,sce$celltype == "Fibroblast"], vars = Marker , group.by = "Joint.Location",min.color="lightgrey", max.color="blue",min.percent=0,max.percent=1,scale = TRUE )



dittoDotPlot(sce[,sce$celltype == "Edothelial cell"], vars = Marker , group.by = "Joint.Location",min.color="lightgrey", max.color="blue",min.percent=0,max.percent=1,scale = FALSE )

dittoDotPlot(sce[,sce$celltype == "Edothelial cell"], vars = Marker , group.by = "Joint.Location",min.color="lightgrey", max.color="blue",min.percent=0,max.percent=1,scale = TRUE )



```

## DE

```{r }
-filter genes sc.pp.filter_genes(adata_mono, min_cells=3)
-Function find_de_MAST_RE takes a SingleCellExperiment object as input and runs MAST with RE pipeline. The output of the function is a table (pandas DataFrame in Python) which contains results of the analysis, e.g. log-fold change, p-value and FDR-corrected value for each gene.

find_de_MAST_RE <- function(sce){
    
  # create a MAST object
    print("Dimensions before subsetting:")
    print(dim(sca))
    print("")
    # keep genes that are expressed in more than 10% of all cells
    sca <- sca[freq(sca)>0.1,]
    print("Dimensions after subsetting:")
    print(dim(sca))
    print("")
    # add a column to the data which contains scaled number of genes that are expressed in each cell
    cdr2 <- colSums(assay(sca)>0)
    colData(sca)$ngeneson <- scale(cdr2)
    # store the columns that we are interested in as factors
    label <- factor(colData(sca)$label)
    # set the reference level
    label <- relevel(label,"ctrl")
    colData(sca)$label <- label
    celltype <- factor(colData(sca)$cell_type)
    colData(sca)$celltype <- celltype
    # same for donors (which we need to model random effects)
    replicate <- factor(colData(sca)$replicate)
    colData(sca)$replicate <- replicate
    # create a group per condition-celltype combination
    colData(sca)$group <- paste0(colData(adata_)$label, ".", colData(adata_)$cell_type)
    colData(sca)$group <- factor(colData(sca)$group)
    # define and fit the model
    zlmCond <- zlm(formula = ~ngeneson + group, 
                   sca=sca, 
                   method='glmer', 
                   ebayes=F, 
                   strictConvergence=F,
                   fitArgsD=list(nAGQ = 0)) # to speed up calculations
    
    # perform likelihood-ratio test for the condition that we are interested in    
    summaryCond <- summary(zlmCond, doLRT='groupstim.CD14_Monocytes')
    # get the table with log-fold changes and p-values
    summaryDt <- summaryCond$datatable
    result <- merge(summaryDt[contrast=='groupstim.CD14_Monocytes' & component=='H',.(primerid, `Pr(>Chisq)`)], # p-values
                     summaryDt[contrast=='groupstim.CD14_Monocytes' & component=='logFC', .(primerid, coef)],
                     by='primerid') # logFC coefficients
    # MAST uses natural logarithm so we convert the coefficients to log2 base to be comparable to edgeR
    result[,coef:=result[,coef]/log(2)]
    # do multiple testing correction
    result[,FDR:=p.adjust(`Pr(>Chisq)`, 'fdr')]
    result = result[result$FDR<0.01,, drop=F]

    result <- stats::na.omit(as.data.frame(result))
    return(result)
}


-find_de_MAST_RE(adata_mono)
-find de edger()


-plot heatmap
-plot volcano
```



## Trajectory analysis

### Plot UMAP of Subclusters 

```{r UMAPCluster}
#cluster
plotReducedDim(sce, paste0("MNN_UMAP_SC_reduced"),colour_by = "subcluster", text_by="subcluster") +labs(title=paste0("SubCluster"),subtitle="Colored by clustering")
plotReducedDim(sce, paste0("MNN_SC_reduced"),colour_by = "subcluster", text_by="subcluster") +labs(title=paste0("SubCluster"),subtitle="Colored by clustering")
```


```{r }
library(slingshot)
library(ggbeeswarm)
#sce<-sce[,sce$subcluster != 6]

sce$pseudotime_PC1 <- rank(reducedDims(sce)$MNN_SC_reduced[, 1])  # rank cells by their PC1 score
ggplot(as.data.frame(colData(sce)), aes(x = pseudotime_PC1, y = subcluster, 
                                             colour = subcluster)) +
    geom_quasirandom(groupOnX = FALSE) +
     theme_classic() +
    xlab("PC1") + ylab("Timepoint") +
    ggtitle("Cells ordered by first principal component")


```


```{r }
sce <- slingshot(sce, clusterLabels = 'subcluster', reducedDim = 'MNN_SC_reduced',allow.breaks = FALSE, start.clus = 1, end.clus = 5)
summary(sce$slingPseudotime_1)

lnes <- getLineages(reducedDim(sce,"MNN_SC_reduced"),sce$subcluster)
lnes@lineages

colors <- rainbow(50, alpha = 1)
plot(reducedDims(sce)$MNN_SC_reduced, col = colors[cut(sce$slingPseudotime_1,breaks=50)], pch=16, asp = 1)
lines(SlingshotDataSet(sce), lwd=2)

```


```{r }
sce <- slingshot(sce,clusterLabels=sce$subcluster, start.clus = 1, end.clus = 5,reducedDim = 'MNN_SC_reduced', approx_points = 150)

colors <- rainbow(50, alpha = 1)
plot(reducedDims(sce)$MNN_SC_reduced, col = colors[cut(sce$slingPseudotime_1,breaks=50)], pch=16, asp = 1)
lines(SlingshotDataSet(sce), lwd=2)

```



```{r plotSlingshot, fig.width =  8}

slingshot_df <- data.frame(colData(sce))

ggplot(slingshot_df, aes(x = slingPseudotime_1, y = subcluster, 
                              colour = subcluster)) +
    geom_quasirandom(groupOnX = FALSE) +
    theme_classic() +
    xlab("Slingshot pseudotime") + ylab("Timepoint") +
    ggtitle("Cells ordered by Slingshot pseudotime")


```

```{r plotSlingshot, fig.width =  8}

slingshot_df <- data.frame(colData(sce))

ggplot(slingshot_df, aes(x = slingPseudotime_1, y = slingPseudotime_2, 
                              colour = subcluster)) +
    geom_quasirandom(groupOnX = FALSE) + theme_classic() +
    xlab("First Slingshot pseudotime") + ylab("Second Slingshot pseudotime") +
    ggtitle("Cells ordered by Slingshot pseudotime")+scale_colour_manual(values = my_color)

```


```{r plotSlingshot, echo = FALSE, fig.width =  8}

sce <- slingshot(sce, reducedDim = 'MNN_SC_reduced')


layout(matrix(c(1, 1, 2, 3), 2))
par(mar = c(4.5, 4, 1, 1))
plot(reducedDims(sce)$MNN_SC_reduced[shuffle, ], asp = 1, pch = 16, xlab = "UMAP-1", ylab = "UMAP-2",
  col = hcl.colors(100, alpha = .5)[cut(sce$slingPseudotime_1, breaks = 100)][shuffle])
lines(SlingshotDataSet(sce))


library(RColorBrewer)
# Pseudotime densities (by Joint)
ds <- list( MCP = density(slingPseudotime(sce)[colData(sce)$Joint.Location == "MCP", 1]),
            Wrist = density(slingPseudotime(sce)[colData(sce)$Joint.Location == "Wrist", 1]),
            Knee = density(slingPseudotime(sce)[colData(sce)$Joint.Location == "Knee", 1])
            )
xlim <- range(c(ds$MCP$x, ds$Wrist$x, ds$Knee$x))
ylim <- range(c(ds$MCP$y, ds$Wrist$y, ds$Knee$y))
plot(xlim, ylim, col = "white", xlab = "Pseudotime", ylab = "")
polygon(c(min(ds$MCP$x), ds$MCP$x, max(ds$MCP$x)), c(0, ds$MCP$y, 0),
  col = alpha(brewer.pal(4, "Set1")[3], alpha = .5))
polygon(c(min(ds$Wrist$x), ds$MCP$x, max(ds$MCP$x)), c(0, ds$Wrist$y, 0),
        col = alpha(brewer.pal(4, "Set1")[2], alpha = .5))
polygon(c(min(ds$Knee$x), ds$MCP$x, max(ds$MCP$x)), c(0, ds$Knee$y, 0),
  col = alpha(brewer.pal(4, "Set1")[1], alpha = .5))

legend("topleft", legend = c("MCP", "Wrist", "Knee"), 
       fill = alpha(brewer.pal(4, "Set1")[3:1], alpha = .5), bty = "n")

plot(reducedDims(sce)$MNN_SC_reduced[shuffle, ], asp = 1, pch = 16, xlab = "UMAP-1", ylab = "UMAP-2", 
     col = alpha(c(2, 3, 4)[factor(colData(sce)$Joint.Location)][shuffle], alpha = .5))
lines(SlingshotDataSet(sce), type = 'lineages', show.constraints = TRUE)
legend("topright", pch = 16, col = 2:4, bty = "n", legend = levels(factor(colData(sce)$Joint.Location)))

layout(1)
par(mar = c(5, 4, 4, 2) + .1)



```
```{r plotSlingshot, echo = FALSE, fig.width =  8}
ks.test(slingPseudotime(sce)[colData(sce)$Joint.Location == "Knee", 1],
        slingPseudotime(sce)[colData(sce)$Joint.Location == "MCP", 1])

ks.test(slingPseudotime(sce)[colData(sce)$Joint.Location == "Knee", 1],
        slingPseudotime(sce)[colData(sce)$Joint.Location == "Wrist", 1])

ks.test(slingPseudotime(sce)[colData(sce)$Joint.Location == "MCP", 1],
        slingPseudotime(sce)[colData(sce)$Joint.Location == "Wrist", 1])
```




---

```{r }

library(slingshot)



sce <- slingshot(sce, reducedDim = 'MNN_SC_reduced', clusterLabels = colData(sce)$Joint.Location,
                 start.clus = 'inner', approx_points = 150)


layout(matrix(c(1, 1, 2, 3), 2))
par(mar = c(4.5, 4, 1, 1))
plot(reducedDims(sce)$MNN_SC_reduced[shuffle, ], asp = 1, pch = 16, xlab = "PCA-1", ylab = "PCA-2",
  col = hcl.colors(100, alpha = .5)[cut(sce$slingPseudotime_1, breaks = 100)][shuffle])
lines(SlingshotDataSet(sce))

plotExpression(sce, features="HOXD10", x = "slingPseudotime_1", show_violin = FALSE, show_smooth = TRUE, colour_by = "subcluster" )
```


```{r }
sce$PC1 <- MNN_SC_reduced[, 1]
sce$PC2 <- MNN_SC_reduced[, 2]


ggplot(colData(sce), aes(x = sce$slingPseudotime_1, y = subcluster, 
                              colour = subcluster)) +
    geom_quasirandom(groupOnX = FALSE) +
    scale_color_tableau() + theme_classic() +
    xlab("Slingshot pseudotime") + ylab("Timepoint") +
    ggtitle("Cells ordered by Slingshot pseudotime")

```


```{r }
shuffle <- sample(ncol(sce))
layout(matrix(1:2, nrow = 1))
par(mar = c(4.5,4,1,1))

plot(reducedDims(sce)$MNN_UMAP_SC_reduced[shuffle, ],
  asp = 1, pch = 16, xlab = "UMAP-1", ylab = "UMAP-2",
  col = alpha(c(1:3)[factor(colData(sce)$Joint.Location)][shuffle], alpha = .5))
legend("bottomleft", pch = 16, col = 1:2, bty = "n", 
       legend = levels(factor(colData(sce)$Joint.Location)))


library(slingshot)



sce <- slingshot(sce, reducedDim = 'MNN_SC_reduced', clusterLabels = colData(sce)$subcluster,
                 start.clus = '1', end.clus = '5', approx_points = 150)
```

```{r plotSlingshot, echo = FALSE, fig.width =  8}

layout(matrix(c(1, 1, 2, 3), 2))
par(mar = c(4.5, 4, 1, 1))
plot(reducedDims(sce)$MNN_UMAP_SC_reduced[shuffle, ], asp = 1, pch = 16, xlab = "UMAP-1", ylab = "UMAP-2",
  col = hcl.colors(100, alpha = .5)[cut(sce$slingPseudotime_1, breaks = 100)][shuffle])
lines(SlingshotDataSet(sce))


library(RColorBrewer)
# Pseudotime densities (by Joint)
ds <- list( MCP = density(slingPseudotime(sce)[colData(sce)$Joint.Location == "MCP", 1]),
            Wrist = density(slingPseudotime(sce)[colData(sce)$Joint.Location == "Wrist", 1]),
            Knee = density(slingPseudotime(sce)[colData(sce)$Joint.Location == "Knee", 1])
            )
xlim <- range(c(ds$MCP$x, ds$Wrist$x, ds$Knee$x))
ylim <- range(c(ds$MCP$y, ds$Wrist$y, ds$Knee$y))
plot(xlim, ylim, col = "white", xlab = "Pseudotime", ylab = "")
polygon(c(min(ds$MCP$x), ds$MCP$x, max(ds$MCP$x)), c(0, ds$MCP$y, 0),
  col = alpha(brewer.pal(4, "Set1")[3], alpha = .5))
polygon(c(min(ds$Wrist$x), ds$MCP$x, max(ds$MCP$x)), c(0, ds$Wrist$y, 0),
        col = alpha(brewer.pal(4, "Set1")[2], alpha = .5))
polygon(c(min(ds$Knee$x), ds$MCP$x, max(ds$MCP$x)), c(0, ds$Knee$y, 0),
  col = alpha(brewer.pal(4, "Set1")[1], alpha = .5))

legend("topleft", legend = c("MCP", "Wrist", "Knee"), 
       fill = alpha(brewer.pal(4, "Set1")[3:1], alpha = .5), bty = "n")

plot(reducedDims(sce)$MNN_UMAP_SC_reduced[shuffle, ], asp = 1, pch = 16, xlab = "UMAP-1", ylab = "UMAP-2", 
     col = alpha(c(2, 3, 4)[factor(colData(sce)$Joint.Location)][shuffle], alpha = .5))
lines(SlingshotDataSet(sce), type = 'lineages', show.constraints = TRUE)
legend("topright", pch = 16, col = 2:4, bty = "n", legend = levels(factor(colData(sce)$Joint.Location)))

layout(1)
par(mar = c(5, 4, 4, 2) + .1)



```
```{r plotSlingshot, echo = FALSE, fig.width =  8}
ks.test(slingPseudotime(sce)[colData(sce)$Joint.Location == "Knee", 1],
        slingPseudotime(sce)[colData(sce)$Joint.Location == "MCP", 1])

ks.test(slingPseudotime(sce)[colData(sce)$Joint.Location == "Knee", 1],
        slingPseudotime(sce)[colData(sce)$Joint.Location == "Wrist", 1])

ks.test(slingPseudotime(sce)[colData(sce)$Joint.Location == "MCP", 1],
        slingPseudotime(sce)[colData(sce)$Joint.Location == "Wrist", 1])
```

```{r plotSlingshot, echo = FALSE, fig.width =  8}
icMat <- evaluateK(counts = as.matrix(assays(sce)$counts),
                   pseudotime = colData(sce)$slingshot$pseudotime,
                   cellWeights = colData(sce)$slingshot$cellWeights.V1,
                   conditions = factor(colData(sce)$Joint.Location),
                   nGenes = 300,
                   k = 3:7)
```



--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


## Save the dataset

```{r SaveData}
saveRDS(sce, file =paste0(path,'/output/06_sce_SC_Fibroblast.rds'))
```
