---
title: "Differential Expression Analysis Pseudobulk"
subtitle: "07_DifferentialExpression_Pseudobulk"
author: "SarahL."
date: "`r format(Sys.time(), '%b %e %Y %H:%M:%S')`"
output: 
  html_document:
    toc: true
    number_sections: true   
    toc_float: true
    code_folding: hide
    df_print: paged
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
knitr::opts_chunk$set(cache = FALSE, cache.lazy = FALSE)
knitr::opts_chunk$set(dpi = 300, fig.align = "center")
knitr::opts_chunk$set(out.width = "100%", out.height = "100%")
```


# Differential Expression Analysis

## Setup

### Standard packages

```{r LoadPackages, warning=FALSE}
library(here)
source(here("code", "standard_libraries.R"))
```

### Additional Packages

```{r LoadPackages, warning=FALSE}
#Load Packages

suppressPackageStartupMessages({
library(muscat)
library(limma)
library(UpSetR)
})

```

### Set Parameter

```{r Setup}
set.seed(100)
bpp <- BiocParallel::MulticoreParam(parallel::detectCores()-1, RNGseed=100)
path <- here::here()
```


### Load Data

```{r LoadDataset}
## RA DATASET
sce <- readRDS(file = paste0(path,'/output/05_sce_CelltypeAnnotation.rds'))

#Select only Fibroblast and Myeloid
selected_celltype <- c("Fibroblast")
sce <- sce[,sce$celltype == selected_celltype]

```

### Explore Dataset

```{r ShowDim}
#Dimensions of count matrix
dim(sce)
```

https://mperalc.gitlab.io/scRNA-seq_workshop_2021/additional-resources.html## UMAPs coloured by cluster or cell type

### Plot Clustering and Annotation {.tabset}

#### Annotation

```{r UMAPAnnotation}
#cell type
plotReducedDim(sce, "MNN_UMAP", colour_by="celltype", text_by="celltype") +labs(title="UMAP colored by Cell type ",subtitle = "UMAP of all integrated datasets")

```

#### Clusters

```{r UMAPCluster}
#cluster
plotReducedDim(sce, "MNN_UMAP", colour_by="cluster", text_by="cluster") +labs(title="UMAP colored by clusters",subtitle = "UMAP of all integrated datasets")

```

## Differential Expression Pseudobulk

### Setup

#### Sample preparation

```{r DE}
# create SCE
sce$id <- paste0(sce$Joint.Location, sce$Sample)
(sce <- prepSCE(sce, 
    kid = "label", # Celllabels
    gid = "Joint.Location",  # Condition
    sid = "id",   # Samplenames
    drop = TRUE))  # drop all other colData columns
```

#### Aggregated Data Overview

```{r DE, rows.print=20}
# nr of cells per cluster-sample
as.data.frame.matrix(t(table(sce$cluster_id, sce$sample_id)))
```


#### Creating pseudo-bulk

```{r DE}
# Aggregate Cells
pb <- aggregateData(sce,
    assay = "counts", fun = "sum",
    by = c("cluster_id", "sample_id"))
# one sheet per subpopulation
assayNames(pb)
t(head(assay(pb)))
```


```{r DE}
#MDS plot
pbMDS(pb)
```

```{r DE}
# construct design & contrast matrix
ei <- metadata(sce)$experiment_info
mm <- model.matrix(~ 0 + ei$group_id)
dimnames(mm) <- list(ei$sample_id, levels(ei$group_id))
x <- c("Knee-Wrist","Knee-MCP","MCP-Wrist")
contrast <- makeContrasts(contrasts=x, levels = mm)
contrast

```

## Run DS analysis & Results for Differential Expression

### View results for first comparison (Knee-Wrist)

```{r DE}
# View results for first comparison (Knee-Wrist)
for (method in c("edgeR","DESeq2","limma-voom","edgeR_glm")){
  
  if (method=="edgeR_glm"){
    res<-pbDS(pb, design = mm, contrast = contrast, method = "edgeR" ,BPPARAM =bpp, treat = TRUE)
  }else{
    res<-pbDS(pb, design = mm, contrast = contrast, method = method ,BPPARAM =bpp)
  }
  
  
  
  glist<-c()
  
  for (cont in c("Knee-MCP","Knee-Wrist","MCP-Wrist")){
    #Select correct DEG table
    tbl <- res$table[[cont]]
    #Take the significant entries of the table
    tbl_fil <- lapply(tbl, function(u) {
      u <- dplyr::filter(u, p_adj.loc < 0.05, abs(logFC) > 0.1)
      dplyr::arrange(u, p_adj.loc)
      dplyr::select(u, gene)
    })
    glist<-c(glist, tbl_fil$Fibroblast$gene)
    
    }
  
  glist<-unique(glist)
  assign(x = paste0(method),value =glist)
    
}

```

#Upset plot

```{r DE}

listInput <- list(edgeR = edgeR, DESeq2 = DESeq2, limmavoom = `limma-voom`, edgeRglm = edgeR_glm)
upset(fromList(listInput), order.by = "freq")

```


## Save the dataset

```{r SaveData}

saveRDS(sce, file =paste0(path,''))

```
