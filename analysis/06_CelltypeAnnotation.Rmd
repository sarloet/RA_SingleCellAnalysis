---
title: "Marker Genes and Celltype Annotation"
subtitle: "06_CelltypeAnnotation"
author: "SarahL."
date: "`r format(Sys.time(), '%b %e %Y %H:%M:%S')`"
output: 
  html_document:
    toc: true
    number_sections: true   
    toc_float: true
    code_folding: hide
    df_print: paged
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
knitr::opts_chunk$set(cache = FALSE, cache.lazy = FALSE)
knitr::opts_chunk$set(dpi = 300, fig.align = "center")
knitr::opts_chunk$set(out.width = "100%", out.height = "100%")
```


# Marker Genes and Celltype Annotation

## Setup

### Standard packages

```{r LoadPackages, warning=FALSE}
library(here)
source(here("code", "standard_libraries.R"))
```

### Additional Packages

```{r LoadAddPackages, warning=FALSE}
#Load Packages

suppressPackageStartupMessages({
#library(scuttle)
library(dittoSeq)
library(pheatmap)
library(xlsx)
library(presto)
})

```

### Set Parameter

```{r Setup}
set.seed(123)
bpp <- BiocParallel::MulticoreParam(parallel::detectCores()-1, RNGseed=123)
path <- here::here()
```


## Load Data

```{r LoadDataset}
## RA DATASET
sce <- readRDS(file = paste0(path,'/output/05_sce_Clustering.rds'))

```

### Change Rownames to the Symbol

```{r ChangeRownames}
#Change to genesymbol whenever possible
rowData(sce)$UniqID <-rownames(sce)
rownames(sce) <- uniquifyFeatureNames(rowData(sce)$ENSEMBL, rowData(sce)$Symbol)
data.frame(rowData(sce))
```


### Explore Dataset

```{r ShowDim}
#Dimensions of count matrix
dim(sce)
```


## Plot Clustering and QC {.tabset}

### PCA

```{r PlotClusterPCA}
plotReducedDim(sce, dimred="MNN_reduced", colour_by="cluster",text_by="cluster",point_alpha=0.8,point_size=1) + 
  ggtitle("PCA with clusters")+
  labs( x='PCA 1', y='PCA 2' )
```

### UMAP

```{r PlotClusterUMAP}
plotReducedDim(sce, dimred="MNN_UMAP_reduced", colour_by="cluster",text_by="cluster",point_alpha=0.8,point_size=1) + 
  ggtitle("UMAP with with clusters")+
  labs( x='UMAP 1', y='UMAP 2' )
```

### QC UMAPs

```{r PlotClusterQCUMAP,fig.height=3, fig.width=12}
p1 <- plotReducedDim(sce, dimred="MNN_UMAP_reduced", colour_by="subsets_Mito_percent",order_by = "subsets_Mito_percent",point_alpha=0.8,point_size=0.5) + ggtitle("Mitochondrial Genes")+
  theme(legend.title=element_blank())+
  labs( x='UMAP 1', y='UMAP 2' )+
  scale_color_viridis(option="magma")

p2 <- plotReducedDim(sce, dimred="MNN_UMAP_reduced", colour_by="detected",order_by = "detected",point_alpha=0.8,point_size=0.5) + ggtitle("Number of detected Genes ")+
  theme(legend.title=element_blank())+
  labs( x='UMAP 1', y='UMAP 2' )+
  scale_color_viridis(option="magma")

p3 <- plotReducedDim(sce, dimred="MNN_UMAP_reduced", colour_by="sum",order_by = "sum",point_alpha=0.8,point_size=0.5) + ggtitle("Sum of UMI Counts in Cell")+
  theme(legend.title=element_blank())+
  labs( x='UMAP 1', y='UMAP 2' )+
  scale_color_viridis(option="magma")

grid.arrange(p1, p2, p3, nrow = 1, ncol = 3)
rm(p1, p2, p3)



print(Plot_QC_dimred(sce,dim="MNN_UMAP_reduced"))
```


## Identify Marker Genes


### Wilcoxon rank-sum test on Cluster

```{r IdentifyMarker}
#Wilcoxon rank-sum test
markers_wilcox <- wilcoxauc(sce, group_by='cluster', assay = 'logcounts')

```


```{r SaveTopMarker}
# Get the top 3 markers for each cluster (for heatmap)
# filter for nominally significant (p<0.05)and over-expressed (auc>0.5)
top3DEgenes <- top_markers(markers_wilcox, n = 3, padj_max = 0.05, pct_in_min = 20, auc_min = 0.5)#auc_min = 0.5

#Show top 3 DE Genes of each cluster
data.frame(top3DEgenes)
top3DEgenes<-unlist(as.data.frame(top3DEgenes[,-1]),use.names = FALSE)

# Get the top 50 markers for each cluster (save in excel file)
# filter for nominally significant (p<0.05) and over-expressed (auc>0.5)
top50DEgenes <- top_markers(markers_wilcox, n = 50, padj_max = 0.05, pct_in_min = 20, auc_min = 0.5)
data.frame(top50DEgenes)


wb = createWorkbook()
for (i in 1:max(as.integer(levels(sce$cluster)))){
  #get genes for the cluster
  markers<-top50DEgenes[,paste0(i), drop=TRUE]
  #Create table
  tmp<-markers_wilcox[markers_wilcox$feature %in% markers & markers_wilcox$group == i,]
  
  #Save table in Exelsheet
  addDataFrame(tmp, sheet=createSheet(wb, paste0("Cluster ", i)), startColumn=1, row.names=FALSE,col.names = TRUE)
}
#saveWorkbook(wb,paste0( path , "/output/Cluster_Marker_Genes.xlsx"))



```

### Wilcoxon heatmap

```{r PlotHeatmap}
#Heatmap of top marker genes of each cluster by Wilcoxon rank-sum 

# To avoid a too big plot we only keep every 20th cell
sce.plot <- sce[unique(top3DEgenes), seq(1, dim(sce)[2], 20)]
dittoHeatmap(sce.plot, vars = unique(top3DEgenes), annot.by = c("cluster"),order.by="cluster", scaled.to.max = TRUE,cluster_rows=FALSE,cluster_cols=FALSE,heatmap.colors = colorRampPalette(c("darkblue", "white", "darkred"))(100),breaks = seq(-3, 3, length.out = 101 )) #assay = "scaled_asinh"


#Dotplot
dittoDotPlot(sce, vars = unique(top3DEgenes) , group.by = "label",min.color="lightgrey", max.color="blue",min.percent=0.2,max.percent=1,scale = TRUE )

rm(sce.marker,sce.plot,column_annotations,markers_wilcox_up)
gc()
```



## Manual Celltype annotation

```{r VizGenExFunction}
#Function to visuaise gene Expression for vector of genes

VizGenEx <- function(markr){
 
  for(i in markr){
  
    cat(paste0("\n##### ", i, "\n"))
  
    gridExtra::grid.arrange(
      arrangeGrob(plotReducedDim(sce, dimred = "MNN_UMAP_reduced", colour_by = i, text_by = "cluster"), 
                  plotReducedDim(sce, dimred = "MNN_UMAP_reduced", colour_by = i, order_by=i ,point_alpha=1,point_size=0.5) 
                    +scale_colour_gradient(name = i,low = "lightgrey", high = "red"), ncol = 2), 
                  plotExpression(sce, features = i, x = "cluster"),nrow = 2)
    cat(' \n')
  
  }
     
}

```


### Major cell type Annotation - Level0 {.tabset}

Identify major cell types for a Rough Annotation on high hierarchical level

#### Lymphocyte {.tabset}

```{r LymphocyteL0, results='asis'}
  
VizGenEx(c("PTPRC","CORO1A","RAC2"))  
```

#### Myeloid {.tabset}

```{r MyeloidL0, results='asis'}

VizGenEx(c("CSF3R","MS4A6A","MS4A7"))  

```

#### Fibroblast {.tabset}

```{r FibroblastL0, results='asis'}

VizGenEx(c("PDGFRB","DCN","PCOLCE","ACTA2")) 

```

#### Endothelial {.tabset}

```{r EndothelialL0, results='asis'}

VizGenEx(c("CDH5","ECSCR","CCL14")) 

```

### Assignement - Level0 

```{r AssignementL0}
#Manual Annotation
sce$ManualAnno_L0 <- as.integer(sce$cluster)
unique(sce$ManualAnno_L0)

sce$ManualAnno_L0[sce$cluster %in% c(5,11,12,16,18,19)] <- "Lymphocyte"
sce$ManualAnno_L0[sce$cluster %in% c(4,7,8,9,14,17,21)] <- "Myeloid"
sce$ManualAnno_L0[sce$cluster %in% c(2,3,6,10,13)] <- "Stromal"
sce$ManualAnno_L0[sce$cluster %in% c(1,15,20)] <- "Endothelial"

```

### Finer cell type Annotation - Level1 {.tabset}

Identify cell types for a finer grained Annotation on lower hierarchical level

#### Myeloid / Macrophage {.tabset}

```{r MacrophageL1, results='asis'}

VizGenEx(c("MARCO","LYZ","MSR1","CD14","FCGR3A")) 

```


#### Fibroblast {.tabset}

```{r FibroblastL1, results='asis'}

VizGenEx(c("PDGFRB","DCN","COL1A1")) 

```

#### Lining Fibroblast {.tabset}

```{r LiningFibroblastL1, results='asis'}

VizGenEx(c("PRG4","CRTAC1", "CLU")) 

```

#### Endothelial {.tabset}

```{r EndothelialL1, results='asis'}

VizGenEx(c("CDH5","VWF", "PECAM1","CCL14"))

```

#### Lymphatic Endothelial {.tabset}

```{r LymphaticEndothelialL1, results='asis'}

VizGenEx(c("PROX1","LYVE1", "CCL21"))

```

#### BCell {.tabset}

```{r BCellL1, results='asis'}

VizGenEx(c("CD19","MS4A1","CD79A","TNFRSF13C"))

```

#### Plasma {.tabset}

```{r PlasmaL1, results='asis'}

VizGenEx(c("JSRP1","DERL3", "JCHAIN","SDC1","MZB1"))

```

#### Tcell {.tabset}

```{r TcellL1, results='asis'} 
 
VizGenEx(c("CD3E","CD3D", "CD3G","TRAC"))

```

#### Smooth muscle cell {.tabset}

```{r SMCL1, results='asis'}

VizGenEx(c("ACTA2","MYL9", "DES", "MYH11"))

```

#### Mastcell {.tabset}

```{r MastcellL1, results='asis'}

VizGenEx(c("TPSAB1","CPA3","HPGDS"))

```

#### Neutrophil {.tabset}

```{r NeutrophilL1, results='asis'}

VizGenEx(c("CSF3R","S100A8","TREM1","NAMPT"))
  
```

#### Plasmacytoid dendritic cell {.tabset}

```{r pDCL1, results='asis'}

#VizGenEx(c("PTPRC","CLEC4C","LILRA4","LRRC26")) #pDC
VizGenEx(c("FLT3","BTLA","CD86","CLEC9A","CCL22","CD1C")) #cDC

```


#### Proliferating Cells{.tabset}

```{r pDCL1, results='asis'}

VizGenEx(c("MKI67","PCNA","STMN1","HMGB2")) 

```


### Assignement - Level1 

```{r AssignementL1}
#Manual Annotation

sce$ManualAnno_L1 <- as.integer(sce$cluster)
unique(sce$ManualAnno_L1)

sce$ManualAnno_L1[sce$cluster %in% c(2,3,6,13)] <- "Fibroblast"
sce$ManualAnno_L1[sce$cluster %in% c(10)] <- "Smooth muscle cell"
sce$ManualAnno_L1[sce$cluster %in% c(1,15,20)] <- "Endothelial cell"
sce$ManualAnno_L1[sce$cluster %in% c(11,12,18)] <- "T cell"
sce$ManualAnno_L1[sce$cluster %in% c(19)] <- "B cell"
sce$ManualAnno_L1[sce$cluster %in% c(21)] <- "Neutrophil"
sce$ManualAnno_L1[sce$cluster %in% c(16)] <- "Mast cell"
sce$ManualAnno_L1[sce$cluster %in% c(4,8,9,14,17)] <- "Myeloid"
sce$ManualAnno_L1[sce$cluster %in% c(5)] <- "Plasma"
sce$ManualAnno_L1[sce$cluster %in% c(7)] <- "Dendritic cell"
```

```{r AssignementCheck}
#Check if all clusters assigned
unique(sce$ManualAnno_L0)
unique(sce$ManualAnno_L1)
```

#### Plot Assigned Celltypes {.tabset}

##### UMAP L1

```{r PlotL1}
#Plot manual Annotation
plotReducedDim(sce, dimred="MNN_UMAP_reduced", by_exprs_values = "logcounts", colour_by="ManualAnno_L1")+ ggtitle("UMAP Celllabel")
plotReducedDim(sce, dimred="MNN_UMAP_reduced", by_exprs_values = "logcounts", colour_by="ManualAnno_L1", text_by="ManualAnno_L1")+ ggtitle("UMAP Celllabel")
```

##### UMAP L0

```{r PlotL0}
#Plot manual Annotation
plotReducedDim(sce, dimred="MNN_UMAP_reduced", by_exprs_values = "logcounts", colour_by="ManualAnno_L0")+ ggtitle("UMAP Celllabel")
plotReducedDim(sce, dimred="MNN_UMAP_reduced", by_exprs_values = "logcounts", colour_by="ManualAnno_L0", text_by="ManualAnno_L0")+ ggtitle("UMAP Celllabel")
```


## Set the Final Celllabels

```{r}
## Set Celltypes to use downstream as colLabels
colLabels(sce) <- colData(sce)$ManualAnno_L1
sce$celltype <- colData(sce)$ManualAnno_L1

```

## Plot the assigned Cell labels

```{r}
plotReducedDim(sce, dimred="MNN_UMAP_reduced", by_exprs_values = "logcounts", colour_by= "celltype")+ ggtitle("UMAP Celllabel")

```


## Plot Selected Markergenes 

```{r PlotHeatmap}
#Heatmap of Marker Gened used for Annotation
#Endo "VWF", "CDH5"
#Myeloid "CD14","FCGR3A"
#Bcell "CD19","MS4A1","CD79A"
#Plasma "SDC1","MZB1"
#Tcell "CD3E", "CD3G"
#Mast "KIT","IL1RL1","MS4A2" "TPSAB1","CPA3"
#Fibroblast "PDGFRB","DCN","COL1A1"
#Neutrophil "CSF3R","S100A8","TREM1"
#pDC
#SMC

markers <- c("PDGFRB","COL1A1","ACTA2","VWF", "CDH5","CD14","FCGR3A","CSF3R","S100A8","CLEC9A","CCL22","TPSAB1","CPA3","KIT","MS4A2","CD19","MS4A1","CD79A","SDC1","MZB1","CD3E", "CD3G")



# To avoid a too big plot we only keep every 20th cell
sce.plot <- sce[unique(markers), seq(1, dim(sce)[2], 20)]
dittoHeatmap(sce.plot, vars = unique(markers), annot.by = c("label"),scaled.to.max = TRUE,cluster_rows=FALSE,cluster_cols=TRUE )


#Dotplot
dittoDotPlot(sce, vars = markers , group.by = "label",min.color="lightgrey", max.color="blue",min.percent=0.2,max.percent=1,scale = TRUE,
             y.reorder=c(4,9,3,6,7,2,5,1,8,10))

#order-->c("Fibroblast","Smooth muscle cell","Endothelial cell","Myeloid","Neutrophil","Dendritic cell","Mast cell","B cell","Plasma","T cell")

rm(sce.marker,sce.plot,column_annotations,markers_wilcox_up)
gc()
```


## Frequencies of celltypes in clusters per Sample {.tabset}

```{r ClusterInfo}
ClusterInfo <- as.data.frame(colData(sce)) %>% 
  group_by(celltype, Sample,Joint.Location) %>%
  summarise(cells = n(),.groups = 'drop') 
```

### Absolute comparison

```{r PlotAbsoluteClustering}

ggplot(data=ClusterInfo, aes(x=Sample,y=cells, fill=celltype)) +
  geom_bar(stat="identity", position="stack") +
  labs(title="Absolute comparison nr Cells in Celltype",subtitle="Per Sample",x="",y="Number of cells")+
  theme(axis.text.x = element_text(angle = 45,hjust=1), axis.ticks.x=element_blank())+
  theme_classic()

```

### Relative comparison

```{r PlotRelativeClustering}

ggplot(data=ClusterInfo,aes(x=Sample, y=cells, fill=celltype)) +
  geom_bar(stat="identity", position="fill") +
  labs(title="Relative comparison nr Cells in celltype",subtitle="Per Sample",x="",y="Number of cells")+
  theme(axis.text.x = element_text(angle = 45,hjust=1), axis.ticks.x=element_blank())+
  theme_classic()


```

## Frequencies of celltypes in clusters per Condition {.tabset}

```{r ClusterInfo}
ClusterInfo <- as.data.frame(colData(sce)) %>% 
  group_by(celltype,Joint.Location) %>%
  summarise(cells = n(),.groups = 'drop') 
```

### Absolute comparison

```{r PlotAbsoluteClustering}

ggplot(data=ClusterInfo, aes(x=Joint.Location,y=cells, fill=celltype)) +
  geom_bar(stat="identity", position="stack") +
  labs(title="Absolute comparison nr Cells in Celltype",subtitle="Per Condition",x="",y="Number of cells")+
  theme(axis.text.x = element_text(angle = 45,hjust=1), axis.ticks.x=element_blank())+
  theme_classic()

```

### Relative comparison

```{r PlotRelativeClustering}

ggplot(data=ClusterInfo,aes(x=Joint.Location, y=cells, fill=celltype)) +
  geom_bar(stat="identity", position="fill") +
  labs(title="Relative comparison nr Cells in celltype",subtitle="Per Condition",x="",y="Number of cells")+
  theme(axis.text.x = element_text(angle = 45,hjust=1), axis.ticks.x=element_blank())+
  theme_classic()


```


### Grouped boxplot

```{r PlotGroupedClustering}

# Fraction of cells [%] from total cells in that celltype

Totaljoint <- as.data.frame(colData(sce)) %>% 
     group_by(Joint.Location) %>%
     summarise(totalcellsjoint = n(),.groups = 'drop')

Totalcelltype <- as.data.frame(colData(sce)) %>% 
    group_by(Joint.Location,celltype) %>%
    summarise(totalcells = n(),.groups = 'drop') %>% 
    left_join(Totaljoint, Totalcelltype,by ="Joint.Location") %>%
    mutate(freq = totalcells / totalcellsjoint * 100)


ggplot(Totalcelltype, aes(fill=Joint.Location, y=freq, x=celltype)) + 
    geom_bar(width=0.8,position=position_dodge(0.9), stat="identity")+ 
    theme_classic()+
    labs(title="Relative cell type abundance in celltypes", subtitle="Per Joint Location", x="", y="Fraction of cells [%]")+
    theme(axis.text.x = element_text(angle = 45,hjust=1), axis.line = element_line(colour = "black"), panel.background = element_rect(fill = NA)) 



```




## Identify Marker Genes for Annotation


### Wilcoxon rank-sum test on Cluster

```{r AnnoMarker, eval=FALSE}

for (labeling in c('ManualAnno_L0','ManualAnno_L1')){
  #Wilcoxon rank-sum test
  markers_wilcox <- wilcoxauc(sce, group_by=labeling, assay = 'logcounts')
  # Get the top 50 markers for each Anno (save in excel file)
  # filter for nominally significant (p<0.05) and over-expressed (auc>0.5)
  topDEgenes <- top_markers(markers_wilcox, n = 50, auc_min = 0.5, pval_max = 0.05)
  
  wb = createWorkbook()
  for (i in 1:max(as.integer(levels(sce$paste0(labeling))))){
    #get genes for the Anno
    markers<-topDEgenes[,paste0(i), drop=TRUE]
    #Create table
    tmp<-markers_wilcox[markers_wilcox$feature %in% markers & markers_wilcox$group == i,]
    
    #Save table in Exelsheet
    addDataFrame(tmp, sheet=createSheet(wb, paste0(i)), startColumn=1, row.names=FALSE,col.names = TRUE)
  }
  saveWorkbook(wb,paste0( path , "/output/",paste0(labeling),"_Wilcoxon.xlsx"))  
  
  
}



------------------------------------
#Wilcoxon rank-sum test
markers_wilcox_L0 <- wilcoxauc(sce, group_by='ManualAnno_L0', assay = 'logcounts')
# Get the top 50 markers for each cluster (save in excel file)
# filter for nominally significant (p<0.05) and over-expressed (auc>0.5)
topDEgenes_L0 <- top_markers(markers_wilcox_L0, n = 50, auc_min = 0.5, pval_max = 0.05)

wb = createWorkbook()
for (i in 1:max(as.integer(levels(sce$ManualAnno_L0)))){
  #get genes for the cluster
  markers<-topDEgenes_L0[,paste0(i), drop=TRUE]
  #Create table
  tmp<-markers_wilcox_L0[markers_wilcox_L0$feature %in% markers & markers_wilcox_L0$group == i,]
  
  #Save table in Exelsheet
  addDataFrame(tmp, sheet=createSheet(wb, paste0(i)), startColumn=1, row.names=FALSE,col.names = TRUE)
}
saveWorkbook(wb,paste0( path , "/output/Annotated_L0_Wilcoxon.xlsx"))




markers_wilcox_L1 <- wilcoxauc(sce, group_by='ManualAnno_L1', assay = 'logcounts')
# Get the top 50 markers for each ManualAnno_L1 (save in excel file)
# filter for nominally significant (p<0.05) and over-expressed (auc>0.5)
topDEgenes_L1 <- top_markers(markers_wilcox_L1, n = 50, auc_min = 0.5, pval_max = 0.05)

wb = createWorkbook()
for (i in 1:max(as.integer(levels(sce$ManualAnno_L1)))){
  #get genes for the ManualAnno_L1
  markers<-top50DEgenes[,paste0(i), drop=TRUE]
  #Create table
  tmp<-markers_wilcox_L1[markers_wilcox_L1$feature %in% markers & markers_wilcox_L1$group == i,]
  
  #Save table in Exelsheet
  addDataFrame(tmp, sheet=createSheet(wb, paste0(i)), startColumn=1, row.names=FALSE,col.names = TRUE)
}
saveWorkbook(wb,paste0( path , "/output/Annotated_L1_Wilcoxon.xlsx"))
```



## Save the dataset

```{r SaveData}
saveRDS(sce, file =paste0(path,'/output/05_sce_CelltypeAnnotation.rds'))
```
