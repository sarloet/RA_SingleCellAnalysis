---
title: "Subclustering"
subtitle: "07_SubClustering"
author: "SarahL."
date: "`r format(Sys.time(), '%b %e %Y %H:%M:%S')`"
output: 
  html_document:
    toc: true
    number_sections: true   
    toc_float: true
    code_folding: hide
    df_print: paged
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
knitr::opts_chunk$set(cache = FALSE, cache.lazy = FALSE)
knitr::opts_chunk$set(dpi = 300, fig.align = "center")
knitr::opts_chunk$set(out.width = "100%", out.height = "100%")
```


# Subclustering

## Setup

### Standard packages

```{r LoadPackages, warning=FALSE}
library(here)
source(here("code", "standard_libraries.R"))
```

### Additional Packages

```{r LoadPackages, warning=FALSE,eval=FALSE}
#Load Packages

suppressPackageStartupMessages({
library(batchelor)
library(bluster)
library(presto)
library(dittoSeq)
library(gridExtra)
library(intrinsicDimension)
})

```


### Set Parameter

```{r Setup}
set.seed(123)
bpp <- BiocParallel::MulticoreParam(parallel::detectCores()-1, RNGseed=123)
path <- here::here()
```


### Load Data

```{r LoadDataset}
## RA DATASET
sce <- readRDS(file = paste0(path,'/output/06_sce_CelltypeAnnotation.rds'))

```


### Explore Dataset

```{r ShowDim}
#Dimensions of count matrix
dim(sce)
```

https://mperalc.gitlab.io/scRNA-seq_workshop_2021/additional-resources.html## UMAPs coloured by cluster or cell type

### Plot Annotation {.tabset}

### Annotation L1

```{r UMAPCluster}
#cluster
plotReducedDim(sce, "MNN_UMAP_reduced", colour_by="ManualAnno_L1", text_by="ManualAnno_L1") +labs(title="UMAP colored by clusters",subtitle = "UMAP of integrated dataset")

```

### Annotation L0

```{r UMAPAnnotation}
#cell type
plotReducedDim(sce, "MNN_UMAP_reduced", colour_by="ManualAnno_L0", text_by="ManualAnno_L0") +labs(title="UMAP colored by Cell type ",subtitle = "UMAP of integrated dataset")

```

## Subclustering Function

```{r SubclusteringFunction}
# Create Subclustering function

SUBCLUSTER <- function(sce.sc, SC_celltype, clust_param="leiden", k_param=50, merge_order, batchcorr=FALSE){
set.seed(123)

#Subset sce object for ce scelltype
sce.subset <- sce.sc[,sce.sc$celltype == SC_celltype]
    
#Get top HVG for subcluster
dec <- modelGeneVar(sce.subset, block=sce.subset$Sample, density.weights=FALSE,BPPARAM=bpp)
top.hvgs <- getTopHVGs(dec, n=2000)
rowData(sce.subset)$is_hvg <- rownames(sce.subset) %in% top.hvgs



if(batchcorr==TRUE){
  #Batch correction on subcluster
  sce.Batchelor <-multiBatchNorm(sce.subset, 
                                  batch=sce.subset$Sample, 
                                  subset.row = rownames(sce.subset)[rowData(sce.subset)[["is_hvg"]]], 
                                  normalize.all=TRUE, BPPARAM = bpp)
      
  bpstart(bpp)
  sce.Batchelor <- fastMNN(sce.Batchelor, 
                            batch=sce.Batchelor$Sample, 
                            prop.k=0.05,  
                            subset.row = rownames(sce.Batchelor)[rowData(sce.Batchelor)[["is_hvg"]]], 
                            correct.all=TRUE, merge.order = merge_order, BPPARAM = bpp)
  bpstop(bpp)
      
  assay(sce.subset, "reconstructed") <- assay(sce.Batchelor, "reconstructed")
  reducedDim(sce.subset, 'MNN_SC') <- reducedDim(sce.Batchelor, 'corrected')
  reducedDim(sce.subset, 'MNN_SC_reduced') <- reducedDim(sce.Batchelor, 'corrected')[,seq_len(15)]
      
  
  #Get UMAP on subset
  sce.subset <- runUMAP(sce.subset,name = "MNN_UMAP_SC_reduced", dimred = 'MNN_SC_reduced',subset_row=rowData(sce.subset)$is_hvg)
  #Recluster the cells 
  set.seed(123)
  cluster <- clusterCells(sce.subset, use.dimred = "MNN_SC_reduced", BLUSPARAM = SNNGraphParam(k= k_param,cluster.fun= clust_param, BPPARAM =bpp))
         
  }else{
  #Copy over the unintegrated reduced dim
  #reducedDim(sce.subset,"MNN_SC_reduced")<-reducedDim(sce.subset,"MNN_reduced")
  sce.subset<-runPCA(sce.subset,exprs_values ="reconstructed", subset_row = rowData(sce.subset)$is_hvg, name = "MNN_SC")
  reducedDim(sce.subset, 'MNN_SC_reduced') <- reducedDim(sce.subset, 'MNN_SC')[,seq_len(20)]
  
  }

#Get recalculated UMAP on subset
sce.subset <- runUMAP(sce.subset,name = "MNN_UMAP_SC_reduced", dimred = 'MNN_SC_reduced',subset_row=rowData(sce.subset)$is_hvg)
#Recluster the cells 
set.seed(123)
cluster <- clusterCells(sce.subset, use.dimred = "MNN_SC_reduced", BLUSPARAM = SNNGraphParam(k= k_param,cluster.fun= clust_param, BPPARAM =bpp))

#Add Subcluster label to sce
colData(sce.subset)$subcluster <- cluster
sce.subset$subcluster <- factor(sce.subset$subcluster)
    
#attr(sce.subset, "MNN_UMAP_SC_reduced")<-attr(reducedDim(sce.subset, "MNN_UMAP_SC_reduced"), "scaled:center") 
  
return(sce.subset)
}
```


```{r MergeOrder}
#Set manual merge_order
merge_order <- list(list("SynBio_077a","SynBio_093", "SynBio_096","SynBio_098a", "SynBio_127"),#Knee 
          list("SynBio_050", "SynBio_074", "SynBio_077b","SynBio_083","SynBio_084","SynBio_098b"),#Wrist
          list("SynBio_028", "SynBio_049", "SynBio_076", "SynBio_081", "SynBio_087"))#MCP,"SynBio_130", 


```


--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

## Subcluster Fibroblast

### Run Subclustering

```{r RunSubcluster, warning=FALSE}

#get correct parent label to subcluster
sce$celltype <- colData(sce)$ManualAnno_L1

# Run Subcluster Function
sce.Fibroblast<-SUBCLUSTER(sce, "Fibroblast", clust_param="leiden", k_param=45, merge_order, batchcorr=TRUE)
  
```

```{r RunSubcluster, warning=FALSE}
dim(sce.Fibroblast)
```

### Plot UMAP of Subclusters  {.tabset}

```{r UMAPSubcluster , results='asis'}
cat(paste0("##### Colored by Clustering\n"))
print(plotReducedDim(sce.Fibroblast, "MNN_UMAP_reduced",colour_by = "subcluster", text_by="subcluster") +
          labs(title=paste0("UMAP of Subcluster"),subtitle="Colored by clustering"))
    
cat(paste0("##### Colored by Sample\n"))
print(plotReducedDim(sce.Fibroblast, "MNN_UMAP_reduced",colour_by = "Sample") +
          labs(title=paste0("UMAP of Subcluster"),subtitle="Colored by Sample"))

```


## Plot Recalculated UMAP of Fibroblast Subclusters  {.tabset}

```{r UMAPSubclusterRecalc , results='asis'}
cat(paste0("#### Colored by Clustering\n"))
print(plotReducedDim(sce.Fibroblast, "MNN_UMAP_SC_reduced",colour_by = "subcluster",text_by="subcluster") +labs(title=paste0("Recalculated UMAP for Subcluster"),subtitle="Colored by clustering"))

cat(paste0("#### Colored by Sample\n"))
print(plotReducedDim(sce.Fibroblast, "MNN_UMAP_SC_reduced",colour_by = "Sample") +
          labs(title=paste0("Recalculated UMAP for Subcluster"),subtitle="Colored by Sample"))

```


## Plot QC UMAP of Fibroblast Subclusters  {.tabset}

```{r UMAPSubclusterRecalc , results='asis'}

print(Plot_QC_dimred(sce.Fibroblast,dim="MNN_UMAP_SC_reduced"))
```

```{r UMAPSubclusterRecalc , results='asis'}

print(Plot_QC_violin(sce.Fibroblast,label="subcluster"))
```

```{r UMAPSubclusterRecalc , results='asis'}

library(viridis)
cat(paste0("#### Colored by Mitochondrial Genes\n"))
print(plotReducedDim(sce.Fibroblast, "MNN_UMAP_SC_reduced",colour_by = "subsets_Mito_percent",order_by="subsets_Mito_percent") +labs(title=paste0("Recalculated UMAP for Subcluster"),subtitle="Colored by Mitochondrial Genes"))+ scale_fill_viridis_c(option="magma")

cat(paste0("#### Colored by Sample\n"))
print(plotReducedDim(sce.Fibroblast, "MNN_UMAP_SC_reduced",colour_by = "detected",order_by="detected") +
          labs(title=paste0("Recalculated UMAP for Subcluster"),subtitle="Colored by Number of detected Genes"))
scale_fill_viridis(option="magma")

cat(paste0("#### Colored by Sample\n"))
print(plotReducedDim(sce.Fibroblast, "MNN_UMAP_SC_reduced",colour_by = "sum",order_by="sum") +
          labs(title=paste0("Recalculated UMAP for Subcluster"),subtitle="Colored by Sum of UMI Counts in Cell"))
scale_fill_viridis(option="magma")




plotReducedDim(sce.Fibroblast, dimred = "MNN_UMAP_SC_reduced", colour_by = "POSTN" , order_by="POSTN" ,point_alpha=1,point_size=0.5) +scale_colour_gradient(name = "POSTN",low = "lightgrey", high = "red")
plotReducedDim(sce.Fibroblast, dimred = "MNN_UMAP_SC_reduced", colour_by = "CXCL12" , order_by="CXCL12" ,point_alpha=1,point_size=0.5) +scale_colour_gradient(name = "CXCL12",low = "lightgrey", high = "red")
plotReducedDim(sce.Fibroblast, dimred = "MNN_UMAP_SC_reduced", colour_by = "PRG4" , order_by="PRG4" ,point_alpha=1,point_size=0.5) +scale_colour_gradient(name = "PRG4",low = "lightgrey", high = "red")
plotReducedDim(sce.Fibroblast, dimred = "MNN_UMAP_SC_reduced", colour_by = "COMP" , order_by="COMP" ,point_alpha=1,point_size=0.5) +scale_colour_gradient(name = "COMP",low = "lightgrey", high = "red")
plotReducedDim(sce.Fibroblast, dimred = "MNN_UMAP_SC_reduced", colour_by = "MFAP5" , order_by="COMP" ,point_alpha=1,point_size=0.5) +scale_colour_gradient(name = "MFAP5",low = "lightgrey", high = "red")
plotReducedDim(sce.Fibroblast, dimred = "MNN_UMAP_SC_reduced", colour_by = "ACTA2" , order_by="ACTA2" ,point_alpha=1,point_size=0.5) +scale_colour_gradient(name = "ACTA2",low = "lightgrey", high = "red")


plotColData(sce.Fibroblast, x="subcluster", y="subsets_Mito_percent", other_fields="subcluster") + 
     facet_wrap(~subcluster, nrow=1, scales = "free_x") +
     ggtitle("Mito percent")+
     theme(axis.text.x = element_text(angle = 45,hjust=1,), axis.ticks.x=element_blank(),strip.text.x = element_blank())

plotColData(sce.Fibroblast, x="subcluster", y="detected", other_fields="subcluster") + 
     facet_wrap(~subcluster, nrow=1, scales = "free_x") +
     ggtitle("Detected Genes")+
     theme(axis.text.x = element_text(angle = 45,hjust=1,), axis.ticks.x=element_blank(),strip.text.x = element_blank())


plotColData(sce.Fibroblast, x="subcluster", y="sum", other_fields="subcluster") + 
     facet_wrap(~subcluster, nrow=1, scales = "free_x") +
     ggtitle("Total Counts")+
     theme(axis.text.x = element_text(angle = 45,hjust=1,), axis.ticks.x=element_blank(),strip.text.x = element_blank())
```



### Remove bad quality subcluster

```{r SaveData}
sce.Fibroblast <- sce.Fibroblast[,sce.Fibroblast$subcluster != 7]
dim(sce.Fibroblast)
```


### Subcluster UMAP

```{r SaveData}
plotReducedDim(sce.Fibroblast, "MNN_UMAP_SC_reduced",colour_by = "subcluster") +
          labs(title=paste0("Recalculated UMAP for Subcluster"),subtitle="Colored by subcluster")
```

### Save the dataset

```{r SaveData}
saveRDS(sce.Fibroblast, file =paste0(path,'/output/07_sce_SC_Fibroblast.rds'))
```


--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

## Subcluster Myeloid

```{r RunSubcluster, warning=FALSE}

sce$celltype <- colData(sce)$ManualAnno_L1

# Run Subcluster Function
sce.Myeloid<-SUBCLUSTER(sce, "Myeloid", clust_param="leiden", k_param=65, merge_order, batchcorr=FALSE)
```


```{r RunSubcluster, warning=FALSE}
dim(sce.Myeloid)
```

### Plot UMAP of Subclusters  {.tabset}

```{r UMAPSubcluster , results='asis'}
cat(paste0("##### Colored by Clustering\n"))
print(plotReducedDim(sce.Myeloid, "MNN_UMAP_reduced",colour_by = "subcluster", text_by="subcluster") +
          labs(title=paste0("UMAP of Subcluster"),subtitle="Colored by clustering"))
    
cat(paste0("##### Colored by Sample\n"))
print(plotReducedDim(sce.Myeloid, "MNN_UMAP_reduced",colour_by = "Sample") +
          labs(title=paste0("UMAP of Subcluster"),subtitle="Colored by Sample"))

```


## Plot Recalculated UMAP of Myeloid Subclusters  {.tabset}

```{r UMAPSubclusterRecalc , results='asis'}
cat(paste0("#### Colored by Clustering\n"))
print(plotReducedDim(sce.Myeloid, "MNN_UMAP_SC_reduced",colour_by = "subcluster",text_by="subcluster") +labs(title=paste0("Recalculated UMAP for Subcluster "),subtitle="Colored by clustering"))

cat(paste0("#### Colored by Sample\n"))
print(plotReducedDim(sce.Myeloid, "MNN_UMAP_SC_reduced",colour_by = "Sample") +
          labs(title=paste0("Recalculated UMAP for Subcluster "),subtitle="Colored by Sample"))

```




```{r UMAPSubclusterRecalc , results='asis'}

Plot_QC_dimred(sce.Myeloid,"MNN_UMAP_SC_reduced")

```


```{r UMAPSubclusterRecalc , results='asis'}
cat(paste0("#### Colored by Mitochondrial Genes\n"))
print(plotReducedDim(sce.Myeloid, "MNN_UMAP_SC_reduced",colour_by = "subsets_Mito_percent",order_by="subsets_Mito_percent") +labs(title=paste0("Recalculated UMAP for Subcluster"),subtitle="Colored by Mitochondrial Genes"))

cat(paste0("#### Colored by Sample\n"))
print(plotReducedDim(sce.Myeloid, "MNN_UMAP_SC_reduced",colour_by = "detected",order_by="detected") +
          labs(title=paste0("Recalculated UMAP for Subcluster"),subtitle="Colored by Number of detected Genes"))

cat(paste0("#### Colored by Sample\n"))
print(plotReducedDim(sce.Myeloid, "MNN_UMAP_SC_reduced",colour_by = "sum",order_by="sum") +
          labs(title=paste0("Recalculated UMAP for Subcluster"),subtitle="Colored by Sum of UMI Counts in Cell"))



plotColData(sce.Myeloid, x="subcluster", y="subsets_Mito_percent", other_fields="subcluster") + 
     facet_wrap(~subcluster, nrow=1, scales = "free_x") +
     ggtitle("Mito percent")+
     theme(axis.text.x = element_text(angle = 45,hjust=1,), axis.ticks.x=element_blank(),strip.text.x = element_blank())

plotColData(sce.Myeloid, x="subcluster", y="detected", other_fields="subcluster") + 
     facet_wrap(~subcluster, nrow=1, scales = "free_x") +
     ggtitle("Detected Genes")+
     theme(axis.text.x = element_text(angle = 45,hjust=1,), axis.ticks.x=element_blank(),strip.text.x = element_blank())


plotColData(sce.Myeloid, x="subcluster", y="sum", other_fields="subcluster") + 
     facet_wrap(~subcluster, nrow=1, scales = "free_x") +
     ggtitle("Total Counts")+
     theme(axis.text.x = element_text(angle = 45,hjust=1,), axis.ticks.x=element_blank(),strip.text.x = element_blank())

plotReducedDim(sce.Myeloid, dimred = "MNN_UMAP_SC_reduced", colour_by = "FOLR2" , order_by="FOLR2" ,point_alpha=1,point_size=0.5) +scale_colour_gradient(name = "HLA-DR",low = "lightgrey", high = "red")

```



### Remove bad quality subcluster

```{r SaveData}
#sce.Myeloid <- sce.Myeloid[,sce.Myeloid$subcluster != 4]
#dim(sce.Myeloid)
```


### Subcluster UMAP

```{r SaveData}
plotReducedDim(sce.Myeloid, "MNN_UMAP_SC_reduced",colour_by = "subcluster") +
          labs(title=paste0("Recalculated UMAP for Subcluster"),subtitle="Colored by subcluster")
```

### Save the dataset

```{r SaveData}
saveRDS(sce.Myeloid, file =paste0(path,'/output/07_sce_SC_Myeloid.rds'))
```


--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

## Subcluster T cell

```{r RunSubcluster, warning=FALSE}

sce$celltype <- colData(sce)$ManualAnno_L1

# Run Subcluster Function
sce.Tcell<-SUBCLUSTER(sce, "T cell", clust_param="leiden", k_param=50, merge_order,batchcorr=FALSE) #55
  
```


### Plot UMAP of Subclusters  {.tabset}

```{r UMAPSubcluster , results='asis'}
cat(paste0("##### Colored by Clustering\n"))
print(plotReducedDim(sce.Tcell, "MNN_UMAP_reduced",colour_by = "subcluster", text_by="subcluster") +
          labs(title=paste0("UMAP of Subcluster"),subtitle="Colored by clustering"))
    
cat(paste0("##### Colored by Sample\n"))
print(plotReducedDim(sce.Tcell, "MNN_UMAP_reduced",colour_by = "Sample") +
          labs(title=paste0("UMAP of Subcluster"),subtitle="Colored by Sample"))

```


## Plot Recalculated UMAP of T cell Subclusters  {.tabset}

```{r UMAPSubclusterRecalc , results='asis'}
cat(paste0("#### Colored by Clustering\n"))
print(plotReducedDim(sce.Tcell, "MNN_UMAP_SC_reduced",colour_by = "subcluster",text_by="subcluster") +labs(title="Recalculated UMAP for Subcluster ",subtitle="Colored by clustering"))

cat(paste0("#### Colored by Sample\n"))
print(plotReducedDim(sce.Tcell, "MNN_UMAP_SC_reduced",colour_by = "Sample") +
          labs(title="Recalculated UMAP for Subcluster ",subtitle="Colored by Sample"))

```

```{r UMAPSubclusterRecalc , results='asis'}

#Plot_QC_dimred(sce.Tcell,"MNN_UMAP_SC_reduced")


cat(paste0("#### Colored by Mitochondrial Genes\n"))
print(plotReducedDim(sce.Tcell, "MNN_UMAP_SC_reduced",colour_by = "subsets_Mito_percent",order_by="subsets_Mito_percent") +labs(title=paste0("Recalculated UMAP for Subcluster"),subtitle="Colored by Mitochondrial Genes"))

cat(paste0("#### Colored by Sample\n"))
print(plotReducedDim(sce.Tcell, "MNN_UMAP_SC_reduced",colour_by = "detected",order_by="detected") +
          labs(title=paste0("Recalculated UMAP for Subcluster"),subtitle="Colored by Number of detected Genes"))

cat(paste0("#### Colored by Sample\n"))
print(plotReducedDim(sce.Tcell, "MNN_UMAP_SC_reduced",colour_by = "sum",order_by="sum") +
          labs(title=paste0("Recalculated UMAP for Subcluster"),subtitle="Colored by Sum of UMI Counts in Cell"))



plotColData(sce.Tcell, x="subcluster", y="subsets_Mito_percent", other_fields="subcluster") + 
     facet_wrap(~subcluster, nrow=1, scales = "free_x") +
     ggtitle("Mito percent")+
     theme(axis.text.x = element_text(angle = 45,hjust=1,), axis.ticks.x=element_blank(),strip.text.x = element_blank())

plotColData(sce.Tcell, x="subcluster", y="detected", other_fields="subcluster") + 
     facet_wrap(~subcluster, nrow=1, scales = "free_x") +
     ggtitle("Detected Genes")+
     theme(axis.text.x = element_text(angle = 45,hjust=1,), axis.ticks.x=element_blank(),strip.text.x = element_blank())


plotColData(sce.Tcell, x="subcluster", y="sum", other_fields="subcluster") + 
     facet_wrap(~subcluster, nrow=1, scales = "free_x") +
     ggtitle("Total Counts")+
     theme(axis.text.x = element_text(angle = 45,hjust=1,), axis.ticks.x=element_blank(),strip.text.x = element_blank())

plotReducedDim(sce.Tcell, dimred = "MNN_UMAP_SC_reduced", colour_by = "FOLR2" , order_by="FOLR2" ,point_alpha=1,point_size=0.5) +scale_colour_gradient(name = "HLA-DR",low = "lightgrey", high = "red")



```


### Save the dataset

```{r SaveData}
saveRDS(sce.Tcell, file =paste0(path,'/output/07_sce_SC_Tcell.rds'))
```



--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

## Subcluster Endothelial

```{r RunSubcluster, warning=FALSE}

sce$celltype <- colData(sce)$ManualAnno_L1

# Run Subcluster Function
sce.Endothelial<-SUBCLUSTER(sce, "Endothelial cell", clust_param="leiden", k_param=50, merge_order, batchcorr=FALSE)
  
```

### Plot UMAP of Subclusters  {.tabset}

```{r UMAPSubcluster , results='asis'}
cat(paste0("##### Colored by Clustering\n"))
print(plotReducedDim(sce.Endothelial, "MNN_UMAP_reduced",colour_by = "subcluster", text_by="subcluster") +
          labs(title=paste0("UMAP of Subcluster"),subtitle="Colored by clustering"))
    
cat(paste0("##### Colored by Sample\n"))
print(plotReducedDim(sce.Endothelial, "MNN_UMAP_reduced",colour_by = "Sample") +
          labs(title=paste0("UMAP of Subcluster"),subtitle="Colored by Sample"))

```


## Plot Recalculated UMAP of T cell Subclusters  {.tabset}

```{r UMAPSubclusterRecalc , results='asis'}
cat(paste0("#### Colored by Clustering\n"))
print(plotReducedDim(sce.Endothelial, "MNN_UMAP_SC_reduced",colour_by = "subcluster",text_by="subcluster") +labs(title="Recalculated UMAP for Subcluster ",subtitle="Colored by clustering"))

cat(paste0("#### Colored by Sample\n"))
print(plotReducedDim(sce.Endothelial, "MNN_UMAP_SC_reduced",colour_by = "Sample") +
          labs(title="Recalculated UMAP for Subcluster ",subtitle="Colored by Sample"))

```

```{r RunSubcluster, warning=FALSE}

#remove bad subcluster
dim(sce.Endothelial)
sce.Endothelial <- sce[,sce$subcluster != 4]
sce.Endothelial <- sce.Endothelial[,sce.Endothelial$subcluster != 3]
dim(sce.Endothelial)

# Run Subcluster Function
sce.Endothelial<-SUBCLUSTER(sce.Endothelial, "Endothelial cell", clust_param="leiden", k_param=43, merge_order, batchcorr=FALSE)
  
```

### Plot UMAP of Subclusters  {.tabset}

```{r UMAPSubcluster , results='asis'}
cat(paste0("##### Colored by Clustering\n"))
print(plotReducedDim(sce.Endothelial, "MNN_UMAP_reduced",colour_by = "subcluster", text_by="subcluster") +
          labs(title=paste0("UMAP of Subcluster"),subtitle="Colored by clustering"))
    
cat(paste0("##### Colored by Sample\n"))
print(plotReducedDim(sce.Endothelial, "MNN_UMAP_reduced",colour_by = "Sample") +
          labs(title=paste0("UMAP of Subcluster"),subtitle="Colored by Sample"))

```


## Plot Recalculated UMAP of T cell Subclusters  {.tabset}

```{r UMAPSubclusterRecalc , results='asis'}
cat(paste0("#### Colored by Clustering\n"))
print(plotReducedDim(sce.Endothelial, "MNN_UMAP_SC_reduced",colour_by = "subcluster",text_by="subcluster") +labs(title="Recalculated UMAP for Subcluster ",subtitle="Colored by clustering"))

cat(paste0("#### Colored by Sample\n"))
print(plotReducedDim(sce.Endothelial, "MNN_UMAP_SC_reduced",colour_by = "Sample") +
          labs(title="Recalculated UMAP for Subcluster ",subtitle="Colored by Sample"))

```






```{r UMAPSubclusterRecalc , results='asis'}
cat(paste0("#### Colored by Mitochondrial Genes\n"))
print(plotReducedDim(sce.Endothelial, "MNN_UMAP_SC_reduced",colour_by = "subsets_Mito_percent",order_by="subsets_Mito_percent") +labs(title=paste0("Recalculated UMAP for Subcluster"),subtitle="Colored by Mitochondrial Genes"))

cat(paste0("#### Colored by Sample\n"))
print(plotReducedDim(sce.Endothelial, "MNN_UMAP_SC_reduced",colour_by = "detected",order_by="detected") +
          labs(title=paste0("Recalculated UMAP for Subcluster"),subtitle="Colored by Number of detected Genes"))

cat(paste0("#### Colored by Sample\n"))
print(plotReducedDim(sce.Endothelial, "MNN_UMAP_SC_reduced",colour_by = "sum",order_by="sum") +
          labs(title=paste0("Recalculated UMAP for Subcluster"),subtitle="Colored by Sum of UMI Counts in Cell"))



plotColData(sce.Endothelial, x="subcluster", y="subsets_Mito_percent", other_fields="subcluster") + 
     facet_wrap(~subcluster, nrow=1, scales = "free_x") +
     ggtitle("Mito percent")+
     theme(axis.text.x = element_text(angle = 45,hjust=1,), axis.ticks.x=element_blank(),strip.text.x = element_blank())

plotColData(sce.Endothelial, x="subcluster", y="detected", other_fields="subcluster") + 
     facet_wrap(~subcluster, nrow=1, scales = "free_x") +
     ggtitle("Detected Genes")+
     theme(axis.text.x = element_text(angle = 45,hjust=1,), axis.ticks.x=element_blank(),strip.text.x = element_blank())


plotColData(sce.Endothelial, x="subcluster", y="sum", other_fields="subcluster") + 
     facet_wrap(~subcluster, nrow=1, scales = "free_x") +
     ggtitle("Total Counts")+
     theme(axis.text.x = element_text(angle = 45,hjust=1,), axis.ticks.x=element_blank(),strip.text.x = element_blank())

plotReducedDim(sce.Endothelial, dimred = "MNN_UMAP_SC_reduced", colour_by = "FOLR2" , order_by="FOLR2" ,point_alpha=1,point_size=0.5) +scale_colour_gradient(name = "HLA-DR",low = "lightgrey", high = "red")

```


### Save the dataset

```{r SaveData}
saveRDS(sce.Endothelial, file =paste0(path,'/output/07_sce_SC_Endothelial.rds'))
```


--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

## Subcluster SMC

```{r RunSubcluster, warning=FALSE}

sce$celltype <- colData(sce)$ManualAnno_L1

# Run Subcluster Function
sce.SmoothMuscle<-SUBCLUSTER(sce, "Smooth muscle cell", clust_param="leiden", k_param=50, merge_order, batchcorr=FALSE)
  
```

### Plot UMAP of Subclusters  {.tabset}

```{r UMAPSubcluster , results='asis'}
cat(paste0("##### Colored by Clustering\n"))
print(plotReducedDim(sce.SmoothMuscle, "MNN_UMAP_reduced",colour_by = "subcluster", text_by="subcluster") +
          labs(title="SubCluster ",subtitle="Colored by clustering"))
    
cat(paste0("##### Colored by Sample\n"))
print(plotReducedDim(sce.SmoothMuscle, "MNN_UMAP_reduced",colour_by = "Sample") +
          labs(title="SubCluster ",subtitle="Colored by Sample"))

```


## Plot Recalculated UMAP of Fibroblast Subclusters  {.tabset}

```{r UMAPSubclusterRecalc , results='asis'}
cat(paste0("#### Colored by Clustering\n"))
print(plotReducedDim(sce.SmoothMuscle, "MNN_UMAP_SC_reduced",colour_by = "subcluster",text_by="subcluster") +labs(title="Recalculated UMAP for Subcluster ",subtitle="Colored by clustering"))

cat(paste0("#### Colored by Sample\n"))
print(plotReducedDim(sce.SmoothMuscle, "MNN_UMAP_SC_reduced",colour_by = "Sample") +
          labs(title="Recalculated UMAP for Subcluster ",subtitle="Colored by Sample"))

```


```{r UMAPSubclusterRecalc , results='asis'}
cat(paste0("#### Colored by Mitochondrial Genes\n"))
print(plotReducedDim(sce.SmoothMuscle, "MNN_UMAP_SC_reduced",colour_by = "subsets_Mito_percent",order_by="subsets_Mito_percent") +labs(title=paste0("Recalculated UMAP for Subcluster"),subtitle="Colored by Mitochondrial Genes"))

cat(paste0("#### Colored by Sample\n"))
print(plotReducedDim(sce.SmoothMuscle, "MNN_UMAP_SC_reduced",colour_by = "detected",order_by="detected") +
          labs(title=paste0("Recalculated UMAP for Subcluster"),subtitle="Colored by Number of detected Genes"))

cat(paste0("#### Colored by Sample\n"))
print(plotReducedDim(sce.SmoothMuscle, "MNN_UMAP_SC_reduced",colour_by = "sum",order_by="sum") +
          labs(title=paste0("Recalculated UMAP for Subcluster"),subtitle="Colored by Sum of UMI Counts in Cell"))


plotReducedDim(sce.SmoothMuscle, dimred = "MNN_UMAP_SC_reduced", colour_by = "ACTA2" , order_by="ACTA2" ,point_alpha=1,point_size=0.5) +scale_colour_gradient(name = "ACTA2",low = "lightgrey", high = "red")

plotColData(sce.SmoothMuscle, x="subcluster", y="subsets_Mito_percent", other_fields="subcluster") + 
     facet_wrap(~subcluster, nrow=1, scales = "free_x") +
     ggtitle("Mito percent")+
     theme(axis.text.x = element_text(angle = 45,hjust=1,), axis.ticks.x=element_blank(),strip.text.x = element_blank())

plotColData(sce.SmoothMuscle, x="subcluster", y="detected", other_fields="subcluster") + 
     facet_wrap(~subcluster, nrow=1, scales = "free_x") +
     ggtitle("Detected Genes")+
     theme(axis.text.x = element_text(angle = 45,hjust=1,), axis.ticks.x=element_blank(),strip.text.x = element_blank())


plotColData(sce.SmoothMuscle, x="subcluster", y="sum", other_fields="subcluster") + 
     facet_wrap(~subcluster, nrow=1, scales = "free_x") +
     ggtitle("Total Counts")+
     theme(axis.text.x = element_text(angle = 45,hjust=1,), axis.ticks.x=element_blank(),strip.text.x = element_blank())

```

```{r RunSubcluster, warning=FALSE}
#remove bad subcluster
dim(sce.SmoothMuscle)
sce.SmoothMuscle <- sce[,sce$subcluster != 2]
dim(sce.SmoothMuscle)
```


### Save the dataset

```{r SaveData}
saveRDS(sce.SmoothMuscle, file =paste0(path,'/output/07_sce_SC_Endothelial.rds'))
```


--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

## Subcluster Dendrittic Cells

```{r RunSubcluster, warning=FALSE}

sce$celltype <- colData(sce)$ManualAnno_L1

# Run Subcluster Function
sce.Dendritic<-SUBCLUSTER(sce, "Dendritic cell", clust_param="leiden", k_param=60, merge_order, batchcorr=FALSE)
  
```

### Plot UMAP of Subclusters  {.tabset}

```{r UMAPSubcluster , results='asis'}
cat(paste0("##### Colored by Clustering\n"))
print(plotReducedDim(sce.Dendritic, "MNN_UMAP_reduced",colour_by = "subcluster", text_by="subcluster") +
          labs(title="SubCluster ",subtitle="Colored by clustering"))
    
cat(paste0("##### Colored by Sample\n"))
print(plotReducedDim(sce.Dendritic, "MNN_UMAP_reduced",colour_by = "Sample") +
          labs(title="SubCluster ",subtitle="Colored by Sample"))

```


## Plot Recalculated UMAP of Fibroblast Subclusters  {.tabset}

```{r UMAPSubclusterRecalc , results='asis'}
cat(paste0("#### Colored by Clustering\n"))
print(plotReducedDim(sce.Dendritic, "MNN_UMAP_SC_reduced",colour_by = "subcluster",text_by="subcluster") +labs(title="Recalculated UMAP for Subcluster ",subtitle="Colored by clustering"))

cat(paste0("#### Colored by Sample\n"))
print(plotReducedDim(sce.Dendritic, "MNN_UMAP_SC_reduced",colour_by = "Sample") +
          labs(title="Recalculated UMAP for Subcluster ",subtitle="Colored by Sample"))


```


```{r UMAPSubclusterRecalc , results='asis'}
cat(paste0("#### Colored by Mitochondrial Genes\n"))
print(plotReducedDim(sce.Dendritic, "MNN_UMAP_SC_reduced",colour_by = "subsets_Mito_percent",order_by="subsets_Mito_percent") +labs(title=paste0("Recalculated UMAP for Subcluster"),subtitle="Colored by Mitochondrial Genes"))

cat(paste0("#### Colored by Sample\n"))
print(plotReducedDim(sce.Dendritic, "MNN_UMAP_SC_reduced",colour_by = "detected",order_by="detected") +
          labs(title=paste0("Recalculated UMAP for Subcluster"),subtitle="Colored by Number of detected Genes"))

cat(paste0("#### Colored by Sample\n"))
print(plotReducedDim(sce.Dendritic, "MNN_UMAP_SC_reduced",colour_by = "sum",order_by="sum") +
          labs(title=paste0("Recalculated UMAP for Subcluster"),subtitle="Colored by Sum of UMI Counts in Cell"))

plotColData(sce.SmoothMuscle, x="subcluster", y="subsets_Mito_percent", other_fields="subcluster") + 
     facet_wrap(~subcluster, nrow=1, scales = "free_x") +
     ggtitle("Mito percent")+
     theme(axis.text.x = element_text(angle = 45,hjust=1,), axis.ticks.x=element_blank(),strip.text.x = element_blank())

plotColData(sce.SmoothMuscle, x="subcluster", y="detected", other_fields="subcluster") + 
     facet_wrap(~subcluster, nrow=1, scales = "free_x") +
     ggtitle("Detected Genes")+
     theme(axis.text.x = element_text(angle = 45,hjust=1,), axis.ticks.x=element_blank(),strip.text.x = element_blank())


plotColData(sce.SmoothMuscle, x="subcluster", y="sum", other_fields="subcluster") + 
     facet_wrap(~subcluster, nrow=1, scales = "free_x") +
     ggtitle("Total Counts")+
     theme(axis.text.x = element_text(angle = 45,hjust=1,), axis.ticks.x=element_blank(),strip.text.x = element_blank())

```



### Save the dataset

```{r SaveData}
saveRDS(sce.Dendritic, file =paste0(path,'/output/07_sce_SC_Dendritic.rds'))
```

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

## Subcluster Mast Cells

```{r RunSubcluster, warning=FALSE}

sce$celltype <- colData(sce)$ManualAnno_L1

# Run Subcluster Function
sce.Mast<-SUBCLUSTER(sce, "Mast cell", clust_param="leiden", k_param=20, merge_order, batchcorr=FALSE)
  
```

### Plot UMAP of Subclusters  {.tabset}

```{r UMAPSubcluster , results='asis'}
cat(paste0("##### Colored by Clustering\n"))
print(plotReducedDim(sce.Mast, "MNN_UMAP_reduced",colour_by = "subcluster", text_by="subcluster") +
          labs(title="SubCluster ",subtitle="Colored by clustering"))
    
cat(paste0("##### Colored by Sample\n"))
print(plotReducedDim(sce.Mast, "MNN_UMAP_reduced",colour_by = "Sample") +
          labs(title="SubCluster ",subtitle="Colored by Sample"))

```



## Plot Recalculated UMAP of Fibroblast Subclusters  {.tabset}

```{r UMAPSubclusterRecalc , results='asis'}
cat(paste0("#### Colored by Clustering\n"))
print(plotReducedDim(sce.Mast, "MNN_UMAP_SC_reduced",colour_by = "subcluster",text_by="subcluster") +labs(title="Recalculated UMAP for Subcluster ",subtitle="Colored by clustering"))

cat(paste0("#### Colored by Sample\n"))
print(plotReducedDim(sce.Mast, "MNN_UMAP_SC_reduced",colour_by = "Sample") +
          labs(title="Recalculated UMAP for Subcluster ",subtitle="Colored by Sample"))


```


```{r UMAPSubclusterRecalc , results='asis'}
cat(paste0("#### Colored by Mitochondrial Genes\n"))
print(plotReducedDim(sce.Mast, "MNN_UMAP_SC_reduced",colour_by = "subsets_Mito_percent",order_by="subsets_Mito_percent") +labs(title=paste0("Recalculated UMAP for Subcluster"),subtitle="Colored by Mitochondrial Genes"))

cat(paste0("#### Colored by Sample\n"))
print(plotReducedDim(sce.Mast, "MNN_UMAP_SC_reduced",colour_by = "detected",order_by="detected") +
          labs(title=paste0("Recalculated UMAP for Subcluster"),subtitle="Colored by Number of detected Genes"))

cat(paste0("#### Colored by Sample\n"))
print(plotReducedDim(sce.Mast, "MNN_UMAP_SC_reduced",colour_by = "sum",order_by="sum") +
          labs(title=paste0("Recalculated UMAP for Subcluster"),subtitle="Colored by Sum of UMI Counts in Cell"))

plotReducedDim(sce.Mast, dimred = "MNN_UMAP_SC_reduced", colour_by = "TPSAB1" , order_by="TPSAB1" ,point_alpha=1,point_size=0.5) +scale_colour_gradient(name = "ACTA2",low = "lightgrey", high = "red")

plotColData(sce.Mast, x="subcluster", y="subsets_Mito_percent", other_fields="subcluster") + 
     facet_wrap(~subcluster, nrow=1, scales = "free_x") +
     ggtitle("Mito percent")+
     theme(axis.text.x = element_text(angle = 45,hjust=1,), axis.ticks.x=element_blank(),strip.text.x = element_blank())

plotColData(sce.Mast, x="subcluster", y="detected", other_fields="subcluster") + 
     facet_wrap(~subcluster, nrow=1, scales = "free_x") +
     ggtitle("Detected Genes")+
     theme(axis.text.x = element_text(angle = 45,hjust=1,), axis.ticks.x=element_blank(),strip.text.x = element_blank())


plotColData(sce.Mast, x="subcluster", y="sum", other_fields="subcluster") + 
     facet_wrap(~subcluster, nrow=1, scales = "free_x") +
     ggtitle("Total Counts")+
     theme(axis.text.x = element_text(angle = 45,hjust=1,), axis.ticks.x=element_blank(),strip.text.x = element_blank())

```

```{r RunSubcluster, warning=FALSE}
#remove bad subcluster
dim(sce.Mast)
sce.Mast <- sce[,sce$subcluster == 2]
dim(sce.Mast)
```


### Save the dataset

```{r SaveData}
saveRDS(sce.Mast, file =paste0(path,'/output/07_sce_SC_Mast.rds'))
```


--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

## Subcluster B cell

```{r RunSubcluster, warning=FALSE}

sce$celltype <- colData(sce)$ManualAnno_L1

# Run Subcluster Function
sce.Bcell<-SUBCLUSTER(sce, "B cell", clust_param="leiden", k_param=50, merge_order, batchcorr=FALSE)
  
```

### Plot UMAP of Subclusters  {.tabset}

```{r UMAPSubcluster , results='asis'}
cat(paste0("##### Colored by Clustering\n"))
print(plotReducedDim(sce.Bcell, "MNN_UMAP_reduced",colour_by = "subcluster", text_by="subcluster") +
          labs(title="SubCluster ",subtitle="Colored by clustering"))
    
cat(paste0("##### Colored by Sample\n"))
print(plotReducedDim(sce.Bcell, "MNN_UMAP_reduced",colour_by = "Sample") +
          labs(title="SubCluster ",subtitle="Colored by Sample"))

```



## Plot Recalculated UMAP of Fibroblast Subclusters  {.tabset}

```{r UMAPSubclusterRecalc , results='asis'}
cat(paste0("#### Colored by Clustering\n"))
print(plotReducedDim(sce.Bcell, "MNN_UMAP_SC_reduced",colour_by = "subcluster",text_by="subcluster") +labs(title="Recalculated UMAP for Subcluster ",subtitle="Colored by clustering"))

cat(paste0("#### Colored by Sample\n"))
print(plotReducedDim(sce.Bcell, "MNN_UMAP_SC_reduced",colour_by = "Sample") +
          labs(title="Recalculated UMAP for Subcluster ",subtitle="Colored by Sample"))


```


```{r UMAPSubclusterRecalc , results='asis'}
cat(paste0("#### Colored by Mitochondrial Genes\n"))
print(plotReducedDim(sce.Bcell, "MNN_UMAP_SC_reduced",colour_by = "subsets_Mito_percent",order_by="subsets_Mito_percent") +labs(title=paste0("Recalculated UMAP for Subcluster"),subtitle="Colored by Mitochondrial Genes"))

cat(paste0("#### Colored by Sample\n"))
print(plotReducedDim(sce.Bcell, "MNN_UMAP_SC_reduced",colour_by = "detected",order_by="detected") +
          labs(title=paste0("Recalculated UMAP for Subcluster"),subtitle="Colored by Number of detected Genes"))

cat(paste0("#### Colored by Sample\n"))
print(plotReducedDim(sce.Bcell, "MNN_UMAP_SC_reduced",colour_by = "sum",order_by="sum") +
          labs(title=paste0("Recalculated UMAP for Subcluster"),subtitle="Colored by Sum of UMI Counts in Cell"))

plotColData(sce.Bcell, x="subcluster", y="subsets_Mito_percent", other_fields="subcluster") + 
     facet_wrap(~subcluster, nrow=1, scales = "free_x") +
     ggtitle("Mito percent")+
     theme(axis.text.x = element_text(angle = 45,hjust=1,), axis.ticks.x=element_blank(),strip.text.x = element_blank())

plotColData(sce.Bcell, x="subcluster", y="detected", other_fields="subcluster") + 
     facet_wrap(~subcluster, nrow=1, scales = "free_x") +
     ggtitle("Detected Genes")+
     theme(axis.text.x = element_text(angle = 45,hjust=1,), axis.ticks.x=element_blank(),strip.text.x = element_blank())


plotColData(sce.Bcell, x="subcluster", y="sum", other_fields="subcluster") + 
     facet_wrap(~subcluster, nrow=1, scales = "free_x") +
     ggtitle("Total Counts")+
     theme(axis.text.x = element_text(angle = 45,hjust=1,), axis.ticks.x=element_blank(),strip.text.x = element_blank())

```


### Save the dataset

```{r SaveData}
saveRDS(sce.Bcell, file =paste0(path,'/output/07_sce_SC_Bcell.rds'))
```


--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


## Subcluster Plasma cell

```{r RunSubcluster, warning=FALSE}

sce$celltype <- colData(sce)$ManualAnno_L1

# Run Subcluster Function
sce.Plasma<-SUBCLUSTER(sce, "Plasma", clust_param="leiden", k_param=50, merge_order, batchcorr=FALSE)
  
```

### Plot UMAP of Subclusters  {.tabset}

```{r UMAPSubcluster , results='asis'}
cat(paste0("##### Colored by Clustering\n"))
print(plotReducedDim(sce.Plasma, "MNN_UMAP_reduced",colour_by = "subcluster", text_by="subcluster") +
          labs(title="SubCluster ",subtitle="Colored by clustering"))
    
cat(paste0("##### Colored by Sample\n"))
print(plotReducedDim(sce.Plasma, "MNN_UMAP_reduced",colour_by = "Sample") +
          labs(title="SubCluster ",subtitle="Colored by Sample"))

```



## Plot Recalculated UMAP of Fibroblast Subclusters  {.tabset}

```{r UMAPSubclusterRecalc , results='asis'}
cat(paste0("#### Colored by Clustering\n"))
print(plotReducedDim(sce.Plasma, "MNN_UMAP_SC_reduced",colour_by = "subcluster",text_by="subcluster") +labs(title="Recalculated UMAP for Subcluster ",subtitle="Colored by clustering"))

cat(paste0("#### Colored by Sample\n"))
print(plotReducedDim(sce.Plasma, "MNN_UMAP_SC_reduced",colour_by = "Sample") +
          labs(title="Recalculated UMAP for Subcluster ",subtitle="Colored by Sample"))


```


```{r UMAPSubclusterRecalc , results='asis'}
cat(paste0("#### Colored by Mitochondrial Genes\n"))
print(plotReducedDim(sce.Plasma, "MNN_UMAP_SC_reduced",colour_by = "subsets_Mito_percent",order_by="subsets_Mito_percent") +labs(title=paste0("Recalculated UMAP for Subcluster"),subtitle="Colored by Mitochondrial Genes"))

cat(paste0("#### Colored by Sample\n"))
print(plotReducedDim(sce.Plasma, "MNN_UMAP_SC_reduced",colour_by = "detected",order_by="detected") +
          labs(title=paste0("Recalculated UMAP for Subcluster"),subtitle="Colored by Number of detected Genes"))

cat(paste0("#### Colored by Sample\n"))
print(plotReducedDim(sce.Plasma, "MNN_UMAP_SC_reduced",colour_by = "sum",order_by="sum") +
          labs(title=paste0("Recalculated UMAP for Subcluster"),subtitle="Colored by Sum of UMI Counts in Cell"))

plotColData(sce.Plasma, x="subcluster", y="subsets_Mito_percent", other_fields="subcluster") + 
     facet_wrap(~subcluster, nrow=1, scales = "free_x") +
     ggtitle("Mito percent")+
     theme(axis.text.x = element_text(angle = 45,hjust=1,), axis.ticks.x=element_blank(),strip.text.x = element_blank())

plotColData(sce.Plasma, x="subcluster", y="detected", other_fields="subcluster") + 
     facet_wrap(~subcluster, nrow=1, scales = "free_x") +
     ggtitle("Detected Genes")+
     theme(axis.text.x = element_text(angle = 45,hjust=1,), axis.ticks.x=element_blank(),strip.text.x = element_blank())


plotColData(sce.Plasma, x="subcluster", y="sum", other_fields="subcluster") + 
     facet_wrap(~subcluster, nrow=1, scales = "free_x") +
     ggtitle("Total Counts")+
     theme(axis.text.x = element_text(angle = 45,hjust=1,), axis.ticks.x=element_blank(),strip.text.x = element_blank())

```


### Save the dataset

```{r SaveData}
saveRDS(sce.Plasma, file =paste0(path,'/output/07_sce_SC_Plasma.rds'))
```



--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------



## Subcluster Neutrophil

```{r RunSubcluster, warning=FALSE}

sce$celltype <- colData(sce)$ManualAnno_L1

# Run Subcluster Function
sce.Neutrophil<-SUBCLUSTER(sce, "Neutrophil", clust_param="leiden", k_param=50, merge_order, batchcorr=FALSE)
  
```

### Plot UMAP of Subclusters  {.tabset}

```{r UMAPSubcluster , results='asis'}
cat(paste0("##### Colored by Clustering\n"))
print(plotReducedDim(sce.Neutrophil, "MNN_UMAP_reduced",colour_by = "subcluster", text_by="subcluster") +
          labs(title="SubCluster ",subtitle="Colored by clustering"))
    
cat(paste0("##### Colored by Sample\n"))
print(plotReducedDim(sce.Neutrophil, "MNN_UMAP_reduced",colour_by = "Sample") +
          labs(title="SubCluster ",subtitle="Colored by Sample"))

```



## Plot Recalculated UMAP of Fibroblast Subclusters  {.tabset}

```{r UMAPSubclusterRecalc , results='asis'}
cat(paste0("#### Colored by Clustering\n"))
print(plotReducedDim(sce.Neutrophil, "MNN_UMAP_SC_reduced",colour_by = "subcluster",text_by="subcluster") +labs(title="Recalculated UMAP for Subcluster ",subtitle="Colored by clustering"))

cat(paste0("#### Colored by Sample\n"))
print(plotReducedDim(sce.Neutrophil, "MNN_UMAP_SC_reduced",colour_by = "Sample") +
          labs(title="Recalculated UMAP for Subcluster ",subtitle="Colored by Sample"))


```


```{r UMAPSubclusterRecalc , results='asis'}
cat(paste0("#### Colored by Mitochondrial Genes\n"))
print(plotReducedDim(sce.Neutrophil, "MNN_UMAP_SC_reduced",colour_by = "subsets_Mito_percent",order_by="subsets_Mito_percent") +labs(title=paste0("Recalculated UMAP for Subcluster"),subtitle="Colored by Mitochondrial Genes"))

cat(paste0("#### Colored by Sample\n"))
print(plotReducedDim(sce.Neutrophil, "MNN_UMAP_SC_reduced",colour_by = "detected",order_by="detected") +
          labs(title=paste0("Recalculated UMAP for Subcluster"),subtitle="Colored by Number of detected Genes"))

cat(paste0("#### Colored by Sample\n"))
print(plotReducedDim(sce.Neutrophil, "MNN_UMAP_SC_reduced",colour_by = "sum",order_by="sum") +
          labs(title=paste0("Recalculated UMAP for Subcluster"),subtitle="Colored by Sum of UMI Counts in Cell"))

plotColData(sce.Neutrophil, x="subcluster", y="subsets_Mito_percent", other_fields="subcluster") + 
     facet_wrap(~subcluster, nrow=1, scales = "free_x") +
     ggtitle("Mito percent")+
     theme(axis.text.x = element_text(angle = 45,hjust=1,), axis.ticks.x=element_blank(),strip.text.x = element_blank())

plotColData(sce.Neutrophil, x="subcluster", y="detected", other_fields="subcluster") + 
     facet_wrap(~subcluster, nrow=1, scales = "free_x") +
     ggtitle("Detected Genes")+
     theme(axis.text.x = element_text(angle = 45,hjust=1,), axis.ticks.x=element_blank(),strip.text.x = element_blank())


plotColData(sce.Neutrophil, x="subcluster", y="sum", other_fields="subcluster") + 
     facet_wrap(~subcluster, nrow=1, scales = "free_x") +
     ggtitle("Total Counts")+
     theme(axis.text.x = element_text(angle = 45,hjust=1,), axis.ticks.x=element_blank(),strip.text.x = element_blank())

```


### Save the dataset

```{r SaveData}
saveRDS(sce.Neutrophil, file =paste0(path,'/output/07_sce_SC_Neutrophil.rds'))
```





