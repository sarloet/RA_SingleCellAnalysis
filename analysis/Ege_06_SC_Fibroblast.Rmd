---
title: "Subcluster Fibroblast"
subtitle: "06_SC_Fibroblast"
author: "SarahL."
date: "`r format(Sys.time(), '%b %e %Y %H:%M:%S')`"
output: 
  html_document:
    toc: true
    number_sections: true   
    toc_float: true
    code_folding: hide
    df_print: paged
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
knitr::opts_chunk$set(cache = FALSE, cache.lazy = FALSE)
knitr::opts_chunk$set(dpi = 300, fig.align = "center")
knitr::opts_chunk$set(out.width = "100%", out.height = "100%")
```


# Subcluster Fibroblast Genelist Check

## Setup

### Standard packages

```{r LoadPackages, warning=FALSE}
library(here)
source(here("code", "standard_libraries.R"))
```

### Additional Packages


```{r LoadAddPackages, warning=FALSE}
#Load Packages

suppressPackageStartupMessages({
library(readxl)
library(presto)
library(dittoSeq)
library(gridExtra)
library(xlsx)
})

```

### Set Parameter

```{r Setup}
set.seed(100)
bpp <- BiocParallel::MulticoreParam(parallel::detectCores()-1, RNGseed=100)
path <- here::here()
```


### Load Data

```{r LoadDataset}
## RA DATASET
sce <- readRDS(file = paste0(path,'/output/07_sce_SC_Fibroblast_Anno.rds'))

```

### Explore Dataset

```{r ShowDim}
#Dimensions of count matrix
dim(sce)
```

https://mperalc.gitlab.io/scRNA-seq_workshop_2021/additional-resources.html## UMAPs coloured by cluster or cell type

### Plot Annotation {.tabset}

#### Plot UMAP of Subclusters 

```{r UMAPCluster1}
#cluster
plotReducedDim(sce, paste0("MNN_UMAP_SC_reduced"),colour_by = "subcluster", text_by="subcluster") +labs(title=paste0("SubCluster"),subtitle="Colored by clustering")
```

#### Plot Recalculated UMAP of Subclusters 

```{r UMAPCluster2}
#cluster
plotReducedDim(sce, paste0("MNN_UMAP_SC_reduced"),colour_by = "ManualAnno_L2", text_by="ManualAnno_L2") +labs(title="SubCluster ",subtitle="Colored by clustering")
```



### Load Table

```{r LoadTable}
## load Eges genelist
gene_list<-readxl::read_excel("/Users/student/Desktop/risk_loci_with_attributes_stimulation_and_expression.xlsx")
gene_list
```


```{r GenesInSCE}
#Get gene vector
gene_vector <- gene_list$hgnc_symbol

#Genes that are not in the SCE element
cat("Genes not in sce: ",length(gene_vector[! gene_vector %in% rowData(sce)$Symbol]),"\n")
gene_vector[! gene_vector %in% rowData(sce)$Symbol]

#Only keep genes that are in the sce element
gene_vector<-gene_vector[gene_vector %in% rowData(sce)$Symbol]

#Print genevector genes that are in sce
cat("Genes in sce:  ",length(gene_vector),"\n")
gene_vector
```


### Create Dotplot

#### Relative expression
```{r DotplotAll,fig.height=10, fig.width=25}
dittoDotPlot(sce, vars = gene_vector, group.by ="ManualAnno_L2",min.color="lightgrey", max.color="blue",min.percent=0.1,ylab=NULL)
```

#### Absolute expression
```{r DotplotAllScaled,fig.height=10, fig.width=25}
dittoDotPlot(sce, vars = gene_vector, group.by ="ManualAnno_L2",min.color="lightgrey", max.color="blue",min.percent=0.1,ylab=NULL,scale = FALSE)
```



### Wilcoxon
```{r Wilcoxon}
#Do wilcoxon
markers_wilcox <- wilcoxauc(sce, group_by= "ManualAnno_L2", assay = 'logcounts')

#Get the nr top markers for each label
topDEgenes <- top_markers(markers_wilcox, 50, padj_max = 0.05)
topDEgenes
#Filter for nominally significant (p<0.05) and over-expressed (auc>0.5)
markers_wilcox[markers_wilcox$padj<0.05 & abs(markers_wilcox$logFC)> 0.1,, drop=F]
#markers_wilcox[markers_wilcox$padj<0.05 & abs(markers_wilcox$logFC)> 0.1 & abs(markers_wilcox$auc)> 0.5,, drop=F]

```

Save top 50 markers for each subcluster on excel sheet
```{r SaveWCgenes}
wb = createWorkbook()
for (i in unique(sce$ManualAnno_L2)){
  #get genes for the Anno
  topDEgenes <- top_markers(markers_wilcox, 100, padj_max = 0.05)
  markers<-topDEgenes[,paste0(i), drop=TRUE]
  #Create table with top DE markers
  tmp<-markers_wilcox[markers_wilcox$feature %in% markers & markers_wilcox$group == i,]
  #Order list after padj
  tmp <- tmp[order(tmp$padj, decreasing = FALSE),]
  #Save table in Exelsheet
  addDataFrame(tmp, sheet=createSheet(wb, paste0(i)), startColumn=1, row.names=FALSE, col.names = TRUE)
}
saveWorkbook(wb,paste0("/Users/student/Desktop/","Ege_SC_Fibroblast_Wilcoxon.xlsx")) 


```


### Get Genes that are in Genelist from Wilcoxon

Get Genes that are in Genelist
```{r WilcoxonAndGenelist}
#Subset the wilcoxon table to only contain genes that are in the vector
wilcox_genelist<-markers_wilcox[markers_wilcox$feature %in% gene_vector,]
wilcox_genelist

#Only take the significant genes
wilcox_genelist[wilcox_genelist$padj<0.05 & abs(wilcox_genelist$logFC)> 0.1 ,, drop=F]#& abs(wilcox_genelist$auc)> 0.5
#write.xlsx(wilcox_genelist[wilcox_genelist$padj<0.05 & abs(wilcox_genelist$logFC)> 0.1 ,, drop=F], 'Ege_SC_Fibroblast_Wilcoxon.xlsx')

#How many genes are in there uniquely
cat("total")
length(wilcox_genelist$feature[wilcox_genelist$padj<0.05 & abs(wilcox_genelist$logFC)> 0.1 & abs(wilcox_genelist$auc)> 0.5, drop=F])
cat("unique")
length(unique(wilcox_genelist$feature[wilcox_genelist$padj<0.05 & abs(wilcox_genelist$logFC)> 0.1 & abs(wilcox_genelist$auc)> 0.5, drop=F]))
```

#### Dotplot of wilcoxon genes DE in PRG4+
```{r DotplotPRG4,fig.height=10, fig.width=15}
#Get DE WC genes for PRG4+
v<- wilcox_genelist$feature[wilcox_genelist$padj<0.05 & abs(wilcox_genelist$logFC)> 0.1  & wilcox_genelist$group=="PRG4+", drop=F]#& abs(wilcox_genelist$auc)> 0.5

# Relative expression
dittoDotPlot(sce, vars = unique(v), group.by ="ManualAnno_L2",min.color="lightgrey", max.color="blue",min.percent=0.1,ylab=NULL)
# Absolute expression
dittoDotPlot(sce, vars = unique(v), group.by ="ManualAnno_L2",min.color="lightgrey", max.color="blue",min.percent=0.1,ylab=NULL,scale = FALSE)
```


## Save the dataset

```{r SaveData}
#saveRDS(sce, file =paste0(path,'/output/06_sce_SC_Fibroblast.rds'))
```
