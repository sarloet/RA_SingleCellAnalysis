---
title: "Marker Genes and Celltype Annotation"
subtitle: "05_CelltypeAnnotation"
author: "SarahL."
date: "`r format(Sys.time(), '%b %e %Y %H:%M:%S')`"
output: 
  html_document:
    toc: true
    number_sections: true   
    toc_float: true
    code_folding: hide
    df_print: paged
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
knitr::opts_chunk$set(cache = FALSE, cache.lazy = FALSE)
knitr::opts_chunk$set(dpi = 300, fig.align = "center")
knitr::opts_chunk$set(out.width = "100%", out.height = "100%")
```


# Marker Genes and Celltype Annotation

## Setup

### Standard packages

```{r LoadPackages, warning=FALSE}
library(here)
source(here("code", "standard_libraries.R"))
```

### Additional Packages

```{r LoadAddPackages, warning=FALSE}
#Load Packages

suppressPackageStartupMessages({
#library(scuttle)
library(dittoSeq)
library(pheatmap)
library(xlsx)
library(presto)
})

```

### Set Parameter

```{r Setup}
set.seed(100)
bpp <- BiocParallel::MulticoreParam(parallel::detectCores()-1, RNGseed=100)
path <- here::here()
```


## Load Data

```{r LoadDataset}
## RA DATASET
sce <- readRDS(file = paste0(path,'/output/04_sce_Clustering.rds'))

```

### Change Rownames to the Symbol

```{r ChangeRownames}
#Change to genesymbol whenever possible
rowData(sce)$UniqID <-rownames(sce)
rownames(sce) <- uniquifyFeatureNames(rowData(sce)$ID, rowData(sce)$Symbol)
data.frame(rowData(sce))
```


### Explore Dataset

```{r ShowDim}
#Dimensions of count matrix
dim(sce)
```


## Plot Clustering and QC {.tabset}

### PCA

```{r PlotClusterPCA}
plotReducedDim(sce, dimred="MNN", colour_by="leiden",text_by="cluster") + ggtitle("UMAP with cluster label")
```

### UMAP

```{r PlotClusterUMAP}
plotReducedDim(sce, dimred="MNN_UMAP", colour_by="leiden",text_by="cluster") + ggtitle("UMAP with cluster label")
```

### QC UMAPs

```{r PlotClusterQCUMAP,fig.dim = c(8, 6)}
p1 <- plotReducedDim(sce, dimred="MNN_UMAP", colour_by="subsets_Mito_percent") + ggtitle("Mitochondrial Genes")
p2 <- plotReducedDim(sce, dimred="MNN_UMAP", colour_by="detected") + ggtitle("Number of detected Genes ")
p3 <- plotReducedDim(sce, dimred="MNN_UMAP", colour_by="sum") + ggtitle("Sum of UMI Counts in Cell")
grid.arrange(p1, p2, p3, nrow = 1, ncol = 3)
rm(p1, p2, p3)
```


## Identify Marker Genes


### Wilcoxon rank-sum test on Cluster

```{r IdentifyMarker}
#Select the hvg
sce.marker <- sce[rowData(sce)$is_hvg==TRUE,]
rownames(sce.marker) <- rowData(sce.marker)$Symbol

#Wilcoxon rank-sum test
markers_wilcox <- wilcoxauc(sce, group_by='cluster', assay = 'logcounts')

```

```{r SaveTopMarker}
# Get the top 5 markers for each cluster (for heatmap)
# filter for nominally significant (p<0.05) and over-expressed (auc>0.5)
top3DEgenes <- top_markers(markers_wilcox, n = 3, auc_min = 0.5, pval_max = 0.05)

#Show top 5 DE Genes of each cluster
data.frame(top3DEgenes)
top3DEgenes<-unlist(as.data.frame(top3DEgenes[,-1]),use.names = FALSE)

# Get the top 50 markers for each cluster (save in excel file)
# filter for nominally significant (p<0.05) and over-expressed (auc>0.5)
top50DEgenes <- top_markers(markers_wilcox, n = 50, auc_min = 0.5, pval_max = 0.05)

wb = createWorkbook()
for (i in 1:max(as.integer(levels(sce$cluster)))){
  #get genes for the cluster
  markers<-top50DEgenes[,paste0(i), drop=TRUE]
  #Create table
  tmp<-markers_wilcox[markers_wilcox$feature %in% markers & markers_wilcox$group == i,]
  
  #Save table in Exelsheet
  addDataFrame(tmp, sheet=createSheet(wb, paste0("Cluster ", i)), startColumn=1, row.names=TRUE,col.names = TRUE)
}
saveWorkbook(wb,paste0( path , "/output/Cluster_Marker_Genes.xlsx"))



```

### Wilcoxon heatmap

```{r PlotHeatmap}
#Heatmap of top marker genes of each cluster by Wilcoxon rank-sum 


# To avoid a too big plot we only keep every 20th cell
sce.plot <- sce[unique(top5DEgenes), seq(1, dim(sce)[2], 20)]
dittoHeatmap(sce.plot, vars = unique(top5DEgenes), annot.by = c("cluster"),scaled.to.max = TRUE,cluster_rows=FALSE,cluster_cols=TRUE, heatmap.colors.max.scaled = inferno(100) )


#Dotplot
dittoDotPlot(sce, vars = unique(top5DEgenes) , group.by = "label",min.color="lightgrey", max.color="blue",min.percent=0.2,max.percent=1,scale = TRUE )

rm(sce.marker,sce.plot,column_annotations,markers_wilcox_up)
gc()
```


### Wilcoxon rank-sum test 

```{r IdentifyMarker}
#Select the hvg
sce.marker <- sce[rowData(sce)$is_hvg==TRUE,]
rownames(sce.marker) <- rowData(sce.marker)$Symbol

#Wilcoxon rank-sum test
markers_wilcox_up <- findMarkers(sce.marker, groups = sce$cluster, block = sce$Sample, direction = "up")

```

```{r SaveTopMarker}
#Dataset for heatmap of top marker genes of each cluster by Wilcoxon rank-sum 
top5DEgenes <-do.call("rbind",lapply(markers_wilcox_up, function(x) { x[ order(x$Top, decreasing = FALSE),][1:5,1:4]}))

#Create Excel file with top 50 for each cluster
wb = createWorkbook()
for (i in 1:length(markers_wilcox_up)){
  tmp<-markers_wilcox_up[[i]]
  #Save in Exelsheet
  addDataFrame(tmp[order(tmp$Top , decreasing = FALSE),][1:50,1:4], sheet=createSheet(wb, paste0("Cluster ", i)), startColumn=1, row.names=TRUE,col.names = TRUE)
}
saveWorkbook(wb,paste0( path , "/output/Cluster_Wilcoxon.xlsx"))

#Show top 5 DE Genes of each cluster
data.frame(top5DEgenes)

```

### Wilcoxon heatmap

```{r PlotHeatmap}
#Heatmap of top marker genes of each cluster by Wilcoxon rank-sum 

#Get most meaningful markers
top_genes_wilcox <- lapply(markers_wilcox_up, function(marker_set){
  marker_set %>%
  as.data.frame() %>%
  filter(Top <= 1) %>%
  arrange(p.value)%>%
  dplyr::slice(1:2)%>%
  rownames()
}) %>% 
  unlist(use.names=F) %>% 
  unique()


# To avoid a too big plot we only keep every 10th cell
sce.plot <- sce.marker[top_genes_wilcox, seq(1, dim(sce.marker)[2], 20)]
# We sort by cluster
sce.plot <- sce.plot[,order(sce.plot$label)]
# Anotations
column_annotations <- data.frame("Cluster"=factor(sce.plot$label), row.names=colnames(sce.plot))
# clip heatmap values to ensure that colour contrast is high
sce.plot <- assay(sce.plot, "logcounts")
sce.plot[sce.plot >=3] = 3

pheatmap(sce.plot, annotation_col=column_annotations,
         show_rownames=TRUE,cluster_rows=FALSE, show_colnames=FALSE, cluster_cols=FALSE)

dittoDotPlot(sce.marker, vars = top_genes_wilcox , group.by = "label",min.color="white", max.color="red")
dittoDotPlot(sce, vars = marker , group.by = "label",min.color="lightgrey", max.color="blue",min.percent=0.2,max.percent=1,scale = TRUE ,min = -2.5,max = 2.5)

rm(sce.marker,sce.plot,column_annotations,markers_wilcox_up)

```

## Manual Celltype annotation

```{r VizGenExFunction}
#Function to visuaise gene Expression for vector of genes

VizGenEx <- function(markr){
 
  for(i in markr){
  
    cat(paste0("\n##### ", i, "\n"))
  
    gridExtra::grid.arrange(
      arrangeGrob(plotReducedDim(sce, dimred = "MNN_UMAP", colour_by = i, text_by = "cluster"), 
                  plotReducedDim(sce, dimred = "MNN_UMAP", colour_by = i, order_by=i ) 
                    +scale_colour_gradient(name = i,low = "lightgrey", high = "red"), ncol = 2), 
                  plotExpression(sce, features = i, x = "cluster"),nrow = 2)
    cat(' \n')
  
  }
     
}

```


### Major cell type Annotation - Level0 {.tabset}

Identify major cell types for a Rough Annotation on high hierarchical level

#### Lymphocyte {.tabset}

```{r LymphocyteL0, results='asis'}
  
VizGenEx(c("PTPRC","CORO1A","RAC2"))  
```

#### Myeloid {.tabset}

```{r MyeloidL0, results='asis'}

VizGenEx(c("CSF3R","MS4A6A","MS4A7"))  

```

#### Fibroblast {.tabset}

```{r FibroblastL0, results='asis'}

VizGenEx(c("PDGFRB","DCN","PCOLCE","ACTA2")) 

```

#### Endothelial {.tabset}

```{r EndothelialL0, results='asis'}

VizGenEx(c("CDH5","ECSCR","CCL14")) 

```

### Assignement - Level0 

```{r AssignementL0}
#Manual Annotation
sce$ManualAnno_L0 <- as.integer(sce$cluster)
unique(sce$ManualAnno_L0)

sce$ManualAnno_L0[sce$cluster %in% c(5,9,10,11,14,16,17,20)] <- "Lymphocyte"
sce$ManualAnno_L0[sce$cluster %in% c(4,7,8,13,18,21)] <- "Myeloid"
sce$ManualAnno_L0[sce$cluster %in% c(2,3,12,15)] <- "Stromal"
sce$ManualAnno_L0[sce$cluster %in% c(1,6,19)] <- "Endothelial"

```

### Finer cell type Annotation - Level1 {.tabset}

Identify cell types for a finer grained Annotation on lower hierarchical level

#### Myeloid / Macrophage {.tabset}

```{r MacrophageL1, results='asis'}

VizGenEx(c("MARCO","LYZ","MSR1","CD14","FCGR3A")) 

```


#### Fibroblast {.tabset}

```{r FibroblastL1, results='asis'}

VizGenEx(c("PDGFRB","DCN","COL1A1")) 

```

#### Lining Fibroblast {.tabset}

```{r LiningFibroblastL1, results='asis'}

VizGenEx(c("PRG4","CRTAC1", "CLU")) 

```

#### Endothelial {.tabset}

```{r EndothelialL1, results='asis'}

VizGenEx(c("CDH5","VWF", "PECAM1","CCL14"))

```

#### Lymphatic Endothelial {.tabset}

```{r LymphaticEndothelialL1, results='asis'}

VizGenEx(c("PROX1","LYVE1", "CCL21"))

```

#### BCell {.tabset}

```{r BCellL1, results='asis'}

VizGenEx(c("CD19","MS4A1","CD79A","TNFRSF13C"))

```

#### Plasma {.tabset}

```{r PlasmaL1, results='asis'}

VizGenEx(c("JSRP1","DERL3", "JCHAIN","SDC1","MZB1"))

```

#### Tcell {.tabset}

```{r TcellL1, results='asis'} 
 
VizGenEx(c("CD3E","CD3D", "CD3G","TRAC"))

```

#### Smooth muscle cell {.tabset}

```{r SMCL1, results='asis'}

VizGenEx(c("ACTA2","MYL9", "DES", "MYH11"))

```

#### Mastcell {.tabset}

```{r MastcellL1, results='asis'}

VizGenEx(c("TPSAB1","CPA3","HPGDS","VWA5A"))

```

#### Neutrophil {.tabset}

```{r NeutrophilL1, results='asis'}

VizGenEx(c("CSF3R","S100A8","TREM1"))
  
```

#### Plasmacytoid dendritic cell {.tabset}

```{r pDCL1, results='asis'}

VizGenEx(c("PTPRC","CLEC4C","LILRA4","LRRC26"))

```

### Assignement - Level1 

```{r AssignementL1}
#Manual Annotation

sce$ManualAnno_L1 <- as.integer(sce$cluster)
unique(sce$ManualAnno_L1)

sce$ManualAnno_L1[sce$cluster %in% c(2,3,12)] <- "Fibroblast"
sce$ManualAnno_L1[sce$cluster %in% c(15)] <- "Smooth muscle cell"
sce$ManualAnno_L1[sce$cluster %in% c(1,6,19)] <- "Edothelial cell"
sce$ManualAnno_L1[sce$cluster %in% c(9,10,11,14)] <- "T cell"
sce$ManualAnno_L1[sce$cluster %in% c(17)] <- "B cell"
sce$ManualAnno_L1[sce$cluster %in% c(20)] <- "Neutrophil"
sce$ManualAnno_L1[sce$cluster %in% c(16)] <- "Mast cell"
sce$ManualAnno_L1[sce$cluster %in% c(4,7,8,18,21)] <- "Myeloid"
sce$ManualAnno_L1[sce$cluster %in% c(5)] <- "Plasma"
sce$ManualAnno_L1[sce$cluster %in% c(13)] <- "Plasmacytoid dendritic cell"
```

```{r AssignementCheck}
#Check if all clusters assigned
unique(sce$ManualAnno_L0)
unique(sce$ManualAnno_L1)
```

#### Plot Assigned Celltypes {.tabset}

##### UMAP L1

```{r PlotL1}
#Plot manual Annotation
plotReducedDim(sce, dimred="MNN_UMAP", by_exprs_values = "logcounts", colour_by="ManualAnno_L1")+ ggtitle("UMAP Celllabel")
plotReducedDim(sce, dimred="MNN_UMAP", by_exprs_values = "logcounts", colour_by="ManualAnno_L1", text_by="ManualAnno_L1")+ ggtitle("UMAP Celllabel")
```

##### UMAP L0

```{r PlotL0}
#Plot manual Annotation
plotReducedDim(sce, dimred="MNN_UMAP", by_exprs_values = "logcounts", colour_by="ManualAnno_L0")+ ggtitle("UMAP Celllabel")
plotReducedDim(sce, dimred="MNN_UMAP", by_exprs_values = "logcounts", colour_by="ManualAnno_L0", text_by="ManualAnno_L0")+ ggtitle("UMAP Celllabel")
```


## Set the Final Celllabels

```{r}
## Set Celltypes to use downstream as colLabels
colLabels(sce) <- colData(sce)$ManualAnno_L1
sce$celltype <- colData(sce)$ManualAnno_L1

```

## Plot the assigned Cell labels

```{r}
plotReducedDim(sce, dimred="MNN_UMAP", by_exprs_values = "logcounts", colour_by= "celltype")+ ggtitle("UMAP Celllabel")

```


## Plot Selected Markergenes 

```{r PlotHeatmap}
#Heatmap of Marker Gened used for Annotation
#Endo "PECAM1", "CDH5"
#Myeloid "CD14","FCGR3A"
#Bcell "CD19","MS4A1","CD79A"
#Plasma "SDC1","MZB1"
#Tcell "CD3E", "CD3G"
#Mast "KIT","IL1RL1","MS4A2"
#Fibroblast "PDGFRB","DCN","COL1A1"
#Neutrophil "CSF3R","S100A8","TREM1"
#pDC
#SMC

markers <- c("PDGFRB","DCN","COL1A1","PECAM1", "CDH5","CD14","FCGR3A","CD19","MS4A1","CD79A","SDC1","MZB1","CD3E", "CD3G","KIT","MS4A2","CSF3R","S100A8","TREM1")



# To avoid a too big plot we only keep every 20th cell
sce.plot <- sce[unique(top5DEgenes), seq(1, dim(sce)[2], 20)]
dittoHeatmap(sce.plot, vars = unique(top5DEgenes), annot.by = c("cluster"),scaled.to.max = TRUE,cluster_rows=FALSE,cluster_cols=TRUE, heatmap.colors.max.scaled = inferno(100) )


#Dotplot
dittoDotPlot(sce, vars = markers , group.by = "label",min.color="lightgrey", max.color="blue",min.percent=0.2,max.percent=1,scale = TRUE )

rm(sce.marker,sce.plot,column_annotations,markers_wilcox_up)
gc()
```


## Frequencies of celltypes in clusters per Sample {.tabset}

```{r ClusterInfo}
ClusterInfo <- as.data.frame(colData(sce)) %>% 
  group_by(celltype, Sample) %>%
  summarise(cells = n(),.groups = 'drop') 
```

### Absolute comparison

```{r PlotAbsoluteClustering}

ggplot(data=ClusterInfo, aes(x=Sample,y=cells, fill=celltype)) +
  geom_bar(stat="identity", position="stack") +
  labs(title="Absolute comparison nr Cells in Celltype",subtitle="Per Sample",x="",y="Number of cells")+
  theme(axis.text.x = element_text(angle = 45,hjust=1), axis.ticks.x=element_blank())

```

### Relative comparison

```{r PlotRelativeClustering}

ggplot(data=ClusterInfo,aes(x=Sample, y=cells, fill=celltype)) +
  geom_bar(stat="identity", position="fill") +
  labs(title="Relative comparison nr Cells in celltype",subtitle="Per Sample",x="",y="Number of cells")+
  theme(axis.text.x = element_text(angle = 45,hjust=1), axis.ticks.x=element_blank())


```

## Identify Marker Genes for Annotation


### Wilcoxon rank-sum test on Cluster

```{r AnnoMarker}

for (labeling in c('ManualAnno_L0','ManualAnno_L1')){
  #Wilcoxon rank-sum test
  markers_wilcox <- wilcoxauc(sce, group_by=labeling, assay = 'logcounts')
  # Get the top 50 markers for each Anno (save in excel file)
  # filter for nominally significant (p<0.05) and over-expressed (auc>0.5)
  topDEgenes <- top_markers(markers_wilcox, n = 50, auc_min = 0.5, pval_max = 0.05)
  
  wb = createWorkbook()
  for (i in 1:max(as.integer(levels(sce$paste0(labeling))))){
    #get genes for the Anno
    markers<-topDEgenes_L0[,paste0(i), drop=TRUE]
    #Create table
    tmp<-markers_wilcox_L0[markers_wilcox_L0$feature %in% markers & markers_wilcox_L0$group == i,]
    
    #Save table in Exelsheet
    addDataFrame(tmp, sheet=createSheet(wb, paste0(i)), startColumn=1, row.names=TRUE,col.names = TRUE)
  }
  saveWorkbook(wb,paste0( path , "/output/",paste0(labeling),"_Wilcoxon.xlsx"))  
  
  
}



------------------------------------
#Wilcoxon rank-sum test
markers_wilcox_L0 <- wilcoxauc(sce, group_by='ManualAnno_L0', assay = 'logcounts')
# Get the top 50 markers for each cluster (save in excel file)
# filter for nominally significant (p<0.05) and over-expressed (auc>0.5)
topDEgenes_L0 <- top_markers(markers_wilcox_L0, n = 50, auc_min = 0.5, pval_max = 0.05)

wb = createWorkbook()
for (i in 1:max(as.integer(levels(sce$ManualAnno_L0)))){
  #get genes for the cluster
  markers<-topDEgenes_L0[,paste0(i), drop=TRUE]
  #Create table
  tmp<-markers_wilcox_L0[markers_wilcox_L0$feature %in% markers & markers_wilcox_L0$group == i,]
  
  #Save table in Exelsheet
  addDataFrame(tmp, sheet=createSheet(wb, paste0(i)), startColumn=1, row.names=TRUE,col.names = TRUE)
}
saveWorkbook(wb,paste0( path , "/output/Annotated_L0_Wilcoxon.xlsx"))




markers_wilcox_L1 <- wilcoxauc(sce, group_by='ManualAnno_L1', assay = 'logcounts')
# Get the top 50 markers for each ManualAnno_L1 (save in excel file)
# filter for nominally significant (p<0.05) and over-expressed (auc>0.5)
topDEgenes_L1 <- top_markers(markers_wilcox_L1, n = 50, auc_min = 0.5, pval_max = 0.05)

wb = createWorkbook()
for (i in 1:max(as.integer(levels(sce$ManualAnno_L1)))){
  #get genes for the ManualAnno_L1
  markers<-top50DEgenes[,paste0(i), drop=TRUE]
  #Create table
  tmp<-markers_wilcox_L1[markers_wilcox_L1$feature %in% markers & markers_wilcox_L1$group == i,]
  
  #Save table in Exelsheet
  addDataFrame(tmp, sheet=createSheet(wb, paste0(i)), startColumn=1, row.names=TRUE,col.names = TRUE)
}
saveWorkbook(wb,paste0( path , "/output/Annotated_L1_Wilcoxon.xlsx"))
```





## Save the dataset

```{r SaveData}
saveRDS(sce, file =paste0(path,'/output/05_sce_CelltypeAnnotation.rdss'))
```
