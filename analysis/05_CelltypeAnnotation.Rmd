---
title: "Marker Genes and Celltype Annotation"
subtitle: "05_CelltypeAnnotation"
author: "SarahL."
date: "`r format(Sys.time(), '%b %e %Y %H:%M:%S')`"
output: 
  html_document:
    toc: true
    number_sections: true   
    toc_float: true
    code_folding: hide
    df_print: paged
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(cache = FALSE, cache.lazy = FALSE)
knitr::opts_chunk$set(dpi = 300, fig.align = "center")
knitr::opts_chunk$set(out.width = "100%", out.height = "100%")
```


# Marker Genes and Celltype Annotation

## Setup

### Load Packages

```{r LoadPackages, warning=FALSE}
#Load Packages

suppressPackageStartupMessages({
library(BiocParallel)
library(ggplot2)
library(dplyr)
library(scran)
library(scater)
library(scuttle)
library(dittoSeq)
library(pheatmap)
library(xlsx)
library(GSEABase)
library(gridExtra)
})

```

### Set Parameter

```{r Setup}
set.seed(100)
bpp <- BiocParallel::MulticoreParam(parallel::detectCores()-1)
path <- here::here()
```


## Load Data

```{r LoadDataset}
## RA DATASET
sce <- readRDS(file = paste0(path,'/output/04_sce_Clustering.rds'))

```

### Change Rownames to the Symbol

```{r ChangeRownames}
#Change to genesymbol whenever possible
rowData(sce)$UniqID <-rownames(sce)
rownames(sce) <- uniquifyFeatureNames(rowData(sce)$ID, rowData(sce)$Symbol)
rowData(sce)
```


### Explore Dataset

```{r ShowDim}
#Dimensions of count matrix
dim(sce)
```


## Plot Clustering and QC {.tabset}

### PCA

```{r PlotClusterPCA}
plotReducedDim(sce, dimred="MNN", colour_by="leiden",text_by="cluster") + ggtitle("UMAP with cluster label")
```

### UMAP

```{r PlotClusterUMAP}
plotReducedDim(sce, dimred="MNN_UMAP", colour_by="leiden",text_by="cluster") + ggtitle("UMAP with cluster label")
```

### QC UMAPs

```{r PlotClusterQCUMAP}
p1 <- plotReducedDim(sce, dimred="MNN_UMAP", colour_by="subsets_Mito_percent") + ggtitle("Mitochondrial Genes")
p2 <- plotReducedDim(sce, dimred="MNN_UMAP", colour_by="detected") + ggtitle("Number of detected Genes ")
p3 <- plotReducedDim(sce, dimred="MNN_UMAP", colour_by="sum") + ggtitle("Sum of UMI Counts in Cell")
grid.arrange(p1, p2, p3, nrow = 1)
rm(p1, p2, p3)
```


## Identify Marker Genes

### Wilcoxon rank-sum test

```{r IdentifyMarker}
#Select the hvg
sce.marker <- sce[rowData(sce)$is_hvg==TRUE,]
rownames(sce.marker) <- rowData(sce.marker)$Symbol

#Wilcoxon rank-sum test
markers_wilcox_up <- findMarkers(sce.marker, groups = sce$cluster, block = sce$Sample, direction = "up")

```

```{r SaveTopMarker}
#Dataset for heatmap of top marker genes of each cluster by Wilcoxon rank-sum 
top5DEgenes <-do.call("rbind",lapply(markers_wilcox_up, function(x) { x[ order(x$Top, decreasing = FALSE),][1:5,1:4]}))

#Create Excel file with top 50 for each cluster
wb = createWorkbook()
for (i in 1:length(markers_wilcox_up)){
  tmp<-markers_wilcox_up[[i]]
  #Save in Exelsheet
  addDataFrame(tmp[order(tmp$Top , decreasing = FALSE),][1:50,1:4], sheet=createSheet(wb, paste0("Cluster ", i)), startColumn=1, row.names=TRUE,col.names = TRUE)
}
saveWorkbook(wb,paste0( path , "/output/Cluster_Marker_Genes.xlsx"))

#Show top 5 DE Genes of each cluster
data.frame(top5DEgenes)

```

### Wilcoxon heatmap

```{r PlotHeatmap}
#Heatmap of top marker genes of each cluster by Wilcoxon rank-sum 

#Get most meaningful markers
top_genes_wilcox <- lapply(markers_wilcox_up, function(marker_set){
  marker_set %>%
  as.data.frame() %>%
  filter(Top <= 1) %>%
  arrange(p.value)%>%
  dplyr::slice(1:2)%>%
  rownames()
}) %>% 
  unlist(use.names=F) %>% 
  unique()


# To avoid a too big plot we only keep every 10th cell
sce.plot <- sce.marker[top_genes_wilcox, seq(1, dim(sce.marker)[2], 20)]
# We sort by cluster
sce.plot <- sce.plot[,order(sce.plot$label)]
# Anotations
column_annotations <- data.frame("Cluster"=factor(sce.plot$label), row.names=colnames(sce.plot))
# clip heatmap values to ensure that colour contrast is high
sce.plot <- assay(sce.plot, "logcounts")
sce.plot[sce.plot >=3] = 3

pheatmap(sce.plot, annotation_col=column_annotations,
         show_rownames=TRUE,cluster_rows=FALSE, show_colnames=FALSE, cluster_cols=FALSE)

dittoDotPlot(sce.marker, vars = top_genes_wilcox , group.by = "label",min.color="white", max.color="red")

rm(sce.marker,sce.plot,column_annotations,markers_wilcox_up)

```

## Celltype Annotation Using existing references

### Using existing references using SingleR and Human CellAtlas

```{r CreateReference}
library(celldex)
ref <- HumanPrimaryCellAtlasData()
ref

library(SingleR)
pred <- SingleR(test=sce, ref=ref, labels=ref$label.main)
table(pred$labels)

```

```{r PlotScoreHeatmap}
plotScoreHeatmap(pred)
```

```{r PlotTables}
tab <- table(Assigned=pred$pruned.labels, Cluster=colLabels(sce))

# Adding a pseudo-count of 10 to avoid strong color jumps with just 1 cell.
pheatmap(log2(tab+10), color=colorRampPalette(c("white", "blue"))(101))
```

## Assigning cell labels automatically from gene sets signatures

### Anno with AUCell using marker gene signatures from expected celltypes in literature and panglaoDB


```{r CreateGenesets}
# Manually Create Possible Genesets for expected cells in synovium 

Macrophage.geneset = GeneSet(c("LYZ", "AIF1", "IFI30", "MARCO"), setName="Macrophage")
Fibroblast.geneset = GeneSet(c("COL1A1", "DCN", "COL1A2", "COL13A1"), setName="Fibroblast")
BCell.geneset = GeneSet(c("CD79A", "IGKC", "MS4A1", "IGHM"), setName="BCell")
TCell.geneset = GeneSet(c("IL32", "CD3D", "TRBC2", "CD52"), setName="TCell")
Endothelial.geneset = GeneSet(c("PECAM1", "VWF", "CCL14", "ACKR1"), setName="Endothelial")
LiningFibroblast.geneset = GeneSet(c("PRG4", "CRTAC1", "CLU", "ITGBL1"), setName="LiningFibroblast")
Neutrophils.geneset = GeneSet(c("G0S2", "S100A8", "FCGR3B", "CXCL8"), setName="Neutrophils")
SmoothMuscle.geneset = GeneSet(c("ACTA2", "TAGLN", "MYL9", "TPM2"), setName="SmoothMuscle")
PlasmaCell.geneset = GeneSet(c("IGHG1", "IGHG3", "IGKC", "MZB1"), setName="PlasmaCell")
MastCell.geneset = GeneSet(c("TPSB2", "TBSAB1", "CPA3", "HPGD"), setName="MastCell")
ProliferatingCell.geneset = GeneSet(c("STMN1", "MKI67", "CENPF", "HMGB2"), setName="ProliferatingCell")
PlasmacytoidDC.geneset = GeneSet(c("GZMB", "CLEC4C", "LRRC26", "LILRA4"), setName="PlasmacytoidDC")
PlasmacytoidDC.geneset = GeneSet(c("FLT3", "UPK3A", "CLEC9A", "CCL22"), setName="ConventionalDC")
LymphaticEndothelial.geneset = GeneSet(c("PROX1", "LYVE1", "CCL21", "TFF3"), setName="LymphaticEndothelial")


# Create the Collection
all.sets = GeneSetCollection(c(Macrophage.geneset, Fibroblast.geneset, BCell.geneset, TCell.geneset, Endothelial.geneset, LiningFibroblast.geneset, Neutrophils.geneset, SmoothMuscle.geneset, PlasmaCell.geneset, MastCell.geneset, ProliferatingCell.geneset, PlasmacytoidDC.geneset, LymphaticEndothelial.geneset))

```

```{r RunAUCell, eval=FALSE}
# Annotate genesets using AUCell
library(AUCell)
rankings <- AUCell_buildRankings(counts(sce),
    plotStats=FALSE, verbose=FALSE,BPPARAM = bpp)
cell.aucs <- AUCell_calcAUC(all.sets, rankings)
results <- t(assay(cell.aucs))
head(results)

#AUCell_exploreThresholds(cell.aucs, plotHist=TRUE, assign=TRUE) 
cells_assignment<-AUCell_exploreThresholds(cell.aucs, plotHist=FALSE, assign=TRUE) 
```

```{r PlotAUCellAnno, eval=FALSE}
dataauc <- getAUC(cell.aucs)
AUCannotations = apply(dataauc, 2, function(x){names(which.max(x))})

colData(sce)$AUCellAnno = unname(AUCannotations)

plotReducedDim(sce, dimred="MNN_UMAP", by_exprs_values = "logcounts", colour_by="AUCellAnno")+ ggtitle("UMAP Celllabel")
plotReducedDim(sce, dimred="MNN_UMAP", by_exprs_values = "logcounts", colour_by="AUCellAnno", text_by="AUCellAnno")+ ggtitle("UMAP Celllabel")
```

## Manual Celltype annotation

```{r VizGenExFunction}
#Function to visuaise gene Expression for vector of genes
VizGenEx <- function(markr){
 
  for(i in markr){
  
    cat(paste0("#### ", i, "\n"))
  
    print(gridExtra::grid.arrange(plotReducedDim(sce, dimred = "MNN_UMAP", colour_by = i, text_by = "cluster"),plotReducedDim(sce, dimred = "MNN_UMAP", colour_by = i, order_by=i ) +scale_colour_gradient(name = i,low = "lightgrey", high = "red"),plotExpression(sce, features = i, x = "cluster")),layout_matrix = matrix(c(1, 3, 2, 3), nrow=2))
    cat(' \n \n')
  
  }

     
}

```


### Major cell type Annotation - Level0

Identify major cell types for a Rough Annotation on high hierarchical level

### Lymphocyte {.tabset}

```{r LymphocyteL0}
#VizGenEx(c("PTPRC","CORO1A","RAC2"))  
markr<-c("PTPRC","CORO1A","RAC2")
for(i in markr){
  
  cat(paste0("#### ", i, "\n"))
  print(plotReducedDim(sce, dimred = "MNN_UMAP", colour_by = i, text_by = "cluster"))
  cat(' \n \n')
  
  }
```

### Myeloid {.tabset}

```{r MyeloidL0}

VizGenEx(c("CSF3R","MS4A6A","MS4A7"))  

```

#### Fibroblast {.tabset}

```{r FibroblastL0}

VizGenEx(c("PDGFRB","DCN","PCOLCE","ACTA2")) 

```

#### Endothelial {.tabset}

```{r EndothelialL0}

VizGenEx(c("CDH5","ECSCR","CCL14")) 

```

```{r AssignementL0}
#Manual Annotation
sce$ManualAnno_L0 <- as.integer(sce$cluster)
unique(sce$ManualAnno_L0)

sce$ManualAnno_L0[sce$cluster %in% c(5,9,10,11,14,16,17,20)] <- "Lymphocyte"
sce$ManualAnno_L0[sce$cluster %in% c(4,7,8,13,18,21)] <- "Myeloid"
sce$ManualAnno_L0[sce$cluster %in% c(2,3,12,15)] <- "Stromal"
sce$ManualAnno_L0[sce$cluster %in% c(1,6,19)] <- "Endothelial"

```

### Finer cell type Annotation - Level1

Identify cell types for a finer grained Annotation on lower hierarchical level

#### Macrophage {.tabset}

```{r MacrophageL1}

VizGenEx(c("MARCO","LYZ","MSR1")) 

```


#### Fibroblast {.tabset}

```{r FibroblastL1}

VizGenEx(c("PDGFRB","DCN","COL1A1")) 

```

#### Lining Fibroblast {.tabset}

```{r LiningFibroblastL1}

VizGenEx(c("PRG4","CRTAC1", "CLU")) 

```

#### Endothelial {.tabset}

```{r EndothelialL1}

VizGenEx(c("CDH5","VWF", "PECAM1","CCL14"))

```

#### Lymphatic Endothelial {.tabset}

```{r LymphaticEndothelialL1}

VizGenEx(c("PROX1","LYVE1", "CCL21"))

```

#### BCell {.tabset}

```{r BCellL1}

VizGenEx(c("CD19","MS4A1", "TNFRSF13C"))

```

#### Plasma {.tabset}

```{r PlasmaL1}

VizGenEx(c("JSRP1","DERL3", "JCHAIN"))

```

#### Tcell {.tabset}

```{r TcellL1} 
 
VizGenEx(c("CD3E","CD3D", "CD3G","TRAC"))

```

#### Smooth muscle cell {.tabset}

```{r SMCL1}

VizGenEx(c("ACTA2","MYL9", "DES", "MYH11"))

```

#### Mastcell {.tabset}

```{r MastcellL1}

VizGenEx(c("TPSAB1","CPA3","HPGDS","VWA5A"))

```

#### Neutrophil {.tabset}

```{r NeutrophilL1}

VizGenEx(c("CSF3R","S100A8","TREM1"))
  
```

#### Plasmacytoid dendritic cell {.tabset}

```{r pDCL1}

VizGenEx(c("PTPRC","CLEC4C","LILRA4","LRRC26"))

```


```{r AssignementL1}
#Manual Annotation

sce$ManualAnno_L1 <- as.integer(sce$cluster)
unique(sce$ManualAnno_L1)

sce$ManualAnno_L1[sce$cluster %in% c(2,3,12)] <- "Fibroblast"
sce$ManualAnno_L1[sce$cluster %in% c(15)] <- "Smooth muscle cell"
sce$ManualAnno_L1[sce$cluster %in% c(1,6,19)] <- "Edothelial cell"
sce$ManualAnno_L1[sce$cluster %in% c(9,10,11,14)] <- "Tcell"
sce$ManualAnno_L1[sce$cluster %in% c(17)] <- "Bcell"
sce$ManualAnno_L1[sce$cluster %in% c(20)] <- "Neutrophil"
sce$ManualAnno_L1[sce$cluster %in% c(16)] <- "Mast cell"
sce$ManualAnno_L1[sce$cluster %in% c(4,7,8,18,21)] <- "Macrophage"
sce$ManualAnno_L1[sce$cluster %in% c(5)] <- "Plasma"
sce$ManualAnno_L1[sce$cluster %in% c(13)] <- "plasmacytoid dendritic cell"
```

```{r AssignementCheck}
#Check if all clusters assigned
unique(sce$ManualAnno_L0)
unique(sce$ManualAnno_L1)
```

#### Plot Assigned Celltypes {.tabset}

##### UMAP L0

```{r PlotL0}
#Plot manual Annotation
plotReducedDim(sce, dimred="MNN_UMAP", by_exprs_values = "logcounts", colour_by="ManualAnno_L0")+ ggtitle("UMAP Celllabel")
plotReducedDim(sce, dimred="MNN_UMAP", by_exprs_values = "logcounts", colour_by="ManualAnno_L0", text_by="ManualAnno_L0")+ ggtitle("UMAP Celllabel")
```

##### UMAP L1

```{r PlotL1}
#Plot manual Annotation
plotReducedDim(sce, dimred="MNN_UMAP", by_exprs_values = "logcounts", colour_by="ManualAnno_L1")+ ggtitle("UMAP Celllabel")
plotReducedDim(sce, dimred="MNN_UMAP", by_exprs_values = "logcounts", colour_by="ManualAnno_L1", text_by="ManualAnno_L1")+ ggtitle("UMAP Celllabel")
```

## Set the Final Celllabels

```{r}
## Set Celltypes to use downstream as colLabels

colLabels(sce) <- colData(sce)$AUCellanno
colLabels(sce) <- colData(sce)$ManualAnno
colLabels(sce) <- colData(sce)$ManualAnno_L1

sce$celltype <- colData(sce)$ManualAnno_L1

```

## Plot the assigned Cell labels

```{r}
plotReducedDim(sce, dimred="MNN_UMAP", by_exprs_values = "logcounts", colour_by= "celltype")+ ggtitle("UMAP Celllabel")

```

## Frequencies of celltypes in clusters per Sample {.tabset}

```{r ClusterInfo}
ClusterInfo <- as.data.frame(colData(sce)) %>% 
  group_by(celltype, Sample) %>%
  summarise(cells = n(),.groups = 'drop') 
```

### Absolute comparison

```{r PlotAbsoluteClustering}

ggplot(data=ClusterInfo, aes(x=Sample,y=cells, fill=celltype)) +
  geom_bar(stat="identity", position="stack") +
  labs(title="Absolute comparison nr Cells in Celltype",subtitle="Per Sample",x="",y="Number of cells")+
  theme(axis.text.x = element_text(angle = 45,hjust=1), axis.ticks.x=element_blank())

```

### Relative comparison

```{r PlotRelativeClustering}

ggplot(data=ClusterInfo,aes(x=Sample, y=cells, fill=celltype)) +
  geom_bar(stat="identity", position="fill") +
  labs(title="Relative comparison nr Cells in celltype",subtitle="Per Sample",x="",y="Number of cells")+
  theme(axis.text.x = element_text(angle = 45,hjust=1), axis.ticks.x=element_blank())


```

## Save the dataset

```{r SaveData}
saveRDS(sce, file =paste0(path,'/output/05_CelltypeAnnotation'))
```
