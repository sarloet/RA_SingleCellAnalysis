---
title: "Clustering"
subtitle: "04_Clustering"
author: "SarahL."
date: "`r format(Sys.time(), '%b %e %Y %H:%M:%S')`"
output: 
  html_document:
    toc: true
    number_sections: true   
    toc_float: true
    code_folding: hide
    df_print: paged
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Clustering

## Setup

### Load Packages

```{r LoadPackages, warning=FALSE}
#Load Packages

suppressPackageStartupMessages({
library(BiocParallel)
library(ggplot2)
library(dplyr)
library(scater)
library(scran)
library(batchelor)
library(reticulate)
library(bluster)
})

```

### Set Parameter

```{r Setup}
set.seed(100)
bpp <- BiocParallel::MulticoreParam(parallel::detectCores()-1)
path <- here::here()
```


## Load Data

```{r LoadDataset}
## RA DATASET
sce <- readRDS(file = paste0(path,'/output/03_sce_Integration_Batchelor.rds'))

```


### Explore Dataset

```{r ShowDim}
#Dimensions of count matrix
dim(sce)
```

## Clustering

### Louvain Clustering

```{r}
#Setup Hierarchical Clustering -use the bluster package

#colData(sce.)$louvain <- clusterRows(reducedDim(sce, "MNN"),TwoStepParam(KmeansParam(centers=1000), NNGraphParam(k=5,cluster.fun="louvain")))
colData(sce)$louvain <- clusterCells(sce, use.dimred = "MNN", BLUSPARAM = SNNGraphParam(k=15,cluster.fun="louvain",BPPARAM =bpp))

table(colData(sce)$louvain)


```


```{r}
plotReducedDim(sce, dimred="MNN", colour_by="louvain",text_by="louvain") + ggtitle("UMAP with louvain clusters")
plotReducedDim(sce, dimred="MNN_UMAP", colour_by="louvain",text_by="louvain") + ggtitle("UMAP with louvain clusters")
```

```{r}
## Silhouette plot

sil.approx <- approxSilhouette(reducedDim(sce, "MNN"), clusters=colData(sce)$louvain)
sil.approx

sil.data <- as.data.frame(sil.approx)
sil.data$closest <- factor(ifelse(sil.data$width > 0, colData(sce)$louvain, sil.data$other))
sil.data$cluster <- colData(sce)$louvain

ggplot(sil.data, aes(x=cluster, y=width, colour=closest)) +ggbeeswarm::geom_quasirandom(method="smiley")+ggtitle("Silhouette plot Louvain Clustering")+theme_bw()


```

### Leiden Clustering

```{r}
#Setup Hierarchical Clustering
#use the bluster package

#colData(sce.BatchR)$leiden <- clusterRows(reducedDim(sce.BatchR, "MNN"),TwoStepParam(KmeansParam(centers=100), NNGraphParam(k=5,cluster.fun="leiden")))
colData(sce)$leiden <- clusterCells(sce, use.dimred = "MNN", BLUSPARAM = SNNGraphParam(k=40,cluster.fun="leiden",BPPARAM =bpp))


table(colData(sce)$leiden)


```

```{r}
plotReducedDim(sce, dimred="MNN", colour_by="leiden",text_by="leiden") + ggtitle("UMAP with leiden clusters")
plotReducedDim(sce, dimred="MNN_UMAP", colour_by="leiden",text_by="leiden") + ggtitle("UMAP with leiden clusters")
```

```{r}
## Silhouette plot

sil.approx <- approxSilhouette(reducedDim(sce, "MNN"), clusters=colData(sce)$leiden)
sil.approx

sil.data <- as.data.frame(sil.approx)
sil.data$closest <- factor(ifelse(sil.data$width > 0, colData(sce)$leiden, sil.data$other))
sil.data$cluster <- colData(sce)$leiden

ggplot(sil.data, aes(x=cluster, y=width, colour=closest)) +ggbeeswarm::geom_quasirandom(method="smiley")+ggtitle("Silhouette plot leiden Clustering")+theme_bw()
  

```

### Walktrap Clustering

```{r}
#Setup Hierarchical Clustering
#use the bluster package

#colData(sce.BatchR)$walktrap <- clusterRows(reducedDim(sce.BatchR, "MNN"),TwoStepParam(KmeansParam(centers=100), NNGraphParam(k=2,cluster.fun="walktrap")))
colData(sce)$walktrap <- clusterCells(sce, use.dimred = "MNN", BLUSPARAM = SNNGraphParam(k=20,cluster.fun="walktrap", BPPARAM=bpp))


table(colData(sce)$walktrap)


```

```{r}
plotReducedDim(sce, dimred="MNN", colour_by="walktrap",text_by="walktrap") + ggtitle("PCA with walktrap clusters")
plotReducedDim(sce, dimred="MNN_UMAP", colour_by="walktrap",text_by="walktrap") + ggtitle("UMAP with walktrap clusters")
```

```{r}
## Silhouette plot

sil.approx <- approxSilhouette(reducedDim(sce, "MNN"), clusters=colData(sce)$walktrap)
sil.approx

sil.data <- as.data.frame(sil.approx)
sil.data$closest <- factor(ifelse(sil.data$width > 0, colData(sce)$walktrap, sil.data$other))
sil.data$cluster <- colData(sce)$walktrap

ggplot(sil.data, aes(x=cluster, y=width, colour=closest)) +ggbeeswarm::geom_quasirandom(method="smiley")+ggtitle("Silhouette plot leiden Clustering")+theme_bw()
  

```


## Clustering Plots

```{r}
methods <- c("louvain","leiden","walktrap")
methods <- c("louvain","leiden")
```

### PCA Plots   {.tabset}

```{r}
for (i in methods){
  cat(paste0("###  ",i, "\n"))
  plotReducedDim(sce, dimred="MNN", colour_by=i ,text_by=i) + ggtitle(paste0("PCA with ",i," clusters"))
  }
```

### UMAP Plots   {.tabset}

```{r}
for (i in methods){
  cat(paste0("###  ", i, "\n"))
  plotReducedDim(sce, dimred="MNN_UMAP", colour_by=i,text_by=i) + ggtitle(paste0("UMAP with ",i," clusters"))
  }
```

### Silhouette Plots   {.tabset}

```{r}
for (i in methods){
  cat(paste0("###  ", i, "\n"))
  
  ## Silhouette plot
  sil.approx <- approxSilhouette(reducedDim(sce, "MNN"), clusters=colData(sce)[,i])
  
  sil.data <- as.data.frame(sil.approx)
  sil.data$closest <- factor(ifelse(sil.data$width > 0, colData(sce)[,i], sil.data$other))
  sil.data$cluster <- colData(sce)[,i]
  
  ggplot(sil.data, aes(x=cluster, y=width, colour=closest)) +ggbeeswarm::geom_quasirandom(method="smiley")+ggtitle(paste0("Silhouette plot ",i," Clustering"))+theme_bw()
  
  }
```

### Barplots Plots Absolute Cell Counts   {.tabset}

```{r}
for (i in methods){
  cat(paste0("###  ", i, "\n"))
  
ClusterInfo <- as.data.frame(colData(sce)) %>% 
  group_by_at(c(i, "Sample")) %>%
  summarise(cells = n(),.groups = 'drop') 


ggplot(data=ClusterInfo, aes_string(x="Sample",y="cells", fill=i)) +
  geom_bar(stat="identity", position="stack") +
  labs(title="Absolute comparison nr Cells in Cluster",subtitle="Per Sample",x="",y="Number of cells")

  }
```

### Barplots Plots Relative Cell Counts   {.tabset}

```{r}
for (i in methods){
  cat(paste0("###  ", i, "\n"))
  
ClusterInfo <- as.data.frame(colData(sce)) %>% 
  group_by_at(c(i, "Sample")) %>%
  summarise(cells = n(),.groups = 'drop') 

ggplot(data=ClusterInfo,aes_string(x="Sample",y="cells", fill=i)) +
  geom_bar(stat="identity", position="fill") +
  labs(title="Relative comparison nr Cells in Cluster",subtitle="Per Sample",x="",y="Number of cells")


  }
```

## Set clustering to use downstream

```{r}
## Set main clustering for downstream use also as colLabels
##leiden or louvain or walktrap

colData(sce)$cluster<- colData(sce)$leiden
colLabels(sce)<- colData(sce)$cluster

```

## Frequencies of cells in clusters per Sample

```{r}
ClusterInfo <- as.data.frame(colData(sce)) %>% 
  group_by(cluster, Sample) %>%
  summarise(cells = n(),.groups = 'drop') 

ggplot(data=ClusterInfo, aes(x=Sample,y=cells, fill=cluster)) +
  geom_bar(stat="identity", position="stack") +
  labs(title="Absolute comparison nr Cells in Cluster",subtitle="Per Sample",x="",y="Number of cells")



ggplot(data=ClusterInfo,aes(x=Sample, y=cells, fill=cluster)) +
  geom_bar(stat="identity", position="fill") +
  labs(title="Relative comparison nr Cells in Cluster",subtitle="Per Sample",x="",y="Number of cells")


```


## Save the dataset

```{r SaveData}
saveRDS(sce.filtered, file =paste0(path,'/output/04_sce_Clustering.rds'))
```
