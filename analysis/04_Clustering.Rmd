---
title: "Clustering"
subtitle: "04_Clustering"
author: "SarahL."
date: "`r format(Sys.time(), '%b %e %Y %H:%M:%S')`"
output: 
  html_document:
    toc: true
    number_sections: true   
    toc_float: true
    code_folding: hide
    df_print: paged
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(cache = FALSE, cache.lazy = FALSE)
knitr::opts_chunk$set(dpi = 300, fig.align = "center")
knitr::opts_chunk$set(out.width = "100%", out.height = "100%")
```


# Clustering

## Setup

### Load Packages

```{r LoadPackages, warning=FALSE}
#Load Packages

suppressPackageStartupMessages({
library(BiocParallel)
library(ggplot2)
library(dplyr)
library(scater)
library(scran)
library(batchelor)
library(reticulate)
library(bluster)
})

```

### Set Parameter

```{r Setup}
set.seed(100)
bpp <- BiocParallel::MulticoreParam(parallel::detectCores()-1, RNGseed=100)
path <- here::here()
```


## Load Data

```{r LoadDataset}
## RA DATASET
sce <- readRDS(file = paste0(path,'/output/03_sce_Integration_Batchelor.rds'))
sce.cluster <- sce
```


### Explore Dataset

```{r ShowDim}
#Dimensions of count matrix
dim(sce.cluster)
```

## Clustering

### Louvain Clustering

```{r Louvain}
#Setup Hierarchical Clustering -use the bluster package

#colData(sce.)$louvain <- clusterRows(reducedDim(sce, "MNN"),TwoStepParam(KmeansParam(centers=1000), NNGraphParam(k=5,cluster.fun="louvain")))
colData(sce.cluster)$louvain <- clusterCells(sce.cluster, use.dimred = "MNN", BLUSPARAM = SNNGraphParam(k=15,cluster.fun="louvain",BPPARAM =bpp, cluster.args=list(resolution=0.5)))

data.frame(as.list(table(colData(sce.cluster)$louvain)))

```


### Leiden Clustering

```{r Leiden}
#Setup Hierarchical Clustering
#use the bluster package

#colData(sce)$leiden <- clusterRows(reducedDim(sce, "MNN"),TwoStepParam(KmeansParam(centers=1000 , nstart = 10, iter.max = 100), NNGraphParam(k=15,cluster.fun="leiden",BPPARAM =bpp)))
colData(sce.cluster)$leiden <- clusterCells(sce.cluster, use.dimred = "MNN", BLUSPARAM = SNNGraphParam(k=50,cluster.fun="leiden",BPPARAM =bpp,cluster.args=list(resolution=0.5)))


data.frame(as.list(table(colData(sce.cluster)$leiden)))


```


### Walktrap Clustering

```{r Walktrap}
#Setup Hierarchical Clustering
#use the bluster package

colData(sce.cluster)$walktrap <- clusterRows(reducedDim(sce.cluster, "MNN"),TwoStepParam(KmeansParam(centers=10000, nstart = 5, iter.max = 100), NNGraphParam(k=10,cluster.fun="walktrap", BPPARAM=bpp)))
#colData(sce)$walktrap <- clusterCells(sce, use.dimred = "MNN", BLUSPARAM = SNNGraphParam(k=20,cluster.fun="walktrap", BPPARAM=bpp))


data.frame(as.list(table(colData(sce.cluster)$walktrap)))


```


## Clustering Plots

```{r ClusteringPlots}
methods <- c("louvain","leiden","walktrap")
```

### PCA Plots   {.tabset}

```{r PCAPlots ,results = 'asis'}
for (i in methods){
  cat(paste0("#### ",i, "\n"))
  print(
  plotReducedDim(sce.cluster, dimred="MNN", colour_by=i ,text_by=i) + ggtitle(paste0("PCA with ",i," clusters"))
  )
  cat(' \n \n')
  }
```

### UMAP Plots {.tabset}

```{r UMAPPlots ,results = 'asis'}
for (i in methods){
  cat(paste0("#### ", i, "\n"))
  print(
  plotReducedDim(sce.cluster, dimred="MNN_UMAP", colour_by=i,text_by=i) + ggtitle(paste0("UMAP with ",i," clusters"))
  )
  cat(' \n \n')
  }
```

### Silhouette Plots {.tabset}

The silhouette width (so named after the look of the traditional graph for plotting the results) is a measure of how closely related cells within cluster are to one another versus how closely related cells in the cluster are to cells in other clusters. This allows us to assess cluster separation.

```{r SilhouettePlots ,results = 'asis'}
for (i in methods){
  cat(paste0("#### ", i, "\n"))
  
  ## Silhouette plot
  sil.approx <- approxSilhouette(reducedDim(sce.cluster, "MNN"), clusters=colData(sce.cluster)[,i])
  
  sil.data <- as.data.frame(sil.approx)
  sil.data$closest <- factor(ifelse(sil.data$width > 0, colData(sce.cluster)[,i], sil.data$other))
  sil.data$cluster <- colData(sce.cluster)[,i]
  
  print(
  ggplot(sil.data, aes(x=cluster, y=width, colour=closest))+
    ggbeeswarm::geom_quasirandom(method="smiley")+
    ggtitle(paste0("Silhouette plot ",i," Clustering"))+
    theme_bw()
  )
  cat(' \n \n')
  }
```

### Barplots Plots Absolute Cell Counts {.tabset}

Frequencies of cells in clusters per Sample

```{r BarplotAbsolute ,results = 'asis'}
for (i in methods){
  cat(paste0("#### ", i, "\n"))
  
  ClusterInfo <- as.data.frame(colData(sce.cluster)) %>% 
    group_by_at(c(i, "Sample")) %>%
    summarise(cells = n(),.groups = 'drop') 

  print(
  ggplot(data=ClusterInfo, aes_string(x="Sample",y="cells", fill=i)) +
    geom_bar(stat="identity", position="stack") +
    labs(title="Absolute comparison nr Cells in Cluster",subtitle="Per Sample",x="",y="Number of cells")+
    theme(axis.text.x = element_text(angle = 45,hjust=1), axis.ticks.x=element_blank())
  )
  cat(' \n \n')
  }
```

### Barplots Plots Relative Cell Counts {.tabset}

Frequencies of cells in clusters per Sample

```{r BarplotRelative ,results = 'asis'}
for (i in methods){
  cat(paste0("#### ", i, "\n"))
  
  ClusterInfo <- as.data.frame(colData(sce.cluster)) %>% 
    group_by_at(c(i, "Sample")) %>%
    summarise(cells = n(),.groups = 'drop') 
  
  print(
  ggplot(data=ClusterInfo,aes_string(x="Sample",y="cells", fill=i)) +
    geom_bar(stat="identity", position="fill") +
    labs(title="Relative comparison nr Cells in Cluster",subtitle="Per Sample",x="",y="Number of cells")+
    theme(axis.text.x = element_text(angle = 45,hjust=1), axis.ticks.x=element_blank())
  )
  cat(' \n \n')
  }
```

## Set clustering to use downstream {.tabset}

```{r SetClustering}
## Set main clustering for downstream use also as colLabels
##leiden or louvain or walktrap

colData(sce)$cluster<- colData(sce.cluster)$leiden
#Set as collabel
colLabels(sce)<- colData(sce)$cluster

```

### UMAP

```{r UMAPClustering}
plotReducedDim(sce, dimred="MNN_UMAP", colour_by="cluster",text_by="cluster") + ggtitle("UMAP with assigned clusters")
```

### PCA

```{r PCAClustering}
plotReducedDim(sce, dimred="MNN", colour_by="cluster",text_by="cluster") + ggtitle("PCA with assigned clusters")
```


## Frequencies of cells in clusters per Sample {.tabset}

```{r ClusterInfo}
ClusterInfo <- as.data.frame(colData(sce)) %>% 
  group_by(celltype, Sample) %>%
  summarise(cells = n(),.groups = 'drop') 
```

### Absolute comparison

```{r PlotAbsoluteClustering}

ggplot(data=ClusterInfo, aes(x=Sample,y=cells, fill=cluster)) +
  geom_bar(stat="identity", position="stack") +
  labs(title="Absolute comparison nr Cells in Cluster",subtitle="Per Sample",x="",y="Number of cells")+
  theme(axis.text.x = element_text(angle = 45,hjust=1), axis.ticks.x=element_blank())

```

### Relative comparison

```{r PlotRelativeClustering}

ggplot(data=ClusterInfo,aes(x=Sample, y=cells, fill=cluster)) +
  geom_bar(stat="identity", position="fill") +
  labs(title="Relative comparison nr Cells in Cluster",subtitle="Per Sample",x="",y="Number of cells")+
  theme(axis.text.x = element_text(angle = 45,hjust=1), axis.ticks.x=element_blank())


```


## Save the dataset

```{r SaveData}
saveRDS(sce, file =paste0(path,'/output/04_sce_Clustering.rds'))
```
