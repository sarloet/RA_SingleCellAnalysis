---
title: "Batch correction and data set integration"
subtitle: "03_Integration_STACAS"
author: "SarahL."
date: "`r format(Sys.time(), '%b %e %Y %H:%M:%S')`"
output: 
  html_document:
    toc: true
    number_sections: true   
    toc_float: true
    code_folding: hide
    df_print: paged
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Quality Controll and Preprocessing

## Setup

### Load Packages

```{r LoadPackages, warning=FALSE}
#Load Packages

suppressPackageStartupMessages({
library(BiocParallel)
library(ggplot2)
library(dplyr)
library(scran)
library(BiocSingular)
library(scater)
})

```

### Set Parameter

```{r Setup}
set.seed(100)
bpp <- BiocParallel::MulticoreParam(parallel::detectCores()-1)
path <- here::here()
```


## Load Data

```{r LoadDataset}
## RA DATASET
sce.filtered <- readRDS(file = paste0(path,'/output/02_sce_DimensionalityReduction.rds'))

```


### Explore Dataset

```{r ShowDim}
#Dimensions of count matrix
dim(sce)
```

## Pre-Batch Correction Plots {.tabset}
### PCA
```{r}
#Plot UMAP before data integration
plotReducedDim(sce, dimred="PCA", colour_by="Sample")
```
### UMAP
```{r}
#Plot UMAP before data integration
plotReducedDim(sce, dimred="UMAP", colour_by="Sample")
```

## Batch Removal with STACAS

```{r}
#Transform to seurat 
sce.BatchR <- CreateSeuratObject(counts = counts(sce), meta.data = as.data.frame(colData(sce)))
sce.BatchR <- SetAssayData(object = sce.BatchR, layer = "data", new.data = logcounts(sce))

# Set feature metadata, owData. 
#sce.BatchR[["RNA"]][[]] <- as.data.frame(rowData(sce))

```

```{r}
#Transform to seurat 
sce.BatchR <- as.Seurat(sce, counts = "counts", data = "logcounts")
remove("sce")
```

### Batch Removal with STACAS Package

```{r}
#Perform scaling normalization within each batch
object_integrated <- sce.BatchR %>% SplitObject(split.by = "Sample") %>%
      Run.STACAS(dims = 1:12, anchor.features = 3000) %>%
      RunUMAP(dims = 1:ndim)
```

```{r}
#Run UMAP
object_integrated <- runUMAP(object_integrated,dims=1:12)
DimPlot(object_integrated, group.by = "Sample")
```

### QC Plots STACAS

```{r}
#We use the percentage of variance lost as a diagnostic measure:
metadata(sce.Batchelor)$merge.info$lost.var

#Large proportions of lost variance (>10%) suggest that correction is removing genuine biological heterogeneity
```


## PCA Plots after Integration {.tabset}
### Colored by Sample
```{r}
#Plot PCA after data integration
plotReducedDim(sce.BatchR, dimred="MNN", colour_by="Sample") + ggtitle("PCA after data integration with fastMNN")
```
### Colored by Joint
```{r}
#Plot PCA after data integration
plotReducedDim(sce.BatchR, dimred="MNN", colour_by="JointLocation") + ggtitle("PCA after data integration with fastMNN")
```
### Facet by Sample
```{r}
#Plot PCA after data integration per sample
plotReducedDim(sce.BatchR, dimred="MNN", colour_by="Sample") + ggtitle("PCA after data integration with fastMNN")+ facet_wrap(~sce.BatchR$Sample)
```
### Facet by Joint
```{r}
#Plot PCA before data integration per joint
plotReducedDim(sce.BatchR, dimred="MNN", colour_by="JointLocation") + ggtitle("PCA after data integration with fastMNN")+ facet_wrap(~sce.BatchR$JointLocation)
```


## UMAP Plots after Integration {.tabset}

```{r}
#Run UMAP
sce.BatchR <- runUMAP(sce.BatchR ,name = "MNN_UMAP", dimred = "MNN")

```

### Colored by Sample
```{r}
#Plot UMAP after data integration
plotReducedDim(sce.BatchR, dimred="MNN_UMAP", colour_by="Sample") + ggtitle("UMAP after data integration with fastMNN")
```
### Colored by Joint
```{r}
#Plot UMAP after data integration
plotReducedDim(sce.BatchR, dimred="MNN_UMAP", colour_by="JointLocation") + ggtitle("UMAP after data integration with fastMNN")#+ facet_wrap(~sce.filtered$Sample)
```
### Facet by Sample
```{r}
#Plot UMAP before data integration per sample
plotReducedDim(sce.BatchR, dimred="MNN_UMAP", colour_by="Sample") + ggtitle("UMAP after data integration with fastMNN")+ facet_wrap(~sce.BatchR$Sample)
```
### Facet by Joint
```{r}
#Plot UMAP before data integration per joint
plotReducedDim(sce.BatchR, dimred="MNN_UMAP", colour_by="JointLocation") + ggtitle("UMAP after data integration with fastMNN")+ facet_wrap(~sce.BatchR$JointLocation)
```


## Save the dataset

```{r SaveData}
saveRDS(sce.filtered, file =paste0(path,'/output/03_Integration_STACAS'))
```
