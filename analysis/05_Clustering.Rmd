---
title: "Clustering"
subtitle: "05_Clustering"
author: "SarahL."
date: "`r format(Sys.time(), '%b %e %Y %H:%M:%S')`"
output: 
  html_document:
    toc: true
    number_sections: true   
    toc_float: true
    code_folding: hide
    df_print: paged
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
knitr::opts_chunk$set(cache = FALSE, cache.lazy = FALSE)
knitr::opts_chunk$set(dpi = 300, fig.align = "center")
knitr::opts_chunk$set(out.width = "100%", out.height = "100%")
```


# Clustering

## Setup

### Standard packages

```{r LoadPackages, warning=FALSE}
library(here)
source(here("code", "standard_libraries.R"))
```

### Additional Packages

```{r LoadAddPackages, warning=FALSE}
#Load Packages

suppressPackageStartupMessages({
library(reticulate)
library(bluster)
})

```


### Set Parameter

```{r Setup}
set.seed(123)
bpp <- BiocParallel::MulticoreParam(parallel::detectCores()-1, RNGseed=123)
path <- here::here()
```


## Load Data

```{r LoadDataset}
## RA DATASET
sce <- readRDS(file = paste0(path,'/output/04_sce_CellCycle.rds'))
sce.cluster <- sce
```


### Explore Dataset

```{r ShowDim}
#Dimensions of count matrix
dim(sce.cluster)
```

## Clustering

### Louvain Clustering

```{r Louvain}
#Louvain Clustering
set.seed(123)

colData(sce.cluster)$louvain <- clusterCells(sce.cluster, use.dimred = "MNN_reduced", BLUSPARAM = SNNGraphParam(k=15,cluster.fun="louvain",BPPARAM =bpp))
data.frame(as.list(table(colData(sce.cluster)$louvain))) 

```


### Leiden Clustering

```{r Leiden}
#Leiden Clustering
set.seed(123)

colData(sce.cluster)$leiden <- clusterCells(sce.cluster, use.dimred = "MNN_reduced", BLUSPARAM = SNNGraphParam(k=70,cluster.fun="leiden",BPPARAM =bpp))
data.frame(as.list(table(colData(sce.cluster)$leiden)))


```


### Walktrap Clustering

```{r Walktrap}
#Walktrap Clustering

set.seed(123)

colData(sce.cluster)$walktrap <- clusterRows(reducedDim(sce.cluster, "MNN_reduced"),TwoStepParam(KmeansParam(centers=10000, nstart = 5, iter.max = 100), NNGraphParam(k=10,cluster.fun="walktrap",BPPARAM=bpp)))
#colData(sce)$walktrap <- clusterCells(sce, use.dimred = "MNN", BLUSPARAM = SNNGraphParam(k=20,cluster.fun="walktrap", BPPARAM=bpp))
data.frame(as.list(table(colData(sce.cluster)$walktrap)))


```


## Clustering Plots

```{r ClusteringPlots}
methods <- c("louvain","leiden","walktrap")
```

### PCA Plots   {.tabset}

```{r PCAPlots ,results = 'asis'}
for (i in methods){
  cat(paste0("#### ",i, "\n"))
  print(
  plotReducedDim(sce.cluster, dimred="MNN_reduced", colour_by=i ,text_by=i,point_alpha=0.8,point_size=0.1) + 
    ggtitle(paste0("PCA with ",i," clusters"))+
    labs( x='PCA 1', y='PCA 2' )
  )
  cat(' \n \n')
  }
```

### UMAP Plots {.tabset}

```{r UMAPPlots ,results = 'asis'}
for (i in methods){
  cat(paste0("#### ", i, "\n"))
  print(
  plotReducedDim(sce.cluster, dimred="MNN_UMAP_reduced", colour_by=i,text_by=i,point_alpha=0.8,point_size=0.1) + 
    ggtitle(paste0("UMAP with ",i," clusters"))+
    labs( x='UMAP 1', y='UMAP 2' )
  )
  cat(' \n \n')
  }
```

### Silhouette Plots {.tabset}

The silhouette width (so named after the look of the traditional graph for plotting the results) is a measure of how closely related cells within cluster are to one another versus how closely related cells in the cluster are to cells in other clusters. This allows us to assess cluster separation.

```{r SilhouettePlots ,results = 'asis'}
for (i in methods){
  cat(paste0("#### ", i, "\n"))
  
  ## Silhouette plot
  sil.approx <- approxSilhouette(reducedDim(sce.cluster, "MNN_reduced"), clusters=colData(sce.cluster)[,i])
  
  sil.data <- as.data.frame(sil.approx)
  sil.data$closest <- factor(ifelse(sil.data$width > 0, colData(sce.cluster)[,i], sil.data$other))
  sil.data$cluster <- colData(sce.cluster)[,i]
  
  print(
  ggplot(sil.data, aes(x=cluster, y=width, colour=closest))+
    ggbeeswarm::geom_quasirandom(method="smiley")+
    ggtitle(paste0("Silhouette plot ",i," Clustering"))+
    theme_classic() + 
    theme(panel.grid.major.x = element_blank(),panel.grid.minor.x = element_blank())
  )
  cat(' \n \n')
  }
```

### Barplots Plots Absolute Cell Counts {.tabset}

Frequencies of cells in clusters per Sample

```{r BarplotAbsolute ,results = 'asis'}
for (i in methods){
  cat(paste0("#### ", i, "\n"))
  
  ClusterInfo <- as.data.frame(colData(sce.cluster)) %>% 
    group_by_at(c(i, "Sample")) %>%
    summarise(cells = n(),.groups = 'drop') 

  print(
  ggplot(data=ClusterInfo, aes_string(x="Sample",y="cells", fill=i)) +
    geom_bar(stat="identity", position="stack") +
    labs(title="Absolute comparison nr Cells in Cluster",subtitle="Per Sample",x="",y="Number of cells")+
    theme(axis.text.x = element_text(angle = 45,hjust=1), axis.line = element_line(colour = "black"), panel.background = element_rect(fill = NA)) +
    scale_y_continuous(expand = c(0,0))
  )
  cat(' \n \n')
  }
```

### Barplots Plots Relative Cell Counts {.tabset}

Frequencies of cells in clusters per Sample

```{r BarplotRelative ,results = 'asis'}
for (i in methods){
  cat(paste0("#### ", i, "\n"))
  
  ClusterInfo <- as.data.frame(colData(sce.cluster)) %>% 
    group_by_at(c(i, "Sample")) %>%
    summarise(cells = n(),.groups = 'drop') 
  
  print(
  ggplot(data=ClusterInfo,aes_string(x="Sample",y="cells", fill=i)) +
    geom_bar(stat="identity", position="fill") +
    labs(title="Relative comparison nr Cells in Cluster",subtitle="Per Sample",x="",y="Number of cells")+
    theme(axis.text.x = element_text(angle = 45,hjust=1), axis.line = element_line(colour = "black"), panel.background = element_rect(fill = NA))+
    scale_y_continuous(expand = c(0,0)) 
  )
  cat(' \n \n')
  }
```


## Set clustering to use downstream {.tabset}

```{r SetClustering}
## Set main clustering for downstream use also as colLabels
##leiden or louvain or walktrap

colData(sce)$cluster<- colData(sce.cluster)$leiden

#Set as collabel
colLabels(sce)<- colData(sce)$cluster

```

### UMAP

```{r UMAPClustering}
plotReducedDim(sce, dimred="MNN_UMAP_reduced", colour_by="cluster",text_by="cluster",point_alpha=0.8,point_size=1) + 
  ggtitle("UMAP with assigned clusters")+
  labs( x='UMAP 1', y='UMAP 2' )
```

### PCA

```{r PCAClustering}
plotReducedDim(sce, dimred="MNN_reduced", colour_by="cluster",text_by="cluster",point_alpha=0.8,point_size=1) + 
  ggtitle("PCA with assigned clusters")+
  labs( x='PCA 1', y='PCA 2' )
```


## Save the dataset

```{r SaveData}
saveRDS(sce, file =paste0(path,'/output/05_sce_Clustering.rds'))
```


