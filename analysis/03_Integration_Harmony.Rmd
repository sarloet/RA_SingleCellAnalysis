---
title: "Batch correction and data set integration"
subtitle: "03_Integration_Harmony"
author: "SarahL."
date: "`r format(Sys.time(), '%b %e %Y %H:%M:%S')`"
output: 
  html_document:
    toc: true
    number_sections: true   
    toc_float: true
    code_folding: hide
    df_print: paged
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Batch correction and data set integration

## Setup

### Load Packages

```{r LoadPackages, warning=FALSE}
#Load Packages

suppressPackageStartupMessages({
library(BiocParallel)
library(ggplot2)
library(dplyr)
library(scater)
library(scran)
library(batchelor)
library(reticulate)
library(bluster)
})

```

### Set Parameter

```{r Setup}
set.seed(100)
bpp <- BiocParallel::MulticoreParam(parallel::detectCores()-1)
path <- here::here()
```


## Load Data

```{r LoadDataset}
## RA DATASET
sce.filtered <- readRDS(file = paste0(path,'/output/02_sce_DimensionalityReduction.rds'))

```


### Explore Dataset

```{r ShowDim}
#Dimensions of count matrix
dim(sce)
```

## Pre-Batch Correction Plots {.tabset}
### PCA
```{r}
#Plot PCA before data integration
plotReducedDim(sce, dimred="PCA", colour_by="Sample")+ ggtitle("PCA before data integration")
```
### UMAP
```{r}
#Plot UMAP before data integration
plotReducedDim(sce, dimred="UMAP", colour_by="Sample")+ ggtitle("UMAP before data integration")
```


## Batch Removal

```{r}
#Initialize sce element with batch removal
sce.BatchR <- sce 

```

### Batch Removal with Harmony 

```{r}
#Perform scaling normalization within each batch
meta_data <- colData(sce.BatchR) %>%
  as.data.frame() %>%
  dplyr::select(c(Sample)) #Add covariates zb protocol

sce.BatchR <- harmony::RunHarmony(sce.BatchR,group.by.vars=c("Sample"),reduction.save="harmony",verbose=FALSE) #  Add covariates zb protocol
```

```{r}
#Run UMAP
sce.BatchR <- runUMAP(sce.BatchR, dimred="harmony", subset_row=rowData(sce)$is_hvg, min_dist = 0.1, name="harmony_UMAP_extra")
sce.BatchR <- runUMAP(sce.BatchR, dimred="harmony", name="harmony_UMAP")

```

### QC Plots Harmony
We use the percentage of variance lost as a diagnostic measure.Large proportions of lost variance (>10%) suggest that correction is removing genuine biological heterogeneity.
```{r}
# Percentage of variance lost 
metadata(sce.BatchR)$merge.info$lost.var

```

## PCA Plots after Integration {.tabset}
### Colored by Sample
```{r}
#Plot PCA after data integration
plotReducedDim(sce.BatchR, dimred="harmony", colour_by="Sample") + ggtitle("PCA after data integration with harmony")
```
### Colored by Joint
```{r}
#Plot PCA after data integration
plotReducedDim(sce.BatchR, dimred="harmony", colour_by="JointLocation") + ggtitle("PCA after data integration with harmony")
```
### Facet by Sample
```{r}
#Plot PCA after data integration per sample
plotReducedDim(sce.BatchR, dimred="harmony", colour_by="Sample") + ggtitle("PCA after data integration with harmony")+ facet_wrap(~sce.BatchR$Sample)
```
### Facet by Joint
```{r}
#Plot PCA after data integration per joint
plotReducedDim(sce.BatchR, dimred="harmony", colour_by="JointLocation") + ggtitle("PCA after data integration with harmony")+ facet_wrap(~sce.BatchR$JointLocation)

```


## UMAP Plots after Integration {.tabset}
### Colored by Sample
```{r}
#Plot UMAP before data integration
plotReducedDim(sce.BatchR, dimred="harmony_UMAP", colour_by="Sample") + ggtitle("UMAP after data integration with harmony")
```
### Colored by Joint
```{r}
#Plot UMAP before data integration
plotReducedDim(sce.BatchR, dimred="harmony_UMAP", colour_by="JointLocation") + ggtitle("UMAP after data integration with harmony")
```
### Facet by Sample
```{r}
#Plot UMAP after data integration per sample
plotReducedDim(sce.BatchR, dimred="harmony_UMAP", colour_by="Sample") + ggtitle("UMAP after data integration with harmony")+ facet_wrap(~sce.BatchR$Sample)

```
### Facet by Joint
```{r}
#Plot UMAP after data integration per joint
plotReducedDim(sce.BatchR, dimred="harmony_UMAP", colour_by="JointLocation") + ggtitle("UMAP after data integration with harmony")+ facet_wrap(~sce.BatchR$JointLocation)
```


## Save the dataset

```{r SaveData}
saveRDS(sce.filtered, file =paste0(path,'/output/03_sce_Integrated_Harmony.rds'))
```
