---
title: "Cellcycle Assignement"
subtitle: "04_CellCycle"
author: "SarahL."
date: "`r format(Sys.time(), '%b %e %Y %H:%M:%S')`"
output: 
  html_document:
    toc: true
    number_sections: true   
    toc_float: true
    code_folding: hide
    df_print: paged
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
knitr::opts_chunk$set(cache = FALSE, cache.lazy = FALSE)
knitr::opts_chunk$set(dpi = 300, fig.align = "center")
knitr::opts_chunk$set(out.width = "100%", out.height = "100%")
```


# Cell Cycle

## Setup

### Load packages

```{r LoadPackages, warning=FALSE}
#Standard Packages
library(here)
source(here("code", "standard_libraries.R"))

#Additional Packages
suppressPackageStartupMessages({
library(Seurat)
})

```

### Set Parameter
```{r Setup}
set.seed(123)
bpp <- BiocParallel::MulticoreParam(parallel::detectCores()-1, RNGseed=123)
path <- here::here()
```

## Load Data
```{r LoadDataset}
## RA DATASET
sce <- readRDS(file = paste0(path,'/output/03_sce_Integration_Batchelor.rds'))
```

### Explore Dataset
```{r ShowDim}
#Dimensions of count matrix
dim(sce)
```


## Determine Cell cycle

### Define function
```{r SetFunction}
## RA DATASET
CellCycle <- function(sce)
{
  #Create empty column in sce
  sce$S.Score <- rep(NA,ncol(sce))
  sce$G2M.Score <- rep(NA,ncol(sce))
  sce$phase <- rep(NA,ncol(sce))
  
  #Change to gene symbol whenever possible
  rowData(sce)$UniqID <-rownames(sce)
  rownames(sce) <- uniquifyFeatureNames(rowData(sce)$ENSEMBL, rowData(sce)$Symbol)
  
  #CellCycleScoring through seurat
  s.genes = cc.genes$s.genes
  g2m.genes = cc.genes$g2m.genes
  so <- Seurat::CreateSeuratObject(as.matrix(counts(sce)))
  so <- Seurat::NormalizeData(so)
  so <- Seurat::FindVariableFeatures(so, selection.method = "vst")
  so <- Seurat::ScaleData(so, features = rownames(so))
  so <- Seurat::CellCycleScoring(so, s.features = s.genes, g2m.features = g2m.genes, set.ident = TRUE)
  
  #Add scores to sce
  sce$S.Score <- so$S.Score
  sce$G2M.Score <- so$G2M.Score
  sce$phase  <- so$Phase
  return(sce)
}
```


### Run Fnction
```{r AssignCellcycle}
## RA DATASET
sce<-CellCycle(sce)
  
```

## Plot the Cellcycle phases

### PCA

```{r PlotPCA}
#Plot PCA after data integration
plotReducedDim(sce, dimred="MNN_reduced", colour_by="phase",point_alpha=0.8,point_size=0.1) +
  labs( x='PCA 1', y='PCA 2' )+ 
  ggtitle("PCA colored by Cellcycle")+ 
  guides(colour = guide_legend(override.aes = list(size=2)))

```
### PCA facet by Cellcycle phase

```{r PlotFacetPCA, fig.height=5, fig.width=15}
plotReducedDim(sce, dimred="PCA_reduced", colour_by="phase",point_alpha=0.8,point_size=0.1) + 
  facet_wrap(~sce$phase)+ 
  theme(strip.background=element_rect(fill="white"))+
  guides(colour = guide_legend(override.aes = list(size=2)))+
  labs( x='PCA 1', y='PCA 2' )
```



### UMAP

```{r PlotUMAP}
#Plot UMAP after data integration
plotReducedDim(sce, dimred="MNN_UMAP_reduced", colour_by="phase",point_alpha=0.7,point_size=0.1) + 
  ggtitle("UMAP colored by Cellcycle")+
  labs( x='UMAP 1', y='UMAP 2' )+ 
  guides(colour = guide_legend(override.aes = list(size=2)))
  
```

## Frequencies of Cellcycle phase per Sample {.tabset}

```{r ClusterInfoSample}
ClusterInfo <- as.data.frame(colData(sce)) %>% 
  group_by(phase, Sample,Joint.Location) %>%
  summarise(cells = n(),.groups = 'drop') 
```

### Absolute comparison

```{r PlotAbsoluteClusteringSample}

ggplot(data=ClusterInfo, aes(x=Sample,y=cells, fill=phase)) +
  geom_bar(stat="identity", position="stack") +
  labs(title="Absolute comparison",subtitle="Per Sample",x="",y="Number of cells")+
  theme_classic()+
  scale_fill_manual( values=c("#6D96CC","#F99636","#68BD49"),name = "phase" )+
  theme(axis.text.x = element_text(angle = 45,hjust=1), axis.ticks.x=element_blank())+
  scale_y_continuous(expand = c(0,0))

```


### Relative comparison

```{r PlotRelativeClusteringSample}

ggplot(data=ClusterInfo,aes(x=Sample, y=cells, fill=phase)) +
  geom_bar(stat="identity", position="fill") +
  labs(title="Relative comparison",subtitle="Per Sample",x="",y="Number of cells")+
  theme_classic()+
  scale_fill_manual( values=c("#6D96CC","#F99636","#68BD49"),name = "phase" )+
  theme(axis.text.x = element_text(angle = 45,hjust=1))+
  scale_y_continuous(expand = c(0,0))

```



## Frequencies of celltypes in clusters per Condition {.tabset}

```{r ClusterInfoCondition}
ClusterInfo <- as.data.frame(colData(sce)) %>% 
  group_by(phase,Joint.Location) %>%
  summarise(cells = n(),.groups = 'drop') 
```

### Absolute comparison

```{r PlotAbsoluteClusteringCondition}

ggplot(data=ClusterInfo, aes(x=Joint.Location,y=cells, fill=phase)) +
  geom_bar(stat="identity", position="stack") +
  labs(title="Absolute comparison",subtitle="Per Condition",x="",y="Number of cells")+
  theme_classic()+
  scale_fill_manual( values=c("#6D96CC","#F99636","#68BD49"),name = "phase" )+
  theme(axis.text.x = element_text(angle = 45,hjust=1))+
  scale_y_continuous(expand = c(0,0))

```

### Relative comparison

```{r PlotRelativeClusteringCondition}

ggplot(data=ClusterInfo,aes(x=Joint.Location, y=cells, fill=phase)) +
  geom_bar(stat="identity", position="fill") +
  labs(title="Relative comparison",subtitle="Per Condition",x="",y="Number of cells")+
  theme_classic()+
  scale_fill_manual( values=c("#6D96CC","#F99636","#68BD49"),name = "phase" )+
  theme(axis.text.x = element_text(angle = 45,hjust=1))+
  scale_y_continuous(expand = c(0,0))

```


## Save the dataset

```{r SaveData}
saveRDS(sce, file =paste0(path,'/output/04_sce_CellCycle.rds'))
```

