---
title: "Enrichment Analysis"
subtitle: "09_EnrichmentAnalysis"
author: "SarahL."
date: "`r format(Sys.time(), '%b %e %Y %H:%M:%S')`"
output: 
  html_document:
    toc: true
    number_sections: true   
    toc_float: true
    code_folding: hide
    df_print: paged
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
knitr::opts_chunk$set(cache = FALSE, cache.lazy = FALSE)
knitr::opts_chunk$set(dpi = 300, fig.align = "center")
knitr::opts_chunk$set(out.width = "100%", out.height = "100%")
```


# Enrichment Analysis

## Setup

### Standard packages

```{r LoadPackages, warning=FALSE}
library(here)
source(here("code", "standard_libraries.R"))
```

### Additional Packages


```{r LoadPackages, warning=FALSE}
#Load Packages

suppressPackageStartupMessages({
library(clusterProfiler)
library(enrichplot)
library(msigdbr)
})

```

### Set Parameter

```{r Setup}
set.seed(123)
bpp <- BiocParallel::MulticoreParam(parallel::detectCores()-1, RNGseed=100)
path <- here::here()
```


### Load  Hallmark gene set collection

```{r LoadDataset}

#check if human==Homosapienz
gene_set_C5 <- msigdbr(species = "Homo sapiens", category = "C5")
gene_set_C2 <- msigdbr(species = "Homo sapiens", category = "C2")
gene_set_H <- msigdbr(species = "Homo sapiens", category = "H")

TERM2GENE <- rbind(gene_set_C5, gene_set_C2, gene_set_H) %>% 
  dplyr::select(gs_name, human_entrez_gene, gs_cat, human_gene_symbol,gs_id) %>% 
  distinct() %>% 
  dplyr::rename(entrez_gene = human_entrez_gene)%>% 
  dplyr::rename(gene_symbol = human_gene_symbol)

full_msigdbr <- msigdbr(species = "Homo sapiens")

TERM2GENE_full_msigdbr <- full_msigdbr %>% 
  dplyr::select(gs_name, human_entrez_gene, gs_cat, human_gene_symbol,gs_id) %>% 
  distinct() %>% 
  dplyr::rename(entrez_gene = human_entrez_gene)%>% 
  dplyr::rename(gene_symbol = human_gene_symbol)

```

### Load Data

```{r LoadDataset}
## RA DATASET
geneList_KneeVsMCP <-read.csv(paste0(path,'/output/MAST_KneeVsMCP.csv'))
geneList_KneeVsWrist <-read.csv(paste0(path,'/output/MAST_KneeVsWrist.csv'))
geneList_MCPVsWrist <-read.csv(paste0(path,'/output/MAST_MCPVsWrist.csv'))
```


### Set functions

```{r LoadDataset}
# Run enrichGO
run_enrichGO <- function(gene_list, background) {
  enrichGO_res <- enrichGO(
    gene = gene_list,
    universe =background,
    OrgDb = org.Hs.eg.db,
    keyType = 'SYMBOL',
    ont = "CC",
    pAdjustMethod = "BH",
    pvalueCutoff = 0.05,
    qvalueCutoff = 0.05,
    readable = TRUE)
  return(enrichGO_res) 
}

# Run enrichr
run_enrichr <- function(gene_list, gene_sets, background) {
  
  enrichr_res <- clusterProfiler::enricher(
    gene_list,
    TERM2GENE = gene_sets,
    universe = background,
    pvalueCutoff = 1,
    qvalueCutoff = 1,
    pAdjustMethod = "BH",
    minGSSize = 1, 
    maxGSSize = 5000)
  return(enrichr_res) 
}


# Run enrichGO
run_gseGO <- function(gene_list) {
  
  gseGO_res <- gseGO(
    gene = gene_list,
    OrgDb = org.Hs.eg.db,
    keyType = 'SYMBOL',
    ont = "CC",
    pAdjustMethod = "BH",
    minGSSize    = 1,
    maxGSSize    = 5000,
    pvalueCutoff = 0.05,
    verbose      = FALSE)
  return(gseGO_res) 
}


# Run GSEA
run_GSEA <- function(gene_list, gene_sets) {
  
  GSEA_res <- GSEA(
    gene_list,
    TERM2GENE = gene_sets,
    pAdjustMethod = "BH",
    minGSSize    = 1,
    maxGSSize    = 5000,
    pvalueCutoff = 0.05,
    verbose      = FALSE)
  return(GSEA_res) 
}

```


--------------------------------------------------------------------------------------------------------------------------------------------------------------------------

## Enrichment Analysis Knee Vs MCP

Explore DEG Dataset
```{r LoadDataset}
##Print table
head(geneList_KneeVsMCP)

```


Update Genesymbols
```{r LoadDataset}
# Get names for all genes for the background/universe & update the gene symbols 
gene_List<-update_gene_names(geneList_KneeVsMCP$primerid)
geneList_KneeVsMCP$updated<- gene_List$updated

```



### Over-representation analysis

#### Set up genelists

```{r LoadDataset}
# Get significatn genes for each condidtion
gene_List_Knee <- geneList_KneeVsMCP[geneList_KneeVsMCP$PValue<0.05 & geneList_KneeVsMCP$log2FoldChange< -0.1,, drop=F] #genes for cond1
gene_List_MCP <- geneList_KneeVsMCP[geneList_KneeVsMCP$PValue<0.05 & geneList_KneeVsMCP$log2FoldChange> 0.1,, drop=F] #genes for cond2

```


#### Run GO over-representation analysis

```{r DE}
ego_Knee <- run_enrichGO(gene_List_Knee$updated,gene_List$updated)
ego_Knee@result[ego_Knee@result$p.adjust<0.05,, drop=F]# Show enriched terms

ego_MCP <- run_enrichGO(gene_List_MCP$updated,gene_List$updated)
ego_MCP@result[ego_MCP@result$p.adjust<0.05,, drop=F]# Show enriched terms
```



#### Run Hallmark over-representation analysis

Run over-representation analysis on set of genes of the Hallmark collection
```{r DE}
msig_Knee <- run_enrichr(gene_List_Knee$updated,TERM2GENE[,c("gs_name", "gene_symbol")],gene_List$updated)
msig_Knee@result[msig_Knee@result$p.adjust<0.05,, drop=F]# Show enriched terms

msig_MCP <- run_enrichr(gene_List_MCP$updated,TERM2GENE[,c("gs_name", "gene_symbol")],gene_List$updated)
msig_MCP@result[msig_MCP@result$p.adjust<0.05,, drop=F]# Show enriched terms

```


#### Visualization of over-representation analysis

##### Knee ORA Plots

```{r DE}
# Visualize enriched GO terms as a directed acyclic graph
goplot(ego_Knee)

# Bar Plot
barplot(ego_Knee, showCategory=20) 

mutate(ego_Knee, qscore = -log(p.adjust, base=10)) %>% 
    barplot(x="qscore")+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

# Dot plot
dotplot(ego_Knee, showCategory=30) + ggtitle("dotplot for ORA")

# Heatmap-like functional classification
#mygeneList <- setNames(geneList$coef_baselog2, gene_List)

#p1 <- heatplot(ego, showCategory=2)
#p2 <- heatplot(ego, foldChange=mygeneList, showCategory=2)
#cowplot::plot_grid(p1, p2, ncol=1, labels=LETTERS[1:2])


```
##### MCP ORA Plots

```{r DE}
# Visualize enriched GO terms as a directed acyclic graph
goplot(ego_MCP)

# Bar Plot
barplot(ego_MCP, showCategory=20) 

mutate(ego_MCP, qscore = -log(p.adjust, base=10)) %>% 
    barplot(x="qscore")+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

# Dot plot
dotplot(ego_MCP, showCategory=30) + ggtitle("dotplot for ORA")

# Heatmap-like functional classification
#mygeneList <- setNames(geneList$coef_baselog2, gene_List)

#p1 <- heatplot(ego, showCategory=2)
#p2 <- heatplot(ego, foldChange=mygeneList, showCategory=2)
#cowplot::plot_grid(p1, p2, ncol=1, labels=LETTERS[1:2])


```




### Gene Set Enrichment Analysis

#### Set up genelist
```{r DE}
#Remove NA
#res = res[-which(is.na(geneList_KneeVsMCP$updated)), ]

#Want log2 fold change 
gse_gene_list = geneList_KneeVsMCP$log2FoldChange 
#Name the vector with Genesymbol
names(gse_gene_list) <- geneList_KneeVsMCP$updated
#Sort the list in decreasing order (required for clusterProfiler)
gse_gene_list = sort(gse_gene_list, decreasing = TRUE)
```

#### Run GO Gene Set Enrichment Analysis

```{r DE}
#Run gseGO_res
gseGO_res <- run_gseGO(gse_gene_list)
gseGO_res@result[gseGO_res@result$p.adjust<0.05,, drop=F]

```

##### Plot GOgse results
```{r DE}
dotplot(gseGO_res, showCategory=3, split=".sign") + facet_grid(.~.sign)
dotplot(gseGO_res, showCategory=30) + ggtitle("dotplot for GSEA")
```


#### Run GSEA Gene Set Enrichment Analysis

```{r DE}
#Run GSEA_res
GSEA_res <- run_GSEA(gse_gene_list,TERM2GENE[,c("gs_name", "gene_symbol")])
GSEA_res@result[GSEA_res@result$p.adjust<0.05,, drop=F]
```

##### Plot GSEA results
```{r DE}
dotplot(gseGO_res, showCategory=3, split=".sign") + facet_grid(.~.sign)
dotplot(gseGO_res, showCategory=30) + ggtitle("dotplot for GSEA")
```



### Save the datasets

```{r SaveData}
#write.csv(msig_Knee@result[msig_Knee@result$p.adjust<0.05,, drop=F],file=paste0(path,"/output/Knee_KvM.csv"))
#write.csv(msig_MCP@result[msig_MCP@result$p.adjust<0.05,, drop=F],file=paste0(path,"/output/MCP_KvM.csv"))
```




--------------------------------------------------------------------------------------------------------------------------------------------------------------------------

## Enrichment Analysis Knee Vs Wirst

Explore DEG Dataset
```{r LoadDataset}
##Print table
head(geneList_KneeVsWrist)

```

Update Genesymbols
```{r LoadDataset}
# Get names for all genes for the background/universe & update the gene symbols 
gene_List<-update_gene_names(geneList_KneeVsWrist$primerid)
geneList_KneeVsWrist$updated<- gene_List$updated

```

### Over-representation analysis

#### Set up genelists
```{r LoadDataset}
# Get significatn genes for each condidtion
gene_List_Knee <- geneList_KneeVsWrist[geneList_KneeVsWrist$PValue<0.05 & geneList_KneeVsWrist$log2FoldChange< -0.1,, drop=F] #genes for cond1
gene_List_Wrist <- geneList_KneeVsWrist[geneList_KneeVsWrist$PValue<0.05 & geneList_KneeVsWrist$log2FoldChange> 0.1,, drop=F] #genes for cond2

```


#### Run GO over-representation analysis

```{r DE}
ego_Knee <- run_enrichGO(gene_List_Knee$updated,gene_List$updated)
ego_Knee@result[ego_Knee@result$p.adjust<0.05,, drop=F]# Show enriched terms

ego_Wrist <- run_enrichGO(gene_List_Wrist$updated,gene_List$updated)
ego_Wrist@result[ego_Wrist@result$p.adjust<0.05,, drop=F]# Show enriched terms
```



#### Run Hallmark over-representation analysis

Run over-representation analysis on set of genes of the Hallmark collection
```{r DE}
msig_Knee <- run_enrichr(gene_List_Knee$updated,TERM2GENE[,c("gs_name", "gene_symbol")],gene_List$updated)
msig_Knee@result[msig_Knee@result$p.adjust<0.05,, drop=F]

msig_Wrist <- run_enrichr(gene_List_Wrist$updated,TERM2GENE[,c("gs_name", "gene_symbol")],gene_List$updated)
msig_Wrist@result[msig_Wrist@result$p.adjust<0.05,, drop=F]
```



#### Visualization of over-representation analysis

##### Knee ORA Plots

```{r DE}
# Visualize enriched GO terms as a directed acyclic graph
goplot(ego_Knee)

# Bar Plot
barplot(ego_Knee, showCategory=20) 

mutate(ego_Knee, qscore = -log(p.adjust, base=10)) %>% 
    barplot(x="qscore")+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

# Dot plot

dotplot(ego_Knee, showCategory=30) + ggtitle("dotplot for ORA")

# Heatmap-like functional classification
#mygeneList <- setNames(geneList$coef_baselog2, gene_List)

#p1 <- heatplot(ego, showCategory=2)
#p2 <- heatplot(ego, foldChange=mygeneList, showCategory=2)
#cowplot::plot_grid(p1, p2, ncol=1, labels=LETTERS[1:2])



```

#### Wrist ORA Plots

```{r DE}
# Visualize enriched GO terms as a directed acyclic graph
goplot(ego_Wrist)

barplot(ego_Wrist, showCategory=20) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

# Bar Plot
barplot(ego_Wrist, showCategory=20) 

mutate(ego_Wrist, qscore = -log(p.adjust, base=10)) %>% 
    barplot(x="qscore")+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

# Dot plot

dotplot(ego_Wrist, showCategory=30) + ggtitle("dotplot for ORA")

# Heatmap-like functional classification
mygeneList <- setNames(geneList$coef_baselog2, gene_List)

p1 <- heatplot(ego, showCategory=2)
p2 <- heatplot(ego, foldChange=mygeneList, showCategory=2)
cowplot::plot_grid(p1, p2, ncol=1, labels=LETTERS[1:2])



```



### Gene Set Enrichment Analysis

#### Set up genelist
```{r DE}
#Remove NA
#res = res[-which(is.na(geneList_KneeVsWrist$updated)), ]

#Want log2 fold change 
gse_gene_list = geneList_KneeVsWrist$log2FoldChange 
#Name the vector with Genesymbol
names(gse_gene_list) <- geneList_KneeVsWrist$updated
#Sort the list in decreasing order (required for clusterProfiler)
gse_gene_list = sort(gse_gene_list, decreasing = TRUE)
```

#### Run GO Gene Set Enrichment Analysis

```{r DE}
#Run gseGO_res
gseGO_res <- run_gseGO(gse_gene_list)
gseGO_res@result[gseGO_res@result$p.adjust<0.05,, drop=F]

```

##### Plot GOgse results
```{r DE}
dotplot(gseGO_res, showCategory=3, split=".sign") + facet_grid(.~.sign)
dotplot(gseGO_res, showCategory=30) + ggtitle("dotplot for GSEA")
```


#### Run GSEA Gene Set Enrichment Analysis

```{r DE}
#Run GSEA_res
GSEA_res <- run_GSEA(gse_gene_list,TERM2GENE[,c("gs_name", "gene_symbol")])
GSEA_res@result[GSEA_res@result$p.adjust<0.05,, drop=F]
```
##### Plot GSEA results
```{r DE}
dotplot(GSEA_res, showCategory=3, split=".sign") + facet_grid(.~.sign)
dotplot(GSEA_res, showCategory=30) + ggtitle("dotplot for GSEA")
```



### Save the datasets
```{r SaveData}
#write.csv(msig_Knee@result[msig_Knee@result$p.adjust<0.05,, drop=F],file=paste0(path,"/output/Knee_KvM.csv"))
#write.csv(msig_MCP@result[msig_MCP@result$p.adjust<0.05,, drop=F],file=paste0(path,"/output/MCP_KvM.csv"))
```



--------------------------------------------------------------------------------------------------------------------------------------------------------------------------

## Enrichment Analysis MCP Vs Wrist

Explore DEG Dataset
```{r LoadDataset}
##Print table
head(geneList_MCPVsWrist)

```

Update Genesymbols
```{r LoadDataset}
# Get names for all genes for the background/universe & update the gene symbols 
gene_List<-update_gene_names(geneList_MCPVsWrist$primerid)
geneList_MCPVsWrist$updated<- gene_List$updated

```


### Over-representation analysis

#### Set up genelists
```{r LoadDataset}
# Get significatn genes for each condidtion
gene_List_MCP <- geneList_MCPVsWrist[geneList_MCPVsWrist$PValue<0.05 & geneList_MCPVsWrist$log2FoldChange< -0.1,, drop=F] #genes for cond1
gene_List_Wrist <- geneList_MCPVsWrist[geneList_MCPVsWrist$PValue<0.05 & geneList_MCPVsWrist$log2FoldChange> 0.1,, drop=F] #genes for cond2

```

#### Run GO over-representation analysis

```{r DE}

ego_MCP <- run_enrichGO(gene_List_MCP$updated,gene_List$updated)
ego_MCP@result[ego_MCP@result$p.adjust<0.05,, drop=F]

ego_Wrist <- run_enrichGO(gene_List_Wrist$updated,gene_List$updated)
ego_Wrist@result[ego_Wrist@result$p.adjust<0.05,, drop=F]
```


#### Run Hallmark over-representation analysis

Run over-representation analysis on set of genes of the Hallmark collection
```{r DE}
msig_Knee <- run_enrichr(gene_List_Knee$updated,TERM2GENE[,c("gs_name", "gene_symbol")],gene_List$updated)
msig_MCP@result[msig_MCP@result$p.adjust<0.05,, drop=F]

msig_MCP <- run_enrichr(gene_List_MCP$updated,TERM2GENE[,c("gs_name", "gene_symbol")],gene_List$updated)
msig_Wrist@result[msig_Knee@result$p.adjust<0.05,, drop=F]
```



#### Visualization of over-representation analysis

#### MCP ORA Plots

```{r DE}
# Visualize enriched GO terms as a directed acyclic graph
goplot(ego_MCP)

# Bar Plot
barplot(ego_MCP, showCategory=20) 

mutate(ego_MCP, qscore = -log(p.adjust, base=10)) %>% 
    barplot(x="qscore")+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

# Dot plot

dotplot(ego_MCP, showCategory=30) + ggtitle("dotplot for ORA")

# Heatmap-like functional classification
#mygeneList <- setNames(geneList$coef_baselog2, gene_List)

#p1 <- heatplot(ego, showCategory=2)
#p2 <- heatplot(ego, foldChange=mygeneList, showCategory=2)
#cowplot::plot_grid(p1, p2, ncol=1, labels=LETTERS[1:2])



```

#### WristORA Plots

```{r DE}
# Visualize enriched GO terms as a directed acyclic graph
goplot(ego_Wrist)

barplot(ego_Wrist, showCategory=3) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

# Bar Plot
barplot(ego_Wrist, showCategory=20) 

mutate(ego_Wrist, qscore = -log(p.adjust, base=10)) %>% 
    barplot(x="qscore")+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

# Dot plot

dotplot(ego_Wrist, showCategory=30) + ggtitle("dotplot for ORA")

# Heatmap-like functional classification
mygeneList <- setNames(geneList$coef_baselog2, gene_List)

p1 <- heatplot(ego, showCategory=2)
p2 <- heatplot(ego, foldChange=mygeneList, showCategory=2)
cowplot::plot_grid(p1, p2, ncol=1, labels=LETTERS[1:2])


```



### Gene Set Enrichment Analysis

#### Set up genelist
```{r DE}
#Remove NA
#res = res[-which(is.na(geneList_MCPVsWrist$updated)), ]

#Want log2 fold change 
gse_gene_list = geneList_MCPVsWrist$log2FoldChange 
#Name the vector with Genesymbol
names(gse_gene_list) <- geneList_MCPVsWrist$updated
#Sort the list in decreasing order (required for clusterProfiler)
gse_gene_list = sort(gse_gene_list, decreasing = TRUE)
```

#### Run GO Gene Set Enrichment Analysis

```{r DE}
#Run gseGO_res
gseGO_res <- run_gseGO(gse_gene_list)
gseGO_res@result[gseGO_res@result$p.adjust<0.05,, drop=F]

```

##### Plot GOgse results
```{r DE}
dotplot(gseGO_res, showCategory=3, split=".sign") + facet_grid(.~.sign)
dotplot(gseGO_res, showCategory=30) + ggtitle("dotplot for GSEA")
```


#### Run GSEA Gene Set Enrichment Analysis

```{r DE}
#Run GSEA_res
GSEA_res <- run_GSEA(gse_gene_list,TERM2GENE[,c("gs_name", "gene_symbol")])
GSEA_res@result[GSEA_res@result$p.adjust<0.05,, drop=F]
```
##### Plot GSEA results
```{r DE}
dotplot(GSEA_res, showCategory=3, split=".sign") + facet_grid(.~.sign)
dotplot(GSEA_res, showCategory=30) + ggtitle("dotplot for GSEA")
```


### Save the datasets

```{r SaveData}
#write.csv(msig_Knee@result[msig_Knee@result$p.adjust<0.05,, drop=F],file=paste0(path,"/output/Knee_KvM.csv"))
#write.csv(msig_MCP@result[msig_MCP@result$p.adjust<0.05,, drop=F],file=paste0(path,"/output/MCP_KvM.csv"))
```

