---
title: "Enrichment Analysis"
subtitle: "09_EnrichmentAnalysis"
author: "SarahL."
date: "`r format(Sys.time(), '%b %e %Y %H:%M:%S')`"
output: 
  html_document:
    toc: true
    number_sections: true   
    toc_float: true
    code_folding: hide
    df_print: paged
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
knitr::opts_chunk$set(cache = FALSE, cache.lazy = FALSE)
knitr::opts_chunk$set(dpi = 300, fig.align = "center")
knitr::opts_chunk$set(out.width = "100%", out.height = "100%")
```


# Enrichment Analysis

## Setup

### Standard packages

```{r LoadPackages, warning=FALSE}
library(here)
source(here("code", "standard_libraries.R"))
```

### Additional Packages


```{r LoadPackages, warning=FALSE}
#Load Packages

suppressPackageStartupMessages({
library(clusterProfiler)
library(enrichplot)
library(msigdbr)
})

```

### Set Parameter

```{r Setup}
set.seed(123)
bpp <- BiocParallel::MulticoreParam(parallel::detectCores()-1, RNGseed=100)
path <- here::here()
```


### Load  Hallmark gene set collection

```{r LoadDataset}

#gmt <- msigdbr::msigdbr(species = "human", category = "H")

#check if human==Homosapienz
gene_set_C5 <- msigdbr(species = "Homo sapiens", category = "C5")
gene_set_C2 <- msigdbr(species = "Homo sapiens", category = "C2")
gene_set_H <- msigdbr(species = "Homo sapiens", category = "H")

TERM2GENE <- rbind(gene_set_C5, gene_set_C2, gene_set_H) %>% 
  dplyr::select(gs_name, human_entrez_gene, gs_cat, human_gene_symbol,gs_id) %>% 
  distinct() %>% 
  dplyr::rename(entrez_gene = human_entrez_gene)%>% 
  dplyr::rename(gene_symbol = human_gene_symbol)

full_msigdbr <- msigdbr(species = "Homo sapiens")

TERM2GENE_full_msigdbr <- full_msigdbr %>% 
  dplyr::select(gs_name, human_entrez_gene, gs_cat, human_gene_symbol,gs_id) %>% 
  distinct() %>% 
  dplyr::rename(entrez_gene = human_entrez_gene)%>% 
  dplyr::rename(gene_symbol = human_gene_symbol)

```

### Load Data

```{r LoadDataset}
## RA DATASET
geneList_KneeVsMCP <-read.csv(paste0(path,'/output/MAST_KneeVsMCP.csv'))
geneList_KneeVsWrist <-read.csv(paste0(path,'/output/MAST_KneeVsWrist.csv'))
geneList_MCPVsWrist <-read.csv(paste0(path,'/output/MAST_MCPVsWrist.csv'))
```


## Set functions

```{r LoadDataset}
# Run enrichGO
run_enrichGO <- function(gene_list, background) {
  enrichGO_res <- enrichGO(
    gene = gene_list,
    universe =background,
    OrgDb = org.Hs.eg.db,
    keyType = 'SYMBOL',
    ont = "CC",
    pAdjustMethod = "BH",
    pvalueCutoff = 0.05,
    qvalueCutoff = 0.05,
    readable = TRUE)
  return(enrichGO_res) 
}

# Run enrichr
run_enrichr <- function(gene_list, gene_sets, background) {
  
  enrichr_res <- clusterProfiler::enricher(
    gene_list,
    TERM2GENE = gene_sets,
    universe = background,
    pvalueCutoff = 1,
    qvalueCutoff = 1,
    pAdjustMethod = "BH",
    minGSSize = 1, 
    maxGSSize = 5000)
  return(enrichr_res) 
}

```


--------------------------------------------------------------------------------------------------------------------------------------------------------------------------

## Enrichment Analysis Knee Vs MCP

### Explore DEG Dataset

```{r LoadDataset}
##Print table
head(geneList_KneeVsMCP)

```

### Set up genelists

```{r LoadDataset}
# Get names for all genes for the background/universe & update the gene symbols 
gene_List<-update_gene_names(geneList_KneeVsMCP$primerid)
geneList_KneeVsMCP$updated<- gene_List$updated

# Get significatn genes for each condidtion
gene_List_Knee <- geneList_KneeVsMCP[geneList_KneeVsMCP$PValue<0.05 & geneList_KneeVsMCP$log2FoldChange< -0.1,, drop=F] #genes for cond1
gene_List_MCP <- geneList_KneeVsMCP[geneList_KneeVsMCP$PValue<0.05 & geneList_KneeVsMCP$log2FoldChange> 0.1,, drop=F] #genes for cond2

```

### GO collection

#### Run GO over-representation analysis

```{r DE}

ego_Knee <- run_enrichGO(gene_List_Knee$updated,gene_List$updated)
ego_MCP <- run_enrichGO(gene_List_MCP$updated,gene_List$updated)
```

### Show enriched terms

```{r DE}
ego_Knee@result[ego_Knee@result$p.adjust<0.05,, drop=F]

ego_MCP@result[ego_MCP@result$p.adjust<0.05,, drop=F]

```



### Hallmark collection

#### Run over-representation analysis on set of genes of the Hallmark collection


```{r DE}
msig_Knee <- run_enrichr(gene_List_Knee$updated,TERM2GENE[,c("gs_name", "gene_symbol")],gene_List$updated)
msig_MCP <- run_enrichr(gene_List_MCP$updated,TERM2GENE[,c("gs_name", "gene_symbol")],gene_List$updated)

```

### Show enriched terms

```{r DE}
msig_Knee@result[msig_Knee@result$p.adjust<0.05,, drop=F]
msig_MCP@result[msig_MCP@result$p.adjust<0.05,, drop=F]

write.csv(msig_Knee@result[msig_Knee@result$p.adjust<0.05,, drop=F],file=paste0(path,"/output/Knee_KvM.csv"))
write.csv(msig_MCP@result[msig_MCP@result$p.adjust<0.05,, drop=F],file=paste0(path,"/output/MCP_KvM.csv"))

```





### Visualization of functional enrichment result

#### Knee

```{r DE}
# Visualize enriched GO terms as a directed acyclic graph
goplot(ego_Knee)

# Bar Plot
barplot(ego_Knee, showCategory=20) 

mutate(ego_Knee, qscore = -log(p.adjust, base=10)) %>% 
    barplot(x="qscore")+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

# Dot plot
dotplot(ego_Knee, showCategory=30) + ggtitle("dotplot for ORA")

# Heatmap-like functional classification
#mygeneList <- setNames(geneList$coef_baselog2, gene_List)

#p1 <- heatplot(ego, showCategory=2)
#p2 <- heatplot(ego, foldChange=mygeneList, showCategory=2)
#cowplot::plot_grid(p1, p2, ncol=1, labels=LETTERS[1:2])


```
#### MCP

```{r DE}
# Visualize enriched GO terms as a directed acyclic graph
goplot(ego_MCP)

# Bar Plot
barplot(ego_MCP, showCategory=20) 

mutate(ego_MCP, qscore = -log(p.adjust, base=10)) %>% 
    barplot(x="qscore")+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

# Dot plot
dotplot(ego_MCP, showCategory=30) + ggtitle("dotplot for ORA")

# Heatmap-like functional classification
#mygeneList <- setNames(geneList$coef_baselog2, gene_List)

#p1 <- heatplot(ego, showCategory=2)
#p2 <- heatplot(ego, foldChange=mygeneList, showCategory=2)
#cowplot::plot_grid(p1, p2, ncol=1, labels=LETTERS[1:2])


```

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------

## Enrichment Analysis Knee Vs Wirst

### Explore DEG Dataset

```{r LoadDataset}
##Print table
head(geneList_KneeVsWrist)

```

### Set up genelists

```{r LoadDataset}
# Get names for all genes for the background/universe & update the gene symbols 
gene_List<-update_gene_names(geneList_KneeVsWrist$primerid)
geneList_KneeVsWrist$updated<- gene_List$updated

# Get significatn genes for each condidtion
gene_List_Knee <- geneList_KneeVsWrist[geneList_KneeVsWrist$PValue<0.05 & geneList_KneeVsWrist$log2FoldChange< -0.1,, drop=F] #genes for cond1
gene_List_Wrist <- geneList_KneeVsWrist[geneList_KneeVsWrist$PValue<0.05 & geneList_KneeVsWrist$log2FoldChange> 0.1,, drop=F] #genes for cond2

```

### GO collection

#### Run GO over-representation analysis

```{r DE}

ego_Knee <- run_enrichGO(gene_List_Knee$updated,gene_List$updated)
ego_Wrist <- run_enrichGO(gene_List_Wrist$updated,gene_List$updated)
```

### Show enriched terms

```{r DE}
ego_Knee@result[ego_Knee@result$p.adjust<0.05,, drop=F]
ego_Wrist@result[ego_Wrist@result$p.adjust<0.05,, drop=F]

```



### Hallmark collection

#### Run over-representation analysis on set of genes of the Hallmark collection


```{r DE}
msig_Knee <- run_enrichr(gene_List_Knee$updated,TERM2GENE[,c("gs_name", "gene_symbol")],gene_List$updated)
msig_Wrist <- run_enrichr(gene_List_Wrist$updated,TERM2GENE[,c("gs_name", "gene_symbol")],gene_List$updated)

```

### Show enriched terms

```{r DE}
msig_Knee@result[msig_Knee@result$p.adjust<0.05,, drop=F]
msig_Wrist@result[msig_Wrist@result$p.adjust<0.05,, drop=F]

write.csv(msig_Knee@result[msig_Knee@result$p.adjust<0.05,, drop=F],file=paste0(path,"/output/Knee_KvW.csv"))
write.csv(msig_Wrist@result[msig_Wrist@result$p.adjust<0.05,, drop=F],file=paste0(path,"/output/Wrist_KvW.csv"))
```




### Visualization of functional enrichment result

#### Knee

```{r DE}
# Visualize enriched GO terms as a directed acyclic graph
goplot(ego_Knee)

# Bar Plot
barplot(ego_Knee, showCategory=20) 

mutate(ego_Knee, qscore = -log(p.adjust, base=10)) %>% 
    barplot(x="qscore")+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

# Dot plot

dotplot(ego_Knee, showCategory=30) + ggtitle("dotplot for ORA")

# Heatmap-like functional classification
mygeneList <- setNames(geneList$coef_baselog2, gene_List)

p1 <- heatplot(ego, showCategory=2)
p2 <- heatplot(ego, foldChange=mygeneList, showCategory=2)
cowplot::plot_grid(p1, p2, ncol=1, labels=LETTERS[1:2])



```
#### Wrist

```{r DE}
# Visualize enriched GO terms as a directed acyclic graph
goplot(ego_Wrist)

barplot(ego_Wrist, showCategory=20) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

# Bar Plot
barplot(ego_Wrist, showCategory=20) 

mutate(ego_Wrist, qscore = -log(p.adjust, base=10)) %>% 
    barplot(x="qscore")+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

# Dot plot

dotplot(ego_Wrist, showCategory=30) + ggtitle("dotplot for ORA")

# Heatmap-like functional classification
mygeneList <- setNames(geneList$coef_baselog2, gene_List)

p1 <- heatplot(ego, showCategory=2)
p2 <- heatplot(ego, foldChange=mygeneList, showCategory=2)
cowplot::plot_grid(p1, p2, ncol=1, labels=LETTERS[1:2])



```
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------

## Enrichment Analysis MCP Vs MCP

### Explore DEG Dataset

```{r LoadDataset}
##Print table
head(geneList_MCPVsWrist)

```

### Set up genelists

```{r LoadDataset}
# Get names for all genes for the background/universe & update the gene symbols 
gene_List<-update_gene_names(geneList_MCPVsWrist$primerid)
geneList_MCPVsWrist$updated<- gene_List$updated

# Get significatn genes for each condidtion
gene_List_MCP <- geneList_MCPVsWrist[geneList_MCPVsWrist$PValue<0.05 & geneList_MCPVsWrist$log2FoldChange< -0.1,, drop=F] #genes for cond1
gene_List_Wrist <- geneList_MCPVsWrist[geneList_MCPVsWrist$PValue<0.05 & geneList_MCPVsWrist$log2FoldChange> 0.1,, drop=F] #genes for cond2

```

### GO collection

#### Run GO over-representation analysis

```{r DE}

ego_MCP <- run_enrichGO(gene_List_MCP$updated,gene_List$updated)
ego_Wrist <- run_enrichGO(gene_List_Wrist$updated,gene_List$updated)
```

### Show enriched terms

```{r DE}
ego_MCP@result[ego_MCP@result$p.adjust<0.05,, drop=F]

ego_Wrist@result[ego_Wrist@result$p.adjust<0.05,, drop=F]


```



### Hallmark collection

#### Run over-representation analysis on set of genes of the Hallmark collection


```{r DE}
msig_Knee <- run_enrichr(gene_List_Knee$updated,TERM2GENE[,c("gs_name", "gene_symbol")],gene_List$updated)
msig_MCP <- run_enrichr(gene_List_MCP$updated,TERM2GENE[,c("gs_name", "gene_symbol")],gene_List$updated)

```

### Show enriched terms

```{r DE}
msig_MCP@result[msig_MCP@result$p.adjust<0.05,, drop=F]
msig_Wrist@result[msig_Knee@result$p.adjust<0.05,, drop=F]

write.csv(msig_MCP@result[msig_MCP@result$p.adjust<0.05,, drop=F],file=paste0(path,"/output/MCP_MvW.csv"))
write.csv(msig_Wrist@result[msig_Knee@result$p.adjust<0.05,, drop=F],file=paste0(path,"/output/Wrist_MvW.csv"))
```





### Visualization of functional enrichment result

#### MCP

```{r DE}
# Visualize enriched GO terms as a directed acyclic graph
goplot(ego_MCP)

# Bar Plot
barplot(ego_MCP, showCategory=20) 

mutate(ego_MCP, qscore = -log(p.adjust, base=10)) %>% 
    barplot(x="qscore")+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

# Dot plot

dotplot(ego_MCP, showCategory=30) + ggtitle("dotplot for ORA")

# Heatmap-like functional classification
mygeneList <- setNames(geneList$coef_baselog2, gene_List)

p1 <- heatplot(ego, showCategory=2)
p2 <- heatplot(ego, foldChange=mygeneList, showCategory=2)
cowplot::plot_grid(p1, p2, ncol=1, labels=LETTERS[1:2])



```

#### Wrist

```{r DE}
# Visualize enriched GO terms as a directed acyclic graph
goplot(ego_Wrist)

barplot(ego_Wrist, showCategory=3) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

# Bar Plot
barplot(ego_Wrist, showCategory=20) 

mutate(ego_Wrist, qscore = -log(p.adjust, base=10)) %>% 
    barplot(x="qscore")+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

# Dot plot

dotplot(ego_Wrist, showCategory=30) + ggtitle("dotplot for ORA")

# Heatmap-like functional classification
mygeneList <- setNames(geneList$coef_baselog2, gene_List)

p1 <- heatplot(ego, showCategory=2)
p2 <- heatplot(ego, foldChange=mygeneList, showCategory=2)
cowplot::plot_grid(p1, p2, ncol=1, labels=LETTERS[1:2])


```

-------------------------------------------------------------------------------------------------------------------------------------------------------------------------



  
  
## Save the dataset

```{r SaveData}

```
