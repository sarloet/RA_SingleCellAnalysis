---
title: "Enrichment Analysis"
subtitle: "09_EnrichmentAnalysis"
author: "SarahL."
date: "`r format(Sys.time(), '%b %e %Y %H:%M:%S')`"
output: 
  html_document:
    toc: true
    number_sections: true   
    toc_float: true
    code_folding: hide
    df_print: paged
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
knitr::opts_chunk$set(cache = FALSE, cache.lazy = FALSE)
knitr::opts_chunk$set(dpi = 300, fig.align = "center")
knitr::opts_chunk$set(out.width = "100%", out.height = "100%")
```


# Enrichment Analysis

## Setup

### Standard packages

```{r LoadPackages, warning=FALSE}
library(here)
source(here("code", "standard_libraries.R"))
```

### Additional Packages


```{r LoadPackages, warning=FALSE}
#Load Packages

suppressPackageStartupMessages({
library(clusterProfiler)
library(enrichplot)
})

```

### Set Parameter

```{r Setup}
set.seed(123)
bpp <- BiocParallel::MulticoreParam(parallel::detectCores()-1, RNGseed=100)
path <- here::here()
```


### Load  Hallmark gene set collection

```{r LoadDataset}

#gmt <- msigdbr::msigdbr(species = "human", category = "H")

#check if human==Homosapienz
gene_set_C5 <- msigdbr(species = "Homo sapiens", category = "C5")
gene_set_C2 <- msigdbr(species = "Homo sapiens", category = "C2")
gene_set_H <- msigdbr(species = "Homo sapiens", category = "H")

TERM2GENE <- rbind(gene_set_C5, gene_set_C2, gene_set_H) %>% 
  dplyr::select(gs_name, human_entrez_gene, gs_cat, human_gene_symbol,gs_id) %>% 
  distinct() %>% 
  dplyr::rename(entrez_gene = human_entrez_gene)

full_msigdbr <- msigdbr(species = "Homo sapiens")

TERM2GENE_full_msigdbr <- full_msigdbr %>% 
  dplyr::select(gs_name, human_entrez_gene, gs_cat, human_gene_symbol,gs_id) %>% 
  distinct() %>% 
  dplyr::rename(entrez_gene = human_entrez_gene)

```

### Load Data

```{r LoadDataset}
## RA DATASET
geneList_KneeVsMCP <-read.csv(paste0(path,'/output/MAST_KneeVsMCP.csv'))
#geneList_KneeVsWrist <-read.csv(paste0(path,'/output/MAST_KneeVsWrist.csv'))
#geneList_MCPVsWrist <-read.csv(paste0(path,'/output/MAST_MCPVsWrist.csv'))
```


## Set functions

```{r LoadDataset}
# Run enrichGO
run_enrichGO <- function(gene_list, background) {
  enrichGO_res <- enrichGO(
    gene = gene_list,
    universe =background,
    OrgDb = org.Hs.eg.db,
    keyType = 'SYMBOL',
    ont = "CC",
    pAdjustMethod = "BH",
    pvalueCutoff = 0.05,
    qvalueCutoff = 0.05,
    readable. = TRUE)
  return(enrichGO_res) 
}

# Run enrichr
run_enrichr <- function(gene_list, gene_sets, background) {
  
  enrichr_res <- clusterProfiler::enricher(
    gene_list,
    TERM2GENE = gene_sets,
    universe = background,
    pvalueCutoff = 1,
    qvalueCutoff = 1,
    pAdjustMethod = "BH",
    minGSSize = 50, 
    maxGSSize = 1000)
 
  return(enrichr_res) 
}
```


## Enrichment Analysis Knee Vs MCP

### Explore DEG Dataset

```{r LoadDataset}
##Print table
head(geneList_KneeVsMCP)

```

### Set up genelists
```{r LoadDataset}
# Get names for all genes for the background/universe & update the gene symbols 
gene_List<-update_gene_names(geneList_KneeVsMCP$primerid)
geneList_KneeVsMCP$updated<- gene_List$updated

# Get significatn genes for each condidtion
gene_List_Knee <- geneList_KneeVsMCP[geneList_KneeVsMCP$Pr..Chisq.<0.05 & geneList_KneeVsMCP$coef_baselog2< -0.1,, drop=F] #genes for cond1
gene_List_MCP <- geneList_KneeVsMCP[geneList_KneeVsMCP$Pr..Chisq.<0.05 & geneList_KneeVsMCP$coef_baselog2> 0.1,, drop=F] #genes for cond2

```

### GO collection

#### Run GO over-representation analysis

```{r DE}
ego_Knee <- enrichGO(gene          = gene_List_Knee$updated,
                universe      = gene_List$updated,
                OrgDb         = org.Hs.eg.db,
                keyType       = 'SYMBOL',
                ont           = "CC",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.05,
                qvalueCutoff  = 0.05,
                readable      = TRUE)

ego_MCP <- enrichGO(gene          = gene_List_MCP$updated,
                universe      = gene_List$updated,
                OrgDb         = org.Hs.eg.db,
                keyType       = 'SYMBOL',
                ont           = "CC",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.05,
                qvalueCutoff  = 0.05,
                readable      = TRUE)


ego_Knee <- run_enrichGO(gene_List_Knee$updated,gene_List$updated)
ego_MCP <- run_enrichGO(gene_List_MCP$updated,gene_List$updated)
```
### Show enriched terms

```{r DE}
ego_Knee@result[ego_Knee@result$p.adjust<0.05,, drop=F]

ego_MCP@result[ego_MCP@result$p.adjust<0.05,, drop=F]

```



### Hallmark collection

#### Run over-representation analysis on set of genes of the Hallmark collection


```{r DE}
tum_vs_norm_enrich <- clusterProfiler::enricher(gene = gene_List_Knee$updated,
                                                universe = gene_List$updated,
                                                pAdjustMethod = "BH",
                                                pvalueCutoff  = 0.05,
                                                qvalueCutoff  = 0.05,
                                                TERM2GENE = gmt[,c("gs_name", "gene_symbol")])

run_enrichr(gene_List_Knee$updated,gmt[,c("gs_name", "gene_symbol")],gene_List$updated)
run_enrichr(gene_List_Knee$updated,gmt[,c("gs_name", "gene_symbol")],gene_List$updated)

```



### Visualization of functional enrichment result

#### Visualize enriched GO terms as a directed acyclic graph

```{r DE}
goplot(ego_Knee)
goplot(ego_MCP)
```

#### Bar Plot

```{r DE}
barplot(ego, showCategory=20) 

mutate(ego, qscore = -log(p.adjust, base=10)) %>% 
    barplot(x="qscore")
```

#### Dot plot

```{r DE}
dotplot(ego, showCategory=30) + ggtitle("dotplot for ORA")
#dotplot(ego, showCategory=30) + ggtitle("dotplot for GSEA")
```

#### Heatmap-like functional classification

```{r DE}
mygeneList <- setNames(geneList$coef_baselog2, gene_List)

p1 <- heatplot(ego, showCategory=2)
p2 <- heatplot(ego, foldChange=mygeneList, showCategory=2)
cowplot::plot_grid(p1, p2, ncol=1, labels=LETTERS[1:2])

```

#### running score and preranked list of GSEA result

```{r DE}
gseaplot(ego, geneSetID = 2, title = ego$Description[1])

```







## Save the dataset

```{r SaveData}

```
