---
title: "Enrichment Analysis"
subtitle: "09_EnrichmentAnalysis"
author: "SarahL."
date: "`r format(Sys.time(), '%b %e %Y %H:%M:%S')`"
output: 
  html_document:
    toc: true
    number_sections: true   
    toc_float: true
    code_folding: hide
    df_print: paged
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
knitr::opts_chunk$set(cache = FALSE, cache.lazy = FALSE)
knitr::opts_chunk$set(dpi = 300, fig.align = "center")
knitr::opts_chunk$set(out.width = "100%", out.height = "100%")
```


# Differential Expression Analysis

## Setup

### Standard packages

```{r LoadPackages, warning=FALSE}
library(here)
source(here("code", "standard_libraries.R"))
```

### Additional Packages


```{r LoadPackages, warning=FALSE}
#Load Packages

suppressPackageStartupMessages({
library(clusterProfiler)
library(enrichplot)
})

```

### Set Parameter

```{r Setup}
set.seed(100)
bpp <- BiocParallel::MulticoreParam(parallel::detectCores()-1, RNGseed=100)
path <- here::here()
```


### Load Data

```{r LoadDataset}
## RA DATASET
geneList <-read.csv(paste0(path,'/output/MAST_KneeVsMCP.csv'))

```


### Explore Dataset


```{r LoadDataset}
##Print table
head(geneList)


```


## Enrichment Analysis

With clusterProfiler

```{r LoadDataset}

gene_List<-update_gene_names(geneList$primerid)
gene_List<- gene_List$updated

gene_List_MCP <- geneList[geneList$Pr..Chisq.<0.05 & geneList$coef_baselog2> 0.1,, drop=F]
gene_List_Knee <- geneList[geneList$Pr..Chisq.<0.05 & geneList$coef_baselog2< -0.1,, drop=F]
#gene <- siggene$primerid[abs(names(siggene$primerid)) > 2]

```

### GO classification

#### Run GO over-representation analysis

```{r DE}
ego_Knee <- enrichGO(gene          = gene_List_Knee$primerid,
                universe      = gene_List,
                OrgDb         = org.Hs.eg.db,
                keyType       = 'SYMBOL',
                ont           = "CC",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.05,
                qvalueCutoff  = 0.05,
                readable      = TRUE)
head(ego)

```

```{r DE}
ego_MCP <- enrichGO(gene          = gene_List_MCP$primerid,
                universe      = gene_List,
                OrgDb         = org.Hs.eg.db,
                keyType       = 'SYMBOL',
                ont           = "CC",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.05,
                qvalueCutoff  = 0.05,
                readable      = TRUE)
head(ego)

```


#### Visualize enriched GO terms as a directed acyclic graph

```{r DE}
goplot(ego)

```


### KEGG classification

#### Run KEGG over-representation analysis

```{r DE}
kk <- enrichKEGG(gene         = siggene$primerid,
                 organism     = 'hsa',
                 pvalueCutoff = 0.05)
head(kk)
```

#### Visualize enriched GO terms as a directed acyclic graph

```{r DE}
library("pathview")
hsa04110 <- pathview(gene.data  = geneList$primerid,
                     pathway.id = "hsa04110", #ADD pathway
                     species    = "hsa",
                     limit      = list(gene=max(abs(geneList)), cpd=1))

```

### WikiPathways classification

#### Run WikiPathways over-representation analysis

```{r DE}
WP <- enrichWP(siggene$primerid, organism = "Homo sapiens") 
head(WP)
```


### WikiPathways classification

#### Run WikiPathways over-representation analysis

```{r DE}
y <- gsePathway(geneList, 
                pvalueCutoff = 0.5,
                pAdjustMethod = "BH", 
                verbose = FALSE)
head(y)
```

#### Visualize enriched GO terms as a directed acyclic graph

```{r DE}
viewPathway("E2F mediated regulation of DNA replication", 
            readable = TRUE, 
            foldChange = geneList)   = list(gene=max(abs(geneList)), cpd=1))

```


### WikiPathways classification

#### Run WikiPathways over-representation analysis

```{r DE}
y <- gsePathway(geneList, 
                pvalueCutoff = 0.2,
                pAdjustMethod = "BH", 
                verbose = FALSE)
head(y)
```

### Visualization of functional enrichment result

#### Bar Plot

```{r DE}
barplot(ego, showCategory=20) 

mutate(ego, qscore = -log(p.adjust, base=10)) %>% 
    barplot(x="qscore")
```

#### Dot plot

```{r DE}
dotplot(ego, showCategory=30) + ggtitle("dotplot for ORA")
#dotplot(ego, showCategory=30) + ggtitle("dotplot for GSEA")
```

#### Heatmap-like functional classification

```{r DE}
mygeneList <- setNames(geneList$coef_baselog2, gene_List)

p1 <- heatplot(ego, showCategory=2)
p2 <- heatplot(ego, foldChange=mygeneList, showCategory=2)
cowplot::plot_grid(p1, p2, ncol=1, labels=LETTERS[1:2])

```

#### running score and preranked list of GSEA result

```{r DE}
gseaplot(ego, geneSetID = 2, title = ego$Description[1])

```


## Save the dataset

```{r SaveData}

```
