---
title: "Subcluster Annotation"
subtitle: "07_SubClustering_Annotation"
author: "SarahL."
date: "`r format(Sys.time(), '%b %e %Y %H:%M:%S')`"
output: 
  html_document:
    toc: true
    number_sections: true   
    toc_float: true
    code_folding: hide
    df_print: paged
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
knitr::opts_chunk$set(cache = FALSE, cache.lazy = FALSE)
knitr::opts_chunk$set(dpi = 300, fig.align = "center")
knitr::opts_chunk$set(out.width = "100%", out.height = "100%")
```


# Subcluster Annotation

## Setup

### Standard packages

```{r LoadPackages, warning=FALSE}
library(here)
source(here("code", "standard_libraries.R"))
```

### Additional Packages


```{r LoadAddPackages, warning=FALSE}
#Load Packages

suppressPackageStartupMessages({
library(batchelor)
library(bluster)
library(presto)
library(dittoSeq)
library(gridExtra)
library(UCell)
library(xlsx)
library(patchwork)
})

```

### Set Parameter

```{r Setup}
set.seed(100)
bpp <- BiocParallel::MulticoreParam(parallel::detectCores()-1, RNGseed=100)
path <- here::here()

#Output path
output_dir <- here("output","Subcluster_Annotation_output")
if(!dir.exists(output_dir)) dir.create(output_dir)

```


### Set Function

```{r VizGenExFunction}
#Function to visuaise gene Expression for vector of genes

VizGenEx <- function(sce.sc,markr){
  for(i in markr){
    
    cat(paste0("\n##### ", i, "\n"))
    gridExtra::grid.arrange(
      arrangeGrob(plotReducedDim(sce.sc, dimred = "MNN_UMAP_SC_reduced", colour_by = i, text_by = "subcluster"), 
                  plotReducedDim(sce.sc, dimred = "MNN_UMAP_SC_reduced", colour_by = i, order_by=i ) 
                    +scale_colour_gradient(name = i,low = "lightgrey", high = "red"), ncol = 2), 
                  plotExpression(sce.sc, features = i, x = "subcluster"),nrow = 2)
    cat(' \n')
  
  }
}

```


```{r WilcoxaucFunction}

Run_Wilcoxauc <- function(sce,label,celltype,n = 50,auc.min = 0.5, pval.max = 0.05, Create.Table=TRUE){
  #Wilcoxon rank-sum test
  markers_wilcox <- wilcoxauc(sce, group_by=label, assay = 'logcounts')
  # Get the top markers for each Anno (save in excel file)
  # filter for nominally significant (p<0.05) and over-expressed (auc>0.5)
  topDEgenes <- top_markers(markers_wilcox, n = n, auc_min = auc.min, pval_max = pval.max)
  wb = createWorkbook()
  if(Create.Table==TRUE){
    for (i in unique(markers_wilcox$group)){
      #get genes for the Anno
      markers<-topDEgenes[,paste0(i), drop=TRUE]
      #Create table
      tmp<-markers_wilcox[markers_wilcox$feature %in% markers & markers_wilcox$group == i,]
      #Save table in Exelsheet
      addDataFrame(tmp, sheet=createSheet(wb, paste0(i)), startColumn=1, row.names=TRUE,col.names = TRUE)
    }
    saveWorkbook(wb,paste0( output_dir , "/","SC_",paste0(celltype),"_Wilcoxon.xlsx")) 
  }
  return(topDEgenes)
}

```


----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

## Fibroblast

### Load Data

```{r LoadDatasetFB}
## RA DATASET
sce.sc <- readRDS(file = paste0(path,'/output/07_sce_SC_Fibroblast.rds'))

```

### Explore Dataset

```{r ShowDimFB}
#Dimensions of count matrix
dim(sce.sc)
```

### Plot Annotation {.tabset}

#### Plot UMAP of Subclusters 

```{r UMAPSubclusterFB}
#cluster
plotReducedDim(sce.sc, "MNN_UMAP_reduced",colour_by = "subcluster", text_by="subcluster") +labs(title="SubCluster",subtitle="Colored by clustering")
```

#### Plot Recalculated UMAP of Subclusters 

```{r UMAPSubclusterRecalcFB}
#cluster
plotReducedDim(sce.sc, "MNN_UMAP_SC_reduced",colour_by = "subcluster", text_by="subcluster") +labs(title="SubCluster",subtitle="Colored by clustering")
```


### Annotate Subcluster

#### Identify Marker Genes Wilcoxon rank-sum test


```{r IdentifyMarkerFB}
DE_genes <- Run_Wilcoxauc(sce.sc,'subcluster','Fibroblast',n = 50,auc.min = 0.5, pval.max = 0.05, Create.Table=TRUE)
DE_genes
```


```{r DotplotFB}
dittoDotPlot(sce.sc, vars = unique(as.vector(as.matrix(DE_genes[1:2, -1]))) , group.by = "subcluster",min.color="lightgrey", max.color="blue",min.percent=0.2,max.percent=1,scale = TRUE )

```


#### Test Known Fibroblast marker

```{r MarkerGenesFB}

Fibroblast_signatures <- list(
    Lining = c("PRG4","CRTAC1", "CLU","CLIC5"),
    SMC = c("ACTA2","MYL9", "DES", "MYH11"),
    FB_POSTN = c("POSTN","COL1A1", "FNDC1"),
    FB_CXCL12 = c("CXCL12","CCL2","SFRP1"),
    FB_CHI3L2 = c("CHI3L2","SAA1", "FN1"),
    FB_MFAP5 = c("MFAP5","IGFBP6","TNXB")
)
```



### Run UCell on sce object

#### Test signatures
```{r UCellFB}
sce.ucell <- ScoreSignatures_UCell(sce.sc, features=Fibroblast_signatures, assay = 'counts', name=NULL, BPPARAM=bpp)
altExp(sce.ucell, 'UCell')
```

```{r UCellUMAPFB,fig.height=5, fig.width=15}
pll <- lapply(names(Fibroblast_signatures), function(x) {
  plotReducedDim(sce.ucell, dimred="MNN_UMAP_SC_reduced", colour_by=paste(x),by_exprs_values = "UCell",point_alpha=0.8,point_size=0.5) +
  labs( x='UMAP 1', y='UMAP 2' )+
  scale_color_viridis(option="magma")
})
wrap_plots(pll)
```

```{r UCellExpressionFB,fig.height=10, fig.width=15}
pll <- lapply(names(Fibroblast_signatures), function(x) {
  plotExpression(sce.ucell, features = x, x = "subcluster",exprs_values = "UCell")
})
wrap_plots(pll,ncol=2)
```


### Test Fibroblast marker {.tabset}

#### Lining vs Sublining {.tabset}

```{r GexpFB1, results='asis'}
#Lining vs Sublining Fibroblst
VizGenEx(sce.sc,c("PRG4","THY1"))  

```

#### Lining {.tabset}

```{r GexpFB2, results='asis'}
#Lining Fibroblst
VizGenEx(sce.sc,Fibroblast_signatures$Lining)  

```

#### SMC {.tabset}

```{r GexpFB3, results='asis'}
#SMC
VizGenEx(sce.sc,Fibroblast_signatures$SMC)  

```

#### FB POSTN+ {.tabset}

```{r GexpFB4, results='asis'}
#Lining Fibroblst
VizGenEx(sce.sc,Fibroblast_signatures$FB_POSTN)   

```

#### FB CXCL12+ {.tabset}

```{r GexpFB5, results='asis'}
#Lining Fibroblst
VizGenEx(sce.sc,Fibroblast_signatures$FB_CXCL12)  

```

#### FB CHI3L2+ {.tabset}

```{r GexpFB6, results='asis'}
#Lining Fibroblst
VizGenEx(sce.sc,Fibroblast_signatures$FB_CHI3L2)  

```

#### FB MFAP5+ {.tabset}

```{r GexpFB7, results='asis'}
VizGenEx(sce.sc,Fibroblast_signatures$FB_MFAP5)  

```


### Label Assignement

```{r AssignementL2FB}
# Annotation
sce.sc$Annotation_L2 <- as.integer(sce.sc$subcluster)
unique(sce.sc$Annotation_L2)

#sce.sc$Annotation_L2[sce.sc$subcluster %in% c(6)] <- "SMC"
sce.sc$Annotation_L2[sce.sc$subcluster %in% c(1,2)] <- "POSTN+ FIB"
sce.sc$Annotation_L2[sce.sc$subcluster %in% c(5)] <- "CHI3L2+ FIB"
sce.sc$Annotation_L2[sce.sc$subcluster %in% c(4)] <- "PRG4+ FIB"
sce.sc$Annotation_L2[sce.sc$subcluster %in% c(3,7)] <- "CXCL12+ FIB"
sce.sc$Annotation_L2[sce.sc$subcluster %in% c(6)] <- "MFAP5+ FIB"

unique(sce.sc$Annotation_L2)
```

#### UMAP Assigned Celltypes 

```{r UMAPAssignedFB1}
plotReducedDim(sce.sc, "MNN_UMAP_SC_reduced",colour_by = "Annotation_L2",text_by="Annotation_L2") +
          labs(title="Recalculated UMAP for Subcluster ",subtitle="Colored by Celltype")
```

```{r UMAPAssignedFB2}
plotReducedDim(sce.sc, "MNN_UMAP_SC_reduced",colour_by = "Annotation_L2") +
          labs(title="Recalculated UMAP for Subcluster ",subtitle="Colored by Celltype")
```


### Save the Annotated dataset

```{r SaveDataFB}
saveRDS(sce.sc, file =paste0(path,'/output/07_sce_SC_Fibroblast_Anno.rds'))
```


### Identify Marker of labels with Genes Wilcoxon rank-sum test

```{r IdentifyMarkerFinalFB}
DE_genes <- Run_Wilcoxauc(sce.sc,'subcluster','Fibroblast_Anno',n = 50,auc.min = 0.5, pval.max = 0.05, Create.Table=TRUE)
DE_genes
```



--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

## Macrophage

### Load Data

```{r LoadDatasetMP}
## RA DATASET
sce.sc <- readRDS(file = paste0(path,'/output/07_sce_SC_Macrophage.rds'))

```

### Explore Dataset

```{r ShowDimMP}
#Dimensions of count matrix
dim(sce.sc)
```



### Plot Annotation {.tabset}

#### Plot UMAP of Subclusters 

```{r UMAPSubclusterMP}
#cluster
plotReducedDim(sce.sc, paste0("MNN_UMAP_reduced"),colour_by = "subcluster", text_by="subcluster") +labs(title=paste0("SubCluster"),subtitle="Colored by clustering")
```


#### Plot Recalculated UMAP of Subclusters 

```{r UMAPSubclusterRecalcMP}
#cluster
plotReducedDim(sce.sc, "MNN_UMAP_SC_reduced",colour_by = "subcluster", text_by="subcluster") +labs(title=paste0("SubCluster"),subtitle="Colored by clustering")
```


### Annotate Subcluster

#### Identify Marker Genes Wilcoxon rank-sum test

```{r IdentifyMarkerMP}
DE_genes <- Run_Wilcoxauc(sce.sc,'subcluster','Macrophage',n = 50,auc.min = 0.5, pval.max = 0.05, Create.Table=TRUE)
DE_genes
```


```{r DotplotMP}
dittoDotPlot(sce.sc, vars = unique(as.vector(as.matrix(DE_genes[1:2, -1]))) , group.by = "subcluster",min.color="lightgrey", max.color="blue",min.percent=0.2,max.percent=1,scale = TRUE )

```


#### Test Known Fibroblast marker
```{r MarkerGenesMP}

Macrophage_signatures <- list(
    MP_TREM2 = c("MERTK","TREM2"),#Tissue resident
    MP_FOLR2 = c("MERTK","FOLR2","LYVE1","ID2","ICAM1"),#Tissue resident
    MP_CD48 = c("CD48","SPP1","ISG15","CLEC10A"),#Tissue infiltrating
    MP_S100A12 = c("S100A12","CD48","MRC1","FCGR3A")#Monocyte (Downregulated MRC1, FCGR3A)
)
```


### Run UCell on sce object

```{r UCellMP}
sce.ucell <- ScoreSignatures_UCell(sce.sc, features=Macrophage_signatures, assay = 'counts', name=NULL, BPPARAM=bpp)
altExp(sce.ucell, 'UCell')

#sce.ucell <- SmoothKNN(sce.ucell, signature.names = names(Macrophage_signatures), reduction="MNN_SC_reduced")
```

```{r UCellUMAPMP,fig.height=10, fig.width=15}
pll <- lapply(names(Macrophage_signatures), function(x) {
  plotReducedDim(sce.ucell, dimred="MNN_UMAP_SC_reduced", colour_by=paste(x) ,by_exprs_values = "UCell",point_alpha=0.8,point_size=0.5) +
  labs( x='UMAP 1', y='UMAP 2' )+
  scale_color_viridis(option="magma")
})
wrap_plots(pll)
```

```{r UCellExpressionMP,fig.height=10, fig.width=15}
pll <- lapply(names(Macrophage_signatures), function(x) {
  plotExpression(sce.ucell, features = x, x = "subcluster",exprs_values = "UCell")
})
wrap_plots(pll,ncol=2)
```







### Test Macrophage marker {.tabset}

#### TREM2+ MP {.tabset}

```{r GexpMP1, results='asis'}
#Macrophage
VizGenEx(sce.sc,Macrophage_signatures$TREM2)  
```
#### FOLR2+ MP {.tabset}

```{r GexpMP2, results='asis'}
VizGenEx(sce.sc,Macrophage_signatures$FOLR2)  
```
#### CD48+ MP {.tabset}

```{r GexpMP3, results='asis'}
VizGenEx(sce.sc,Macrophage_signatures$CD48)  
```
#### S100A12+ MP {.tabset}

```{r GexpMP4, results='asis'}
#monocyte
VizGenEx(sce.sc,Macrophage_signatures$S100A12)  

```

### Label Assignement

```{r FibroblastsAssignementL2MP}
# Annotation
sce.sc$Annotation_L2 <- as.integer(sce.sc$subcluster)
unique(sce.sc$Annotation_L2)

#sce.sc$Annotation_L2[sce.sc$subcluster %in% c(6)] <- "SMC"
sce.sc$Annotation_L2[sce.sc$subcluster %in% c(1)] <- "TREM2+ MP"
sce.sc$Annotation_L2[sce.sc$subcluster %in% c(2)] <- "FOLR2+ MP"
sce.sc$Annotation_L2[sce.sc$subcluster %in% c(3)] <- "CD48+ MP"
sce.sc$Annotation_L2[sce.sc$subcluster %in% c(4)] <- "S100A12+ MP"

unique(sce.sc$Annotation_L2)
```

#### UMAP Assigned Celltypes 

```{r UMAPAssignedMP1}
plotReducedDim(sce.sc, "MNN_UMAP_SC_reduced",colour_by = "Annotation_L2",text_by="Annotation_L2") +
          labs(title="Recalculated UMAP for Subcluster ",subtitle="Colored by Celltype")
```

```{r UMAPAssignedMP2}
plotReducedDim(sce.sc, "MNN_UMAP_SC_reduced",colour_by = "Annotation_L2") +
          labs(title="Recalculated UMAP for Subcluster",subtitle="Colored by Celltype")
```


### Save the Annotated dataset

```{r SaveDataMP}
saveRDS(sce.sc, file =paste0(path,'/output/07_sce_SC_Macrophage_Anno.rds'))
```


### Identify Marker of labels with Genes Wilcoxon rank-sum test

```{r IdentifyMarkerAnnoMP}
DE_genes <- Run_Wilcoxauc(sce.sc,'subcluster','Macrophage_Anno',n = 50,auc.min = 0.5, pval.max = 0.05, Create.Table=TRUE)
DE_genes
```



--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

## Tcells

### Load Data

```{r LoadDatasetTC}
## RA DATASET
sce.sc <- readRDS(file = paste0(path,'/output/07_sce_SC_Tcell.rds'))

```

### Explore Dataset

```{r ShowDimTC}
#Dimensions of count matrix
dim(sce.sc)
```


### Plot Annotation {.tabset}

#### Plot UMAP of Subclusters 

```{r UMAPSubclusterTC}
#cluster
plotReducedDim(sce.sc, paste0("MNN_UMAP_reduced"),colour_by = "subcluster", text_by="subcluster") +labs(title=paste0("SubCluster"),subtitle="Colored by clustering")
```


#### Plot Recalculated UMAP of Subclusters 

```{r UMAPSubclusterRecalcTC}
#cluster
plotReducedDim(sce.sc, "MNN_UMAP_SC_reduced",colour_by = "subcluster", text_by="subcluster") +labs(title=paste0("SubCluster"),subtitle="Colored by clustering")
```

### Annotate Subcluster

#### Identify Marker Genes Wilcoxon rank-sum test


```{r IdentifyMarkerTC}
DE_genes <- Run_Wilcoxauc(sce.sc,'subcluster','Tcell',n = 50,auc.min = 0.5, pval.max = 0.05, Create.Table=TRUE)
DE_genes
```


```{r DotplotTC}
dittoDotPlot(sce.sc, vars = unique(as.vector(as.matrix(DE_genes[1:2, -1]))) , group.by = "subcluster",min.color="lightgrey", max.color="blue",min.percent=0.2,max.percent=1,scale = TRUE )

```


#### Test Known Fibroblast marker

```{r MarkerGenesTC}
Tcell_signatures <- list(
    CD4Tcell = c("CD4","TRAT1","CD40LG","LEF1","TNFRSF4"),
    CD8Tcell = c("CD8A","CD8B"),
    NKcell = c("NKG7","GNLY","NCAM1"),
    ProlifTcell = c("MKI67","PCNA","STMN1","HMGB2"),
    TReg = c("FOXP3","CCR8","PMCH","CCR4","RTKN2"),
    Memory = c("CCR7","IL7R","TCF7","SELL","SATB1","GPR183","LTB","LEF1"),
    Cytotoxic = c("GZMA","GZMK","NKG7")
)

```


### Run UCell on sce object

#### Test signatures signatures
```{r UCellTC}
sce.ucell <- ScoreSignatures_UCell(sce.sc, features=Tcell_signatures, assay = 'counts', name=NULL, BPPARAM=bpp)
altExp(sce.ucell, 'UCell')
```

```{r UCellUMAPTC,fig.height=5, fig.width=15}
pll <- lapply(names(Tcell_signatures), function(x) {
  plotReducedDim(sce.ucell, dimred="MNN_UMAP_SC_reduced", colour_by=paste(x),by_exprs_values = "UCell",point_alpha=0.8,point_size=0.5) +
  labs( x='UMAP 1', y='UMAP 2' )+
  scale_color_viridis(option="magma")
})
wrap_plots(pll)
```

```{r UCellExpressionTC,fig.height=10, fig.width=15}
pll <- lapply(names(Tcell_signatures), function(x) {
  plotExpression(sce.ucell, features = x, x = "subcluster",exprs_values = "UCell")
})
wrap_plots(pll,ncol=2)
```


### Test Tcells marker {.tabset}

#### CD4Tcell {.tabset}

```{r GexpTC1, results='asis'}
#CD4Tcell
VizGenEx(sce.sc,Tcell_signatures$CD4Tcell)
```

#### CD8Tcell {.tabset}

```{r GexpTC2, results='asis'}
#CD8Tcell
VizGenEx(sce.sc,Tcell_signatures$CD8Tcell)
```

#### NKcell {.tabset}

```{r GexpTC3, results='asis'}
#NKcell
VizGenEx(sce.sc,Tcell_signatures$NKcell) 
```

#### ProlifTcell {.tabset}

```{r GexpTC4, results='asis'}
#ProlifTcell
VizGenEx(sce.sc,Tcell_signatures$ProlifTcell)
```

#### TReg {.tabset}

```{r GexpTC5, results='asis'}
#ProlifTcell
VizGenEx(sce.sc,Tcell_signatures$TReg)
```

#### Memory {.tabset}

```{r GexpTC6, results='asis'}
#ProlifTcell
VizGenEx(sce.sc,Tcell_signatures$Memory)
```

#### Cytotoxic {.tabset}

```{r GexpTC7, results='asis'}
#ProlifTcell
VizGenEx(sce.sc,Tcell_signatures$Cytotoxic)
```



```{r AssignementL2TC}
#Manual Annotation

sce.sc$Annotation_L2 <- as.integer(sce.sc$subcluster)
unique(sce.sc$Annotation_L2)

sce.sc$Annotation_L2[sce.sc$subcluster %in% c(4)] <- "NKTcell"
sce.sc$Annotation_L2[sce.sc$subcluster %in% c(5)] <- "CytotoxCD4 TC"
sce.sc$Annotation_L2[sce.sc$subcluster %in% c(1)] <- "CytotoxCD8 TC"
sce.sc$Annotation_L2[sce.sc$subcluster %in% c(3)] <- "Naive TC"
sce.sc$Annotation_L2[sce.sc$subcluster %in% c(2)] <- "Memory TC"

unique(sce.sc$Annotation_L2)
```

#### UMAP Assigned Celltypes 

```{r UMAPAssignedTC1}
plotReducedDim(sce.sc, "MNN_UMAP_SC_reduced",colour_by = "Annotation_L2",text_by="Annotation_L2") +
          labs(title="Recalculated UMAP for Subcluster ",subtitle="Colored by Celltype")
```

```{r UMAPAssignedTC2}
plotReducedDim(sce.sc, "MNN_UMAP_SC_reduced",colour_by = "Annotation_L2") +
          labs(title="Recalculated UMAP for Subcluster",subtitle="Colored by Celltype")
```


### Save the Annotated dataset

```{r SaveDataTC}
saveRDS(sce.sc, file =paste0(path,'/output/07_sce_SC_Tcell_Anno.rds'))
```


### Identify Marker of labels with Genes Wilcoxon rank-sum test

```{r IdentifyMarkerFinalTC}
DE_genes <- Run_Wilcoxauc(sce.sc,'subcluster','Fibroblast_Anno',n = 50,auc.min = 0.5, pval.max = 0.05, Create.Table=TRUE)
DE_genes
```



--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

## Endothelial

### Load Data

```{r LoadDatasetEC}
## RA DATASET
sce.sc <- readRDS(file = paste0(path,'/output/07_sce_SC_Endothelial.rds'))

```

### Explore Dataset

```{r ShowDimEC}
#Dimensions of count matrix
dim(sce.sc)
```

### Plot Annotation {.tabset}

#### Plot UMAP of Subclusters 

```{r UMAPSubclusterEC}
#cluster
plotReducedDim(sce.sc, paste0("MNN_UMAP_reduced"),colour_by = "subcluster", text_by="subcluster") +labs(title=paste0("SubCluster"),subtitle="Colored by clustering")
```


#### Plot Recalculated UMAP of Subclusters 

```{r UMAPSubclusterRecalcEC}
#cluster
plotReducedDim(sce.sc, "MNN_UMAP_SC_reduced",colour_by = "subcluster", text_by="subcluster") +labs(title=paste0("SubCluster"),subtitle="Colored by clustering")
```

### Annotate Subcluster

#### Identify Marker Genes Wilcoxon rank-sum test


```{r IdentifyMarkerEC}
DE_genes <- Run_Wilcoxauc(sce.sc,'subcluster','Endothelial',n = 50,auc.min = 0.5, pval.max = 0.05, Create.Table=TRUE)
DE_genes
```


```{r DotplotEC}
dittoDotPlot(sce.sc, vars = unique(as.vector(as.matrix(DE_genes[1:2, -1]))) , group.by = "subcluster",min.color="lightgrey", max.color="blue",min.percent=0.2,max.percent=1,scale = TRUE )

```


#### Test Known marker

```{r MarkerGenesEC}

Endothelial_signatures <- list(
    Arterial = c("GJA5","NOTCH4", "EFNB2","HEY1"),
    Venous = c("NR2F2","ACKR1", "LIFR", "ICAM1","CLU"),
    Capillary = c("SPARC","ESAM"),
    Lymphatic = c("PROX1","PDPN","FLT4","LYVE1")
)
```

### Run UCell on sce object

#### Test signatures signatures
```{r UCellEC}
sce.ucell <- ScoreSignatures_UCell(sce.sc, features=Endothelial_signatures, assay = 'counts', name=NULL, BPPARAM=bpp)
altExp(sce.ucell, 'UCell')
```

```{r UCellUMAPEC,fig.height=5, fig.width=15}
pll <- lapply(names(Endothelial_signatures), function(x) {
  plotReducedDim(sce.ucell, dimred="MNN_UMAP_SC_reduced", colour_by=paste(x),by_exprs_values = "UCell",point_alpha=0.8,point_size=0.5) +
  labs( x='UMAP 1', y='UMAP 2' )+
  scale_color_viridis(option="magma")
})
wrap_plots(pll)
```

```{r UCellExpressionEC,fig.height=10, fig.width=15}
pll <- lapply(names(Endothelial_signatures), function(x) {
  plotExpression(sce.ucell, features = x, x = "subcluster",exprs_values = "UCell")
})
wrap_plots(pll,ncol=2)
```


### Test Tcells marker {.tabset}

#### Arterial {.tabset}

```{r GexpEC1, results='asis'}
#Capillary
VizGenEx(sce.sc,Endothelial_signatures$Arterial)
```

#### Venous {.tabset}

```{r GexpEC2, results='asis'}
#Venular
VizGenEx(sce.sc,Endothelial_signatures$Venous)

```

#### Capillary {.tabset}

```{r GexpEC3, results='asis'}
#Arteriolar
VizGenEx(sce.sc,Endothelial_signatures$Capillary)

```

#### Lymphatic {.tabset}

```{r GexpEC4, results='asis'}
#lymphatic
VizGenEx(sce.sc,Endothelial_signatures$Lymphatic)  

```

### Label Assignement

```{r AssignementL2EC}
#Manual Annotation

sce.sc$Annotation_L2 <- as.integer(sce.sc$subcluster)
unique(sce.sc$Annotation_L2)

sce.sc$Annotation_L2[sce.sc$subcluster %in% c(1)] <- "Arteriolar EC"
sce.sc$Annotation_L2[sce.sc$subcluster %in% c(2,4)] <- "Venular EC"
sce.sc$Annotation_L2[sce.sc$subcluster %in% c(3)] <- "Capillary EC"
#sce$Annotation_L2[sce$subcluster %in% c(1)] <- "Lymphatic"

unique(sce.sc$Annotation_L2)
```

#### UMAP Assigned Celltypes 

```{r UMAPAssignedEC1}
plotReducedDim(sce.sc, "MNN_UMAP_SC_reduced",colour_by = "Annotation_L2",text_by="Annotation_L2") +
          labs(title="Recalculated UMAP for Subcluster ",subtitle="Colored by Celltype")
```

```{r UMAPAssignedEC2}
plotReducedDim(sce.sc, "MNN_UMAP_SC_reduced",colour_by = "Annotation_L2") +
          labs(title="Recalculated UMAP for Subcluster",subtitle="Colored by Celltype")
```



### Save the Annotated dataset

```{r SaveDataEC}
saveRDS(sce.sc, file =paste0(path,'/output/07_sce_SC_Endothelial_Anno.rds'))
```


### Identify Marker of labels with Genes Wilcoxon rank-sum test

```{r IdentifyMarkerFinalEC}
DE_genes <- Run_Wilcoxauc(sce.sc,'subcluster','Endothelial_Anno',n = 50,auc.min = 0.5, pval.max = 0.05, Create.Table=TRUE)
DE_genes
```





--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

## Dendritic

### Load Data

```{r LoadDatasetDC}
## RA DATASET
sce.sc <- readRDS(file = paste0(path,'/output/07_sce_SC_Dendritic.rds'))

```

### Explore Dataset

```{r ShowDimDC}
#Dimensions of count matrix
dim(sce.sc)
```

### Plot Annotation {.tabset}

#### Plot UMAP of Subclusters 

```{r UMAPSubclusterDC}
#cluster
plotReducedDim(sce.sc, paste0("MNN_UMAP_reduced"),colour_by = "subcluster", text_by="subcluster") +labs(title=paste0("SubCluster"),subtitle="Colored by clustering")
```


#### Plot Recalculated UMAP of Subclusters 

```{r UMAPSubclusterRecalcDC}
#cluster
plotReducedDim(sce.sc, "MNN_UMAP_SC_reduced",colour_by = "subcluster", text_by="subcluster") +labs(title=paste0("SubCluster"),subtitle="Colored by clustering")
```


### Annotate Subcluster

#### Identify Marker Genes Wilcoxon rank-sum test


```{r IdentifyMarkerDC}
DE_genes <- Run_Wilcoxauc(sce.sc,'subcluster','Fibroblast',n = 50,auc.min = 0.5, pval.max = 0.05, Create.Table=TRUE)
DE_genes
```


```{r DotplotDC}
dittoDotPlot(sce.sc, vars = unique(as.vector(as.matrix(DE_genes[1:2, -1]))) , group.by = "subcluster",min.color="lightgrey", max.color="blue",min.percent=0.2,max.percent=1,scale = TRUE )

```


#### Test Known marker

```{r MarkerGenesDC}

Dendrittic_signatures <- list(
    pDC = c("CLEC4C","LILRA4", "LRRC26","SCT"),
    cDC1 = c("CLEC9A","THBD", "XCR1", "CLNK"),
    cDC2 = c("CLEC10A","ENHO","CD1C")
)
```


### Run UCell on sce object

#### Test signatures signatures
```{r UCellDC}
sce.ucell <- ScoreSignatures_UCell(sce.sc, features=Dendrittic_signatures, assay = 'counts', name=NULL, BPPARAM=bpp)
altExp(sce.ucell, 'UCell')
```

```{r UCellUMAPDC,fig.height=5, fig.width=15}
pll <- lapply(names(Dendrittic_signatures), function(x) {
  plotReducedDim(sce.ucell, dimred="MNN_UMAP_SC_reduced", colour_by=paste(x),by_exprs_values = "UCell",point_alpha=0.8,point_size=0.5) +
  labs( x='UMAP 1', y='UMAP 2' )+
  scale_color_viridis(option="magma")
})
wrap_plots(pll)
```

```{r UCellExpressionDC,fig.height=10, fig.width=15}
pll <- lapply(names(Dendrittic_signatures), function(x) {
  plotExpression(sce.ucell, features = x, x = "subcluster",exprs_values = "UCell")
})
wrap_plots(pll,ncol=2)
```

### Test Tcells marker {.tabset}

#### pDC {.tabset}

```{r GexpDC1, results='asis'}

VizGenEx(sce.sc,Dendrittic_signatures$pDC)
```

#### cDC1 {.tabset}

```{r GexpDC2, results='asis'}

VizGenEx(sce.sc,Dendrittic_signatures$cDC1)
```

#### cDC2 {.tabset}

```{r GexpDC3, results='asis'}
VizGenEx(sce.sc,Dendrittic_signatures$cDC2)
```


#### Label Assignement

```{r AssignementL2DC}
# Annotation
sce.sc$Annotation_L2 <- as.integer(sce.sc$subcluster)
unique(sce.sc$Annotation_L2)

sce.sc$Annotation_L2[sce.sc$subcluster %in% c(2)] <- "pDC"
sce.sc$Annotation_L2[sce.sc$subcluster %in% c(1)] <- "cDC"
sce.sc$Annotation_L2[sce.sc$subcluster %in% c(3)] <- "cDC2"

unique(sce.sc$Annotation_L2)
```

#### UMAP Assigned Celltypes 

```{r UMAPAssignedDC1}
plotReducedDim(sce.sc, "MNN_UMAP_SC_reduced",colour_by = "Annotation_L2",text_by="Annotation_L2") +
          labs(title="Recalculated UMAP for Subcluster ",subtitle="Colored by Celltype")
```

```{r UMAPAssignedDC2}
plotReducedDim(sce.sc, "MNN_UMAP_SC_reduced",colour_by = "Annotation_L2") +
          labs(title="Recalculated UMAP for Subcluster",subtitle="Colored by Celltype")
```

### Save the Annotated dataset

```{r SaveDataDC}
saveRDS(sce.sc, file =paste0(path,'/output/07_sce_SC_Dendritic_Anno.rds'))
```


### Identify Marker of labels with Genes Wilcoxon rank-sum test

```{r IdentifyMarkerFinalDC}
DE_genes <- Run_Wilcoxauc(sce.sc,'subcluster','Dendritic_Anno',n = 50,auc.min = 0.5, pval.max = 0.05, Create.Table=TRUE)
DE_genes
```











