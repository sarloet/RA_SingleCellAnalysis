---
title: "Subclustering"
subtitle: "06_SubClustering"
author: "SarahL."
date: "`r format(Sys.time(), '%b %e %Y %H:%M:%S')`"
output: 
  html_document:
    toc: true
    number_sections: true   
    toc_float: true
    code_folding: hide
    df_print: paged
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
knitr::opts_chunk$set(cache = FALSE, cache.lazy = FALSE)
knitr::opts_chunk$set(dpi = 300, fig.align = "center")
knitr::opts_chunk$set(out.width = "100%", out.height = "100%")
```


# Subclustering

## Setup

### Standard packages

```{r LoadPackages, warning=FALSE}
library(here)
source(here("code", "standard_libraries.R"))
```

### Additional Packages


```{r LoadPackages, warning=FALSE,eval=FALSE}
#Load Packages

suppressPackageStartupMessages({
library(batchelor)
library(bluster)
library(presto)
library(dittoSeq)
library(gridExtra)
})

```

```{r LoadPackages, warning=FALSE}
#Load Packages
library(here)
source(here("code", "standard_libraries.R"))

```

### Set Parameter

```{r Setup}
set.seed(123)
bpp <- BiocParallel::MulticoreParam(parallel::detectCores()-1, RNGseed=123)
path <- here::here()
```


### Load Data

```{r LoadDataset}
## RA DATASET
sce <- readRDS(file = paste0(path,'/output/05_sce_CelltypeAnnotation.rds'))

```


### Explore Dataset

```{r ShowDim}
#Dimensions of count matrix
dim(sce)
```

https://mperalc.gitlab.io/scRNA-seq_workshop_2021/additional-resources.html## UMAPs coloured by cluster or cell type

### Plot Annotation {.tabset}

### Annotation L1

```{r UMAPCluster}
#cluster
plotReducedDim(sce, "MNN_UMAP_reduced", colour_by="ManualAnno_L1", text_by="ManualAnno_L1") +labs(title="UMAP colored by clusters",subtitle = "UMAP of integrated dataset")

```

### Annotation L0

```{r UMAPAnnotation}
#cell type
plotReducedDim(sce, "MNN_UMAP_reduced", colour_by="ManualAnno_L0", text_by="ManualAnno_L0") +labs(title="UMAP colored by Cell type ",subtitle = "UMAP of integrated dataset")

```

## Subclustering Function

```{r SubclusteringFunction}
# Create Subclustering function

SUBCLUSTER <- function(sce.sc, SC_celltype, clust_param="leiden", k_param=50, merge_order){
set.seed(123)

#Subset sce object for ce scelltype
sce.subset <- sce.sc[,sce.sc$celltype == SC_celltype]
    
#Get top HVG for subcluster
dec <- modelGeneVar(sce.subset, block=sce.subset$Sample, density.weights=FALSE,BPPARAM=bpp)
top.hvgs <- getTopHVGs(dec, n=3000)
rowData(sce.subset)$is_hvg <- rownames(sce.subset) %in% top.hvgs
  
    
#Batch correction on subcluster
sce.Batchelor <-multiBatchNorm(sce.subset, 
                                batch=sce.subset$Sample, 
                                subset.row = rownames(sce.subset)[rowData(sce.subset)[["is_hvg"]]], 
                                normalize.all=TRUE, BPPARAM = bpp)
    
bpstart(bpp)
sce.Batchelor <- fastMNN(sce.Batchelor, 
                          batch=sce.Batchelor$Sample, 
                          prop.k=0.05,  
                          subset.row = rownames(sce.Batchelor)[rowData(sce.Batchelor)[["is_hvg"]]], 
                          correct.all=TRUE, merge.order = merge_order, BPPARAM = bpp)
bpstop(bpp)
    
assay(sce.subset, "reconstructed") <- assay(sce.Batchelor, "reconstructed")
reducedDim(sce.subset, 'MNN_SC') <- reducedDim(sce.Batchelor, 'corrected')
reducedDim(sce.subset, 'MNN_SC_reduced') <- reducedDim(sce.Batchelor, 'corrected')[,seq_len(20)]
    
#Get UMAP on subset
sce.subset <- runUMAP(sce.subset,name = "MNN_UMAP_SC_reduced", dimred = 'MNN_SC_reduced', subset_row=rowData(sce.subset)$is_hvg)
    
#Recluster the cells 
set.seed(123)
cluster <- clusterCells(sce.subset, use.dimred = "MNN_SC_reduced", BLUSPARAM = SNNGraphParam(k= k_param,cluster.fun= clust_param, BPPARAM =bpp))
    
#Add Subcluster label to sce
colData(sce.subset)$subcluster <- cluster
sce.subset$subcluster <- factor(sce.subset$subcluster)
    
#attr(sce.subset, "MNN_UMAP_SC_reduced")<-attr(reducedDim(sce.subset, "MNN_UMAP_SC_reduced"), "scaled:center") 
  
return(sce.subset)
}
```


```{r MergeOrder}
#Set manual merge_order
merge_order <- list( 
          list(list("SynBio_050", "SynBio_074", "SynBio_077b","SynBio_083","SynBio_084","SynBio_098b"),#Wrist
          list("SynBio_028","SynBio_049", "SynBio_076","SynBio_081", "SynBio_087", "SynBio_130")),#MCP
          list("SynBio_077a","SynBio_093", "SynBio_096","SynBio_098a", "SynBio_127")#Knee
          )

```




## Subcluster Fibroblast

### Run Subclustering

```{r RunSubcluster, warning=FALSE}

sce$celltype <- colData(sce)$ManualAnno_L1

# Run Subcluster Function
sce.Fibroblast<-SUBCLUSTER(sce, "Fibroblast", clust_param="leiden", k_param=50, merge_order)
  
```

### Plot UMAP of Subclusters  {.tabset}

```{r UMAPSubcluster , results='asis'}
cat(paste0("##### Colored by Clustering\n"))
print(plotReducedDim(sce.Fibroblast, "MNN_UMAP_reduced",colour_by = "subcluster", text_by="subcluster") +
          labs(title=paste0("UMAP of Subcluster"),subtitle="Colored by clustering"))
    
cat(paste0("##### Colored by Sample\n"))
print(plotReducedDim(sce.Fibroblast, "MNN_UMAP_reduced",colour_by = "Sample") +
          labs(title=paste0("UMAP of Subcluster"),subtitle="Colored by Sample"))

```


## Plot Recalculated UMAP of Fibroblast Subclusters  {.tabset}

```{r UMAPSubclusterRecalc , results='asis'}
cat(paste0("#### Colored by Clustering\n"))
print(plotReducedDim(sce.Fibroblast, "MNN_UMAP_SC_reduced",colour_by = "subcluster",text_by="subcluster") +labs(title=paste0("Recalculated UMAP for Subcluster"),subtitle="Colored by clustering"))

cat(paste0("#### Colored by Sample\n"))
print(plotReducedDim(sce.Fibroblast, "MNN_UMAP_SC_reduced",colour_by = "Sample") +
          labs(title=paste0("Recalculated UMAP for Subcluster"),subtitle="Colored by Sample"))

```


### Save the dataset

```{r SaveData}
saveRDS(sce.Fibroblast, file =paste0(path,'/output/06_sce_SC_Fibroblast.rds'))
```




## Subcluster T cell

```{r RunSubcluster, warning=FALSE}

sce$celltype <- colData(sce)$ManualAnno_L1

# Run Subcluster Function
sce.Tcell<-SUBCLUSTER(sce, "T cell", clust_param="leiden", k_param=50, merge_order)
  
```


### Plot UMAP of Subclusters  {.tabset}

```{r UMAPSubcluster , results='asis'}
cat(paste0("##### Colored by Clustering\n"))
print(plotReducedDim(sce.Tcell, "MNN_UMAP_reduced",colour_by = "subcluster", text_by="subcluster") +
          labs(title=paste0("UMAP of Subcluster"),subtitle="Colored by clustering"))
    
cat(paste0("##### Colored by Sample\n"))
print(plotReducedDim(sce.Tcell, "MNN_UMAP_reduced",colour_by = "Sample") +
          labs(title=paste0("UMAP of Subcluster"),subtitle="Colored by Sample"))

```


## Plot Recalculated UMAP of Fibroblast Subclusters  {.tabset}

```{r UMAPSubclusterRecalc , results='asis'}
cat(paste0("#### Colored by Clustering\n"))
print(plotReducedDim(sce.Tcell, "MNN_UMAP_SC_reduced",colour_by = "subcluster",text_by="subcluster") +labs(title=paste0("Recalculated UMAP for Subcluster ", name),subtitle="Colored by clustering"))

cat(paste0("#### Colored by Sample\n"))
print(plotReducedDim(sce.Tcell, "MNN_UMAP_SC_reduced",colour_by = "Sample") +
          labs(title=paste0("Recalculated UMAP for Subcluster ", name),subtitle="Colored by Sample"))

```

### Save the dataset

```{r SaveData}
saveRDS(sce.Tcell, file =paste0(path,'/output/06_sce_SC_Tcell.rds'))
```




## Subcluster Myeloid

```{r RunSubcluster, warning=FALSE}

sce$celltype <- colData(sce)$ManualAnno_L1

# Run Subcluster Function
sce.Myeloid<-SUBCLUSTER(sce, "Myeloid", clust_param="leiden", k_param=50, merge_order)
  
```



### Plot UMAP of Subclusters  {.tabset}

```{r UMAPSubcluster , results='asis'}
cat(paste0("##### Colored by Clustering\n"))
print(plotReducedDim(sce.Myeloid, "MNN_UMAP_reduced",colour_by = "subcluster", text_by="subcluster") +
          labs(title=paste0("UMAP of Subcluster"),subtitle="Colored by clustering"))
    
cat(paste0("##### Colored by Sample\n"))
print(plotReducedDim(sce.Myeloid, "MNN_UMAP_reduced",colour_by = "Sample") +
          labs(title=paste0("UMAP of Subcluster"),subtitle="Colored by Sample"))

```


## Plot Recalculated UMAP of Myeloid Subclusters  {.tabset}

```{r UMAPSubclusterRecalc , results='asis'}
cat(paste0("#### Colored by Clustering\n"))
print(plotReducedDim(sce.Myeloid, "MNN_UMAP_SC_reduced",colour_by = "subcluster",text_by="subcluster") +labs(title=paste0("Recalculated UMAP for Subcluster "),subtitle="Colored by clustering"))

cat(paste0("#### Colored by Sample\n"))
print(plotReducedDim(sce.Myeloid, "MNN_UMAP_SC_reduced",colour_by = "Sample") +
          labs(title=paste0("Recalculated UMAP for Subcluster "),subtitle="Colored by Sample"))

```


### Save the dataset

```{r SaveData}
saveRDS(sce.Myeloid, file =paste0(path,'/output/06_sce_SC_Myeloid.rds'))
```




## Subcluster Endothelial

```{r RunSubcluster, warning=FALSE}

sce$celltype <- colData(sce)$ManualAnno_L1

# Run Subcluster Function
sce.Endothelial<-SUBCLUSTER(sce, "Edothelial cell", clust_param="leiden", k_param=50, merge_order)
  
```

### Plot UMAP of Subclusters  {.tabset}

```{r UMAPSubcluster , results='asis'}
cat(paste0("##### Colored by Clustering\n"))
print(plotReducedDim(sce.Endothelial, "MNN_UMAP_reduced",colour_by = "subcluster", text_by="subcluster") +
          labs(title=paste0("SubCluster ", name),subtitle="Colored by clustering"))
    
cat(paste0("##### Colored by Sample\n"))
print(plotReducedDim(sce.Endothelial, "MNN_UMAP_reduced",colour_by = "Sample") +
          labs(title=paste0("SubCluster ", name),subtitle="Colored by Sample"))

```


## Plot Recalculated UMAP of Fibroblast Subclusters  {.tabset}

```{r UMAPSubclusterRecalc , results='asis'}
cat(paste0("#### Colored by Clustering\n"))
print(plotReducedDim(sce.Endothelial, "MNN_UMAP_SC_reduced",colour_by = "subcluster",text_by="subcluster") +labs(title=paste0("Recalculated UMAP for Subcluster ", name),subtitle="Colored by clustering"))

cat(paste0("#### Colored by Sample\n"))
print(plotReducedDim(sce.Endothelial, "MNN_UMAP_SC_reduced",colour_by = "Sample") +
          labs(title=paste0("Recalculated UMAP for Subcluster ", name),subtitle="Colored by Sample"))

```


### Save the dataset

```{r SaveData}
saveRDS(sce.Endothelial, file =paste0(path,'/output/06_sce_SC_Endothelial.rds'))
```




